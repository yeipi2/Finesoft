@* 
   Componente: RedirectIfNotAuthorized.razor
   Ubicación: fs-front/Components/Auth/
   
   USO:
   <RedirectIfNotAuthorized Roles="Admin,Administracion" RedirectTo="/acceso-denegado" />
*@

@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider

@code {
    /// <summary>
    /// Roles permitidos (separados por coma)
    /// Ejemplo: "Admin,Administracion"
    /// </summary>
    [Parameter] public string Roles { get; set; } = string.Empty;

    /// <summary>
    /// Ruta a la que redirigir si NO tiene permiso
    /// </summary>
    [Parameter] public string RedirectTo { get; set; } = "/acceso-denegado";

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        // Si no está autenticado, redirigir a login
        if (!user.Identity?.IsAuthenticated == true)
        {
            Navigation.NavigateTo("/iniciar-sesion", forceLoad: true);
            return;
        }

        // Si Roles está vacío, solo verificar autenticación
        if (string.IsNullOrWhiteSpace(Roles))
        {
            return; // Usuario autenticado, sin restricción de roles
        }

        // Verificar si el usuario tiene al menos uno de los roles permitidos
        var allowedRoles = Roles.Split(',', StringSplitOptions.RemoveEmptyEntries)
                                .Select(r => r.Trim())
                                .ToList();

        var hasRole = allowedRoles.Any(role => user.IsInRole(role));

        if (!hasRole)
        {
            // NO tiene permiso, redirigir
            Navigation.NavigateTo(RedirectTo, forceLoad: true);
        }
    }
}
