@* fs-front/Components/Employees/Form/WorkDataSection.razor *@
@using fs_front.DTO
@using fs_front.Components.Shared

<FormSection Title="Datos Laborales"
             IconClass="bi-briefcase"
             IsComplete="@IsComplete">

    <div class="row g-3">

        @* PUESTO *@
        <div class="col-md-6">
            <label class="form-label small fw-bold">
                Puesto <span class="text-danger">*</span>
            </label>

            @if (!_useCustomPosition)
            {
                <InputSelect class="form-select form-select-sm"
                             Value="@Employee.Position"
                             ValueChanged="@((string v) => OnPositionSelected(v))"
                             ValueExpression="@(() => Employee.Position)">
                    <option value="">-- Seleccionar Puesto --</option>
                    <optgroup label="Dirección">
                        <option value="CEO (Director General)">CEO (Director General)</option>
                    </optgroup>
                    <optgroup label="Desarrollo">
                        <option value="Líder de Desarrollo">Líder de Desarrollo</option>
                        <option value="Desarrollador">Desarrollador</option>
                    </optgroup>
                    <optgroup label="Administración">
                        <option value="Administración">Administración</option>
                    </optgroup>
                </InputSelect>
                <ValidationMessage For="@(() => Employee.Position)" />
                <button type="button" class="btn btn-link btn-sm p-0 mt-1 text-muted"
                        @onclick="EnableCustomPosition">
                    <i class="bi bi-pencil me-1"></i>Escribir manualmente
                </button>
            }
            else
            {
                <InputText class="form-control form-control-sm"
                           placeholder="Escribe el puesto"
                           Value="@Employee.Position"
                           ValueChanged="@(v => { Employee.Position = v; OnChanged?.Invoke(); })"
                           ValueExpression="@(() => Employee.Position)" />
                <ValidationMessage For="@(() => Employee.Position)" />
                <button type="button" class="btn btn-link btn-sm p-0 mt-1 text-muted"
                        @onclick="EnableDropdownPosition">
                    <i class="bi bi-list me-1"></i>Seleccionar de la lista
                </button>
            }
        </div>

        @* DEPARTAMENTO - solo lectura, se llena automático *@
        <div class="col-md-6">
            <label class="form-label small fw-bold">Departamento</label>
            <input class="form-control form-control-sm @(_useCustomPosition ? "" : "bg-light")"
                   value="@Employee.Department"
                   placeholder="@(_useCustomPosition ? "Escribe el departamento" : "Se asigna automáticamente")"
                   readonly="@(!_useCustomPosition)"
                   @oninput="@(e => { if (_useCustomPosition) { Employee.Department = e.Value?.ToString() ?? ""; OnChanged?.Invoke(); } })" />
            @if (!_useCustomPosition && !string.IsNullOrEmpty(Employee.Department))
            {
                <small class="text-success">
                    <i class="bi bi-check-circle me-1"></i>Asignado automáticamente
                </small>
            }
        </div>

        <div class="col-12">
            <div class="form-check form-switch">
                <InputCheckbox id="IsActive"
                               class="form-check-input"
                               @bind-Value="Employee.IsActive" />
                <label class="form-check-label small fw-bold" for="IsActive">
                    Empleado Activo
                </label>
            </div>
        </div>
    </div>

</FormSection>

@code {
    [Parameter] public EmployeeDto Employee { get; set; } = new();
    [Parameter] public bool IsComplete { get; set; }
    [Parameter] public Action? OnChanged { get; set; }

    private bool _useCustomPosition = false;

    // Mapa puesto → departamento
    private static readonly Dictionary<string, string> PositionDepartmentMap = new()
    {
        { "CEO (Director General)",  "Dirección"      },
        { "Líder de Desarrollo",     "Desarrollo"     },
        { "Desarrollador",           "Desarrollo"     },
        { "Administración",          "Administración" }
    };

    protected override void OnParametersSet()
    {
        // Si al cargar el puesto no está en la lista predefinida, activar modo texto
        if (!string.IsNullOrEmpty(Employee.Position) &&
            !PositionDepartmentMap.ContainsKey(Employee.Position))
        {
            _useCustomPosition = true;
        }
    }

    private void OnPositionSelected(string position)
    {
        Employee.Position = position;

        // Asignar departamento automáticamente
        if (PositionDepartmentMap.TryGetValue(position, out var dept))
            Employee.Department = dept;
        else
            Employee.Department = string.Empty;

        OnChanged?.Invoke();
    }

    private void EnableCustomPosition()
    {
        Employee.Position = string.Empty;
        Employee.Department = string.Empty;
        _useCustomPosition = true;
        OnChanged?.Invoke();
    }

    private void EnableDropdownPosition()
    {
        Employee.Position = string.Empty;
        Employee.Department = string.Empty;
        _useCustomPosition = false;
        OnChanged?.Invoke();
    }
}