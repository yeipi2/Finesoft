@using fs_front.DTO
@using Radzen

<div class="p-3">
    <h6 class="mb-3">Cambiar estado de la factura</h6>

    <div class="mb-2">
        <small class="text-muted">Estado actual</small>
        <div class="fw-bold">@CurrentStatus</div>
    </div>

    <div class="mb-3">
        <small class="text-muted">Nuevo estado</small>
        <RadzenDropDown @bind-Value="SelectedStatus"        Data="@Statuses"                Style="width: 100%;"
                        Placeholder="Selecciona un estado" />
    </div>

    @if (SelectedStatus == "Cancelada")
    {
        <div class="mb-3">
            <small class="text-muted">Motivo de cancelación</small>
            <RadzenTextArea @bind-Value="Reason"                            Style="width:100%;" Rows="3"
                            Placeholder="Ej. Cliente solicitó cancelación..." />
        </div>
    }

    <div class="d-flex justify-content-end gap-2">
        <RadzenButton Text="Cancelar" ButtonStyle="ButtonStyle.Light" Click="@Cancel" />
        <RadzenButton Text="Guardar" ButtonStyle="ButtonStyle.Primary" Click="@Save" Disabled="@IsSaveDisabled" />
    </div>
</div>

@code {
    [Parameter] public string CurrentStatus { get; set; } = "Pendiente";

    private List<string> Statuses { get; } = new() { "Pendiente", "Pagada", "Cancelada" };
    private string? SelectedStatus;
    private string? Reason;

    [Inject] DialogService DialogService { get; set; } = default!;

    private bool IsSaveDisabled =>
        string.IsNullOrWhiteSpace(SelectedStatus)
        || SelectedStatus == CurrentStatus
        || (SelectedStatus == "Cancelada" && string.IsNullOrWhiteSpace(Reason));

    void Cancel() => DialogService.Close(null);

    void Save()
    {
        var req = new ChangeInvoiceStatusRequest
        {
            Status = SelectedStatus!,
            Reason = SelectedStatus == "Cancelada" ? Reason?.Trim() : null
        };

        DialogService.Close(req);
    }
}