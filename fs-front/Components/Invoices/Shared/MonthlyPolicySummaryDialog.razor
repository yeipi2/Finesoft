@* fs-front/Components/Invoices/Shared/MonthlyPolicySummaryDialog.razor *@
@using fs_front.DTO
@using fs_front.Services
@using Radzen
@inject IInvoiceApiService InvoiceApiService
@inject DialogService DialogService


@if (_isLoading)
{
    <div class="mpd">
        <div class="mpd-center" style="min-height:320px">
            <div class="mpd-spin-lg"></div>
            <span style="font-size:.82rem">Cargando pólizas del mes...</span>
        </div>
    </div>
}
else if (_summary == null || !_summary.Any())
{
    <div class="mpd">
        <div class="mpd-center" style="min-height:280px">
            <i class="bi bi-check2-circle" style="font-size:2.4rem;color:#10b981;opacity:.7"></i>
            <strong style="font-size:.95rem">¡Todo al día!</strong>
            <span style="font-size:.8rem">No hay clientes con póliza mensual pendientes.</span>
        </div>
        <div class="mpd-footer" style="justify-content:flex-end">
            <button class="mpd-btn mpd-btn-sec" @onclick="Cancel">
                <i class="bi bi-x-lg"></i> Cerrar
            </button>
        </div>
    </div>
}
else
{
    <div class="mpd">

        @* ── Dashboard ── *@
        <div class="mpd-dash">
            <div class="mpd-stat s-period">
                <div class="mpd-stat-lbl">Período</div>
                <div class="mpd-stat-num">
                    @DateTime.Now.ToString("MMM yyyy", new System.Globalization.CultureInfo("es-MX")).ToUpper()
                </div>
                <div class="mpd-stat-sub">Pólizas mensuales</div>
            </div>
            <div class="mpd-stat s-pending">
                <div class="mpd-stat-lbl">Disponibles</div>
                <div class="mpd-stat-num">@_availableCount</div>
                <div class="mpd-stat-sub">por generar</div>
            </div>
            <div class="mpd-stat s-done">
                <div class="mpd-stat-lbl">Generadas</div>
                <div class="mpd-stat-num">@_alreadyCount</div>
                <div class="mpd-stat-sub">este mes</div>
            </div>
            <div class="mpd-stat s-crit">
                <div class="mpd-stat-lbl">Críticos</div>
                <div class="mpd-stat-num">@_criticalCount</div>
                <div class="mpd-stat-sub">exceden +10h</div>
            </div>
        </div>

        @* ── Alerta crítica ── *@
        @if (_criticalCount > 0)
        {
            <div class="mpd-alert-crit">
                <i class="bi bi-exclamation-triangle-fill flex-shrink-0" style="margin-top:1px"></i>
                <span>
                    <strong>@_criticalCount cliente(s)</strong> superaron más de 10h.
                    La factura se generará con el precio actual e incluirá nota de renegociación.
                </span>
            </div>
        }

        @* ── Toolbar ── *@
        <div class="mpd-toolbar">
            @if (_availableCount > 1)
            {
                <label class="mpd-sel-all">
                    <input type="checkbox"
                           checked="@_allSelected"
                           @onchange="ToggleAll"
                           @onclick:stopPropagation="true" />
                    @(_allSelected ? "Deseleccionar todos" : "Seleccionar todos")
                </label>
            }
            <span style="flex:1"></span>
            @if (_selectedIds.Count > 0)
            {
                <span class="mpd-count-pill">
                    <i class="bi bi-check2"></i>
                    @_selectedIds.Count / @_availableCount seleccionado@(_selectedIds.Count == 1 ? "" : "s")
                </span>
            }
            else if (_availableCount > 0)
            {
                <span style="font-size:.74rem;color:var(--mpd-muted-2)">Selecciona los clientes a facturar</span>
            }
        </div>

        @* ── Lista ── *@
        <div class="mpd-list">
            @foreach (var c in _summary)
            {
                var avail = !c.AlreadyHasInvoice;
                var sel = _selectedIds.Contains(c.ClientId);
                var pct = Math.Min(c.UsagePercent, 100);
                var barColor = c.HoursStatus switch
                {
                                "Critical" => "#ef4444",
                                "Exceeded" => "#f97316",
                                "Warning" => "#eab308",
                    _ => "#10b981"
                };

                var cardCls = "mpd-card"
                + (!avail ? " mpd-card-done" : "")
                + (avail && sel ? " mpd-card-sel" : "")
                + (avail && c.HasCancelledInvoice ? " mpd-card-cancelled" : "");

                <div class="@cardCls"
                     @onclick="() => { if (avail) ToggleClient(c.ClientId); }">

                    <div class="mpd-card-top">
                        @if (avail)
                        {
                            <input type="checkbox"
                                   style="width:15px;height:15px;accent-color:#2563eb;cursor:pointer;flex-shrink:0"
                                   checked="@sel"
                                   @onchange="() => ToggleClient(c.ClientId)"
                                   @onclick:stopPropagation="true" />
                        }
                        else
                        {
                            <i class="bi bi-check-circle-fill flex-shrink-0"
                               style="color:#10b981;font-size:.95rem"></i>
                        }

                        <span class="mpd-card-name">@c.CompanyName</span>

                        @if (c.HasCancelledInvoice && avail)
                        {
                            <span class="mpd-b b-can">
                                <i class="bi bi-arrow-counterclockwise"></i> Cancelada
                            </span>
                        }

                        @switch (c.HoursStatus)
                        {
                            case "Critical":
                                <span class="mpd-b b-crit">
                                    <i class="bi bi-exclamation-triangle-fill"></i> Crítico
                                </span>
                                break;
                            case "Exceeded":
                                <span class="mpd-b b-exc">
                                    <i class="bi bi-arrow-up-circle"></i> Excedido
                                </span>
                                break;
                            case "Warning":
                                <span class="mpd-b b-warn">
                                    <i class="bi bi-exclamation-circle"></i> Advertencia
                                </span>
                                break;
                            default:
                                @if (avail)
                                {
                                    <span class="mpd-b b-ok"><i class="bi bi-check"></i> Normal</span>
                                }
                                break;
                        }

                        @if (!avail)
                        {
                            <span class="mpd-b b-done">Ya generada</span>
                        }

                        <span class="mpd-card-rate">
                            @c.MonthlyRate.ToString("C0", new System.Globalization.CultureInfo("en-US"))/mes
                        </span>
                    </div>

                    @if (c.MonthlyHours > 0)
                    {
                        <div class="mpd-bar-row">
                            <div class="mpd-bar">
                                <div class="mpd-bar-fill"
                                     style="width:@pct.ToString("0")%; background:@barColor">
                                </div>
                            </div>
                            <span class="mpd-bar-label @(c.HoursUsed > c.MonthlyHours ? "over" : "")">
                                @($"{c.HoursUsed:0.0}")h / @c.MonthlyHours h
                                @if (c.ExcessHours > 0)
                                {
                                    <span>(+@($"{c.ExcessHours:0.0}")h)</span>
                                }
                            </span>
                        </div>

                        @if (c.HoursStatus == "Critical" && avail)
                        {
                            <div class="mpd-inline-alert ial-danger">
                                <i class="bi bi-exclamation-triangle-fill flex-shrink-0" style="margin-top:1px"></i>
                                Excedió <strong style="margin:0 2px">@($"{c.ExcessHours:0.0}")h</strong>
                                sobre las @c.MonthlyHours h incluidas. Se generará con nota de renegociación.
                            </div>
                        }
                        else if (c.HoursStatus == "Exceeded" && avail)
                        {
                            <div class="mpd-inline-alert ial-warning">
                                <i class="bi bi-exclamation-circle flex-shrink-0" style="margin-top:1px"></i>
                                Excedió <strong style="margin:0 2px">@($"{c.ExcessHours:0.0}")h</strong>
                                — dentro del margen aceptable de 10h.
                            </div>
                        }
                    }

                    @if (c.Tickets.Any())
                    {
                        <details class="mpd-tickets" @onclick:stopPropagation="true">
                            <summary>
                                <i class="bi bi-ticket-detailed-fill"></i>
                                @c.Tickets.Count ticket@(c.Tickets.Count == 1 ? "" : "s") del mes —
                                <span style="color:#3b82f6">@($"{c.Tickets.Sum(t => t.ActualHours):0.0}")h totales</span>
                                <i class="bi bi-chevron-down" style="margin-left:auto;font-size:.6rem;color:var(--mpd-muted-2)"></i>
                            </summary>
                            <div>
                                @foreach (var t in c.Tickets)
                                {
                                    <div class="mpd-t-item">
                                        <span class="mpd-t-id">#@t.TicketId</span>
                                        <span class="mpd-t-title">@t.Title</span>
                                        <span class="mpd-t-proj">@t.ProjectName</span>
                                        <span class="mpd-t-st">@t.Status</span>
                                        <span class="mpd-t-hrs">@($"{t.ActualHours:0.0}")h</span>
                                    </div>
                                }
                            </div>
                        </details>
                    }
                    else if (avail)
                    {
                        <div class="mpd-no-tickets">
                            <i class="bi bi-info-circle"></i>
                            Sin tickets registrados este mes
                        </div>
                    }

                </div>
            }
        </div>

        @* ── Footer ── *@
        <div class="mpd-footer">
            <div class="mpd-legend">
                <span class="mpd-b b-ok">Normal</span>
                <span class="mpd-b b-warn">Advert. &gt;80%</span>
                <span class="mpd-b b-exc">Excedido ≤10h</span>
                <span class="mpd-b b-crit">Crítico &gt;10h</span>
                <span class="mpd-b b-can">Cancelada</span>
            </div>
            <div class="mpd-btns">
                <button class="mpd-btn mpd-btn-sec"
                        @onclick="Cancel"
                        disabled="@_isGenerating">
                    <i class="bi bi-x-lg"></i> Cancelar
                </button>
                <button class="mpd-btn mpd-btn-pri"
                        @onclick="Generate"
                        disabled="@(_isGenerating || _selectedIds.Count == 0)">
                    @if (_isGenerating)
                    {
                        <span class="mpd-spin"></span>
                        <span>Generando...</span>
                    }
                    else
                    {
                        <i class="bi bi-lightning-fill"></i>
                        <span>Generar @_selectedIds.Count factura@(_selectedIds.Count == 1 ? "" : "s")</span>
                    }
                </button>
            </div>
        </div>

    </div>
}

@code {
    private List<MonthlyClientSummaryDto>? _summary;
    private HashSet<int> _selectedIds = new();
    private bool _isLoading = true;
    private bool _isGenerating = false;

    private int _availableCount => _summary?.Count(s => !s.AlreadyHasInvoice) ?? 0;
    private int _alreadyCount => _summary?.Count(s => s.AlreadyHasInvoice) ?? 0;
    private int _cancelledCount => _summary?.Count(s => !s.AlreadyHasInvoice && s.HasCancelledInvoice) ?? 0;
    private int _criticalCount => _summary?.Count(s => !s.AlreadyHasInvoice && s.HoursStatus == "Critical") ?? 0;
    private bool _allSelected => _availableCount > 0 && _selectedIds.Count >= _availableCount;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _summary = await InvoiceApiService.GetMonthlySummaryAsync();
            if (_summary != null)
                _selectedIds = _summary
                    .Where(s => !s.AlreadyHasInvoice)
                    .Select(s => s.ClientId)
                    .ToHashSet();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
            _summary = new();
        }
        finally { _isLoading = false; }
    }

    private void ToggleClient(int id)
    {
        if (!_selectedIds.Remove(id)) _selectedIds.Add(id);
    }

    private void ToggleAll()
    {
        if (_allSelected)
            _selectedIds.Clear();
        else
            _selectedIds = _summary!
                .Where(s => !s.AlreadyHasInvoice)
                .Select(s => s.ClientId)
                .ToHashSet();
    }

    private async Task Generate()
    {
        if (_selectedIds.Count == 0) return;
        _isGenerating = true;
        StateHasChanged();
        try
        {
            var (ok, err) = await InvoiceApiService.GenerateMonthlyInvoicesAsync(_selectedIds.ToList());
            DialogService.Close(ok ? "generated" : err);
        }
        finally { _isGenerating = false; }
    }

    private void Cancel() => DialogService.Close(null);
}
