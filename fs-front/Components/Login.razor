@layout AuthLayout

@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@using Radzen

<PageTitle>Iniciar Sesión - Finesoft</PageTitle>

<main>
    <RadzenTemplateForm Data="@_login" TItem="LoginModel" Submit="@LoginAsync">
        <DataAnnotationsValidator />

        <div class="mb-3">
            <label class="modern-label">Correo electrónico</label>

            <RadzenTextBox Name="Email" @bind-Value="_login.Email" Placeholder="micorreo@empresa.mx"
                Style="width:100%;" />

            <RadzenDataAnnotationValidator Component="Email" Style="display:block" />
        </div>

        <div class="mb-3">
            <label class="modern-label">Contraseña</label>

            <RadzenPassword Name="Password" @bind-Value="_login.Password" Placeholder="••••••••" Style="width:100%;"
                PasswordToggle="true" />

            <RadzenDataAnnotationValidator Component="Password" Style="display:block" />
        </div>

        <RadzenButton ButtonType="ButtonType.Submit" Disabled="@_isLoading"
            Text="@(_isLoading ? "Iniciando sesión..." : "Iniciar sesión")"
            Style="width:100%; background:#272e3f; color:white;" Icon="@(_isLoading ? "hourglass_top" : "login")" />
    </RadzenTemplateForm>

</main>

<style>
    .modern-label {
        display: block;
        font-size: .85rem;
        font-weight: 600;
        color: #334155;
        /* slate */
        margin-bottom: .35rem;
        letter-spacing: .2px;
    }

    :deep(.rz-textbox),
    :deep(.rz-password) {
        border-radius: 12px;
        padding: .75rem .9rem;
        border: 1px solid #e2e8f0;
        background: #fff;
    }

    :deep(.rz-textbox:focus),
    :deep(.rz-password:focus-within) {
        outline: none;
        border-color: #7c3aed;
        box-shadow: 0 0 0 4px rgba(124, 58, 237, .12);
    }

    :deep(.rz-message-error) {
        margin-top: .35rem;
        font-size: .8rem;
    }
</style>

@inject IAuthService AuthService
@inject AuthenticationStateProvider AuthProvider
@inject NavigationManager Nav
@inject NotificationService NotificationService

@code {
    private LoginModel _login = new();
    private bool _isLoading;

    private async Task LoginAsync()
    {
        _isLoading = true;

        var result = await AuthService.LoginAsync(_login);

        if (!result.Succeeded)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error de inicio de sesión",
                Detail = result.Errors.FirstOrDefault() ?? "Error desconocido",
                Duration = 5000
            });

            _isLoading = false;
            return;
        }

        // Ya se guardó token y se notificó auth state en tu CustomAuthStateProvider
        var state = await AuthProvider.GetAuthenticationStateAsync();
        NavigateByRole(state.User);

        _isLoading = false;
    }

    private void NavigateByRole(ClaimsPrincipal user)
    {
        var role = user.FindFirst(ClaimTypes.Role)?.Value;

        if (string.IsNullOrWhiteSpace(role) || role == "Technician")
        {
            Nav.NavigateTo("/pending");
            return;
        }

        Nav.NavigateTo("/dashboard");
    }
}