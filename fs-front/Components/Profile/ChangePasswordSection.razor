@using fs_front.DTO
@inject IJSRuntime JS

<div class="card pf-card mb-4">
    <div class="pf-card-header">
        <div class="pf-card-title">
            <i class="bi bi-shield-lock-fill text-warning"></i>
            <span>Cambiar Contraseña</span>
        </div>
    </div>

    <div class="card-body pf-info-body">
        <EditForm Model="_form" OnValidSubmit="HandleSubmit">
            <DataAnnotationsValidator />

            <div class="pf-password-grid">
                <!-- Current password -->
                <div class="pf-pw-field">
                    <label class="form-label pf-label">Contraseña actual</label>
                    <div class="pf-input-eye">
                        <InputText @bind-Value="_form.CurrentPassword"
                                   type="@(_showCurrent ? "text" : "password")"
                                   class="form-control"
                                   placeholder="••••••••" />
                        <button type="button" class="pf-eye-btn" @onclick="() => _showCurrent = !_showCurrent" tabindex="-1">
                            <i class="bi @(_showCurrent ? "bi-eye-slash" : "bi-eye")"></i>
                        </button>
                    </div>
                    <ValidationMessage For="() => _form.CurrentPassword" />
                </div>

                <!-- New password -->
                <div class="pf-pw-field">
                    <label class="form-label pf-label">Nueva contraseña</label>
                    <div class="pf-input-eye">
                        <InputText @bind-Value="_form.NewPassword"
                                   type="@(_showNew ? "text" : "password")"
                                   class="form-control"
                                   @oninput="OnNewPasswordInput"
                                   placeholder="Mínimo 6 caracteres" />
                        <button type="button" class="pf-eye-btn" @onclick="() => _showNew = !_showNew" tabindex="-1">
                            <i class="bi @(_showNew ? "bi-eye-slash" : "bi-eye")"></i>
                        </button>
                    </div>
                    <ValidationMessage For="() => _form.NewPassword" />

                    @if (!string.IsNullOrEmpty(_form.NewPassword))
                    {
                        <div class="pf-strength-bar mt-2">
                            <div class="pf-strength-track">
                                <div class="pf-strength-fill pf-strength-@_strength" style="width:@(_strengthPct)%"></div>
                            </div>
                            <span class="pf-strength-label pf-strength-text-@_strength">@_strengthLabel</span>
                        </div>
                    }
                </div>

                <!-- Confirm password -->
                <div class="pf-pw-field">
                    <label class="form-label pf-label">Confirmar nueva contraseña</label>
                    <div class="pf-input-eye">
                        <InputText @bind-Value="_form.ConfirmPassword"
                                   type="@(_showConfirm ? "text" : "password")"
                                   class="@($"form-control {(ConfirmMismatch ? "is-invalid" : "")}")"
                                   placeholder="Repite la nueva contraseña" />
                        <button type="button" class="pf-eye-btn" @onclick="() => _showConfirm = !_showConfirm" tabindex="-1">
                            <i class="bi @(_showConfirm ? "bi-eye-slash" : "bi-eye")"></i>
                        </button>
                    </div>
                    <ValidationMessage For="() => _form.ConfirmPassword" />
                    @if (ConfirmMismatch)
                    {
                        <div class="invalid-feedback d-block">Las contraseñas no coinciden.</div>
                    }
                </div>
            </div>

            @if (!string.IsNullOrEmpty(_error))
            {
                <div class="alert alert-danger py-2 small mt-3">
                    <i class="bi bi-exclamation-triangle-fill me-1"></i>@_error
                </div>
            }
            @if (!string.IsNullOrEmpty(_success))
            {
                <div class="alert alert-success py-2 small mt-3">
                    <i class="bi bi-check-circle-fill me-1"></i>@_success
                </div>
            }

            <div class="mt-3">
                <button type="submit" class="btn btn-warning pf-pw-btn" disabled="@(_saving || ConfirmMismatch)">
                    @if (_saving)
                    {
                        <span class="spinner-border spinner-border-sm me-1"></span>
                    }
                    else
                    {
                        <i class="bi bi-shield-check me-1"></i>
                    }
                    Cambiar contraseña
                </button>
            </div>
        </EditForm>

        <div class="pf-pw-tips mt-3">
            <i class="bi bi-info-circle me-1 text-muted"></i>
            <span class="text-muted small">Usa al menos 8 caracteres combinando letras, números y símbolos para mayor seguridad.</span>
        </div>
    </div>
</div>

@code {
    [Inject] public IUserApiService UserApi { get; set; } = default!;

    private ChangePasswordDto _form = new();
    private bool _saving = false;
    private bool _showCurrent = false;
    private bool _showNew = false;
    private bool _showConfirm = false;
    private string? _error = null;
    private string? _success = null;
    private string _strength = "weak";
    private string _strengthLabel = "";
    private int _strengthPct = 0;

    private bool ConfirmMismatch =>
        !string.IsNullOrEmpty(_form.NewPassword) &&
        !string.IsNullOrEmpty(_form.ConfirmPassword) &&
        _form.NewPassword != _form.ConfirmPassword;

    private void OnNewPasswordInput(ChangeEventArgs e)
    {
        var pw = e.Value?.ToString() ?? "";
        _form.NewPassword = pw;
        EvalStrength(pw);
    }

    private void EvalStrength(string pw)
    {
        int score = 0;
        if (pw.Length >= 6) score++;
        if (pw.Length >= 10) score++;
        if (pw.Any(char.IsDigit)) score++;
        if (pw.Any(char.IsUpper)) score++;
        if (pw.Any(c => !char.IsLetterOrDigit(c))) score++;

        (_strength, _strengthLabel, _strengthPct) = score switch
        {
            <= 1 => ("weak", "Débil", 25),
            2 => ("fair", "Regular", 50),
            3 => ("good", "Buena", 75),
            _ => ("strong", "Fuerte", 100)
        };
    }

    private async Task HandleSubmit()
    {
        if (ConfirmMismatch)
        {
            _error = "Las contraseñas no coinciden.";
            return;
        }

        var confirmed = await JS.InvokeAsync<bool>("confirm",
            "¿Deseas cambiar tu contraseña? Deberás iniciar sesión nuevamente si es necesario.");
        if (!confirmed) return;

        _saving = true;
        _error = null;
        _success = null;

        var (ok, err) = await UserApi.ChangeMyPasswordAsync(_form);
        _saving = false;

        if (ok)
        {
            _success = "¡Contraseña cambiada exitosamente!";
            _form = new();
            _strength = "weak";
            _strengthLabel = "";
            _strengthPct = 0;
        }
        else
        {
            _error = err ?? "Error al cambiar la contraseña.";
        }
    }
}
