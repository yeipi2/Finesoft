@* Tabla de tickets con badges reutilizables, columna condicional por rol y acciones *@
@using fs_front.DTO

<FsDataTable TItem="TicketDetailDto"
             Title="@(CanViewAll ? "Tickets" : "Mis Tickets")"
             Subtitle="Ordena por columna y gestiona rápidamente"
             Items="Items"
             IsLoading="IsLoading"
             ColSpan="@(CanViewAll ? 8 : 7)"
             EmptyTitle="No se encontraron tickets"
             EmptySubtitle="Prueba ajustando filtros o búsqueda.">

    <Header>
        <FsSortHeader Text="ID" Field="id" ActiveField="@SortField" Direction="@SortDir" SortChanged="OnSortChanged" />
        <FsSortHeader Text="Título" Field="title" ActiveField="@SortField" Direction="@SortDir" SortChanged="OnSortChanged" />
    <th>Cliente / Proyecto</th>
    <FsSortHeader Text="Prioridad" Field="priority" ActiveField="@SortField" Direction="@SortDir" SortChanged="OnSortChanged" />
    <FsSortHeader Text="Estado" Field="status" ActiveField="@SortField" Direction="@SortDir" SortChanged="OnSortChanged" />
    @if (CanViewAll)
    {
        <th style="width: 130px; min-width: 130px;">Asignado a</th>
    }
    <th style="width: 140px; min-width: 140px;">Horas</th>
    <th class="text-center" style="width: 80px;">Acciones</th>
    </Header>

    <RowTemplate Context="ticket">
        <tr>
            <td class="fw-bold">#@ticket.Id</td>

            <td>
                <div class="fw-bold">@ticket.Title</div>
                <small class="text-muted">
                    @(ticket.Description?.Length > 50
                                        ? ticket.Description.Substring(0, 50) + "..."
                                        : ticket.Description)
                </small>
            </td>

            <td>
                <div><strong>@ticket.ClientName</strong></div>
                <small class="text-muted">@ticket.ProjectName</small>
            </td>

            <td>
                <TicketPriorityBadge Priority="@ticket.Priority" />
            </td>

            <td>
                <TicketStatusBadge Status="@ticket.Status" />
            </td>

            @if (CanViewAll)
            {
                <td style="width: 130px; min-width: 130px;">
                    @if (!string.IsNullOrEmpty(ticket.AssignedToUserName))
                    {
                        <span class="text-truncate d-inline-block" style="max-width: 120px;"
                              title="@ticket.AssignedToUserName">
                            @ticket.AssignedToUserName
                        </span>
                    }
                    else
                    {
                        <span class="text-muted fst-italic">Sin asignar</span>
                    }
                </td>
            }

            <td style="width: 140px; min-width: 140px;">
                <div class="d-flex flex-column gap-1">
                    <div>
                        <small class="text-muted">Estimadas:</small>
                        <span class="ms-1">@ticket.EstimatedHours.ToString("0.0")h</span>
                    </div>
                    <div>
                        <small class="text-muted">Reales:</small>
                        <strong class="text-success ms-1">@ticket.ActualHours.ToString("0.0")h</strong>
                    </div>
                </div>
            </td>

            <td class="text-center">
                @if (CurrentRole != "Cliente")
                {
                    <button class="btn btn-sm btn-outline-primary"
                            @onclick="() => OnViewDetails.InvokeAsync(ticket.Id)"
                            title="Ver detalles">
                        <i class="bi bi-eye-fill"></i>
                    </button>
                }
            </td>
        </tr>
    </RowTemplate>

</FsDataTable>

@code {
    [Parameter, EditorRequired] public IEnumerable<TicketDetailDto> Items { get; set; } = Enumerable.Empty<TicketDetailDto>();
    [Parameter] public bool IsLoading { get; set; }
    [Parameter] public bool CanViewAll { get; set; }
    [Parameter] public string? CurrentRole { get; set; }

    // Ordenamiento
    [Parameter] public string SortField { get; set; } = "createdAt";
    [Parameter] public FsSortHeader.SortDirection SortDir { get; set; } = FsSortHeader.SortDirection.Desc;
    [Parameter] public EventCallback<(string field, FsSortHeader.SortDirection dir)> SortChanged { get; set; }

    // Acciones
    [Parameter] public EventCallback<int> OnViewDetails { get; set; }

    private void OnSortChanged((string field, FsSortHeader.SortDirection dir) s)
        => SortChanged.InvokeAsync(s);
}
