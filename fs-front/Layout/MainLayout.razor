@inherits LayoutComponentBase
@implements IDisposable
@using Microsoft.AspNetCore.Components.Routing

@inject fs_front.Services.PermissionsRealtimeClient Realtime
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation

<HeadContent>
    <RadzenTheme Theme="material" />
</HeadContent>

<div class="fs-appshell">
    <header class="fs-topbar bg-white">
        <div class="fs-topbar__inner px-3">
            <div class="fs-topbar__left">
                <button type="button" class="btn btn-light border fs-topbar__toggle"
                        @onclick="ToggleSidebar" title="Menú">
                    <i class="bi bi-list"></i>
                </button>
                <a class="d-flex align-items-center gap-2 text-decoration-none">
                    <img src="images/LogoFinesoftt.png" alt="Logo de Finesoft" style="height:50px;" />
                </a>
            </div>

            <div class="fs-topbar__right d-flex align-items-center gap-2">
                <ThemeToggle />
                <NavBar />
            </div>
        </div>
    </header>

    <div class="fs-content @(_sidebarCollapsed ? "is-collapsed" : "")">
        <SideBar Collapsed="@_sidebarCollapsed" />
        <main class="fs-main">
            @Body
        </main>
    </div>
</div>

<RadzenComponents />
<RadzenNotification />

<style>
    /* Contenedor de cada notificación tiene posición relativa */
    .rz-notification {
        overflow: hidden;
    }

        /* La línea de progreso */
        .rz-notification::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            width: 100%;
            background-color: currentColor;
            opacity: 0.5;
            animation: fs-notify-progress 4s linear forwards;
            transform-origin: left;
        }

    @@keyframes fs-notify-progress {
        from {
            width: 100%;
        }

        to {
            width: 0%;
        }
    }

    /* Colores por tipo */
    .rz-notification-success::after {
        background-color: #4caf50;
    }

    .rz-notification-error::after {
        background-color: #f44336;
    }

    .rz-notification-warning::after {
        background-color: #ff9800;
    }

    .rz-notification-info::after {
        background-color: #2196f3;
    }
</style>

@code {
    private bool _sidebarCollapsed;
    private string _currentTitle = "Panel";
    private EventHandler<LocationChangedEventArgs>? _locationHandler;

    protected override async Task OnInitializedAsync()
    {
        // ✅ título dinámico
        SetTitleFromRoute();
        _locationHandler = (_, __) =>
        {
            SetTitleFromRoute();
            InvokeAsync(StateHasChanged);
        };
        Navigation.LocationChanged += _locationHandler;

        // ✅ tus eventos existentes
        AuthStateProvider.AuthenticationStateChanged += OnAuthChanged;
        Realtime.PermissionsChanged += OnPermissionsChanged;

        // Intento inicial (si ya había token guardado)
        await EnsureRealtimeConnectionAsync();
    }

    private void ToggleSidebar() => _sidebarCollapsed = !_sidebarCollapsed;

    private void SetTitleFromRoute()
    {
        var path = Navigation.ToBaseRelativePath(Navigation.Uri).ToLowerInvariant();

        _currentTitle = path switch
        {
            "" or "dashboard" => "Panel",
            var p when p.StartsWith("clientes") => "Clientes",
            var p when p.StartsWith("empleados") => "Empleados",
            var p when p.StartsWith("proyectos") => "Proyectos",
            var p when p.StartsWith("tickets") => "Tickets",
            var p when p.StartsWith("cotizaciones") => "Cotizaciones",
            var p when p.StartsWith("facturas") => "Facturas",
            var p when p.StartsWith("reportes") => "Reportes",
            var p when p.StartsWith("permisos") => "Permisos",
            var p when p.StartsWith("usuarios") => "Usuarios",
            _ => "Finesoft"
        };
    }

    private async void OnAuthChanged(Task<AuthenticationState> task)
    {
        await EnsureRealtimeConnectionAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async Task EnsureRealtimeConnectionAsync()
    {
        var state = await AuthStateProvider.GetAuthenticationStateAsync();
        var isAuth = state.User.Identity?.IsAuthenticated == true;

        if (isAuth && !Realtime.IsConnected)
            await Realtime.StartAsync();

        if (!isAuth && Realtime.IsConnected)
            await Realtime.StopAsync();
    }

    private async Task OnPermissionsChanged()
    {
        var auth = (fs_front.Services.CustomAuthStateProvider)AuthStateProvider;

        var ok = await auth.RefreshAsync();
        if (!ok)
        {
            auth.Logout();
            Navigation.NavigateTo("/iniciar-sesion", forceLoad: true);
            return;
        }

        // ✅ Importante: recargar para que SideBar vuelva a evaluar permisos/claims
        Navigation.NavigateTo(Navigation.Uri, forceLoad: true);
    }

    public void Dispose()
    {
        AuthStateProvider.AuthenticationStateChanged -= OnAuthChanged;
        Realtime.PermissionsChanged -= OnPermissionsChanged;

        if (_locationHandler is not null)
            Navigation.LocationChanged -= _locationHandler;
    }
}