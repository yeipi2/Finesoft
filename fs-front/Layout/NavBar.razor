@using Microsoft.AspNetCore.Components.Authorization
@using System.Security.Claims
@using fs_front.Services

<AuthorizeView Context="authCtx">
    <Authorized>
        <div class="fs-user-menu">
            <button type="button"                    class="fs-avatar"                    @onclick="ToggleDropdown"                    aria-label="Menú de usuario"
                    title="@authCtx.User.Identity?.Name">
                @GetUserInitials(authCtx.User.Identity?.Name)
            </button>

            @if (_isDropdownOpen)
            {
                <!-- Overlay para cerrar al click fuera -->
                <div class="fs-overlay" @onclick="CloseDropdown"></div>

                <!-- Dropdown (no debe cerrar cuando haces click dentro) -->
                <div class="fs-user-dropdown" @onclick:stopPropagation="true">
                    <div class="p-3">
                        <div class="fw-semibold">@authCtx.User.Identity?.Name</div>
                        <div class="text-muted small">
                            @authCtx.User.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value
                        </div>
                        <div class="mt-2">
                            <span class="badge bg-primary">@GetUserRole(authCtx.User)</span>
                        </div>
                    </div>

                    <div class="fs-user-dropdown__divider"></div>

                    <button type="button" class="fs-user-dropdown__item-danger" @onclick="Logout">
                        <i class="bi bi-box-arrow-right me-2"></i>
                        Cerrar sesión
                    </button>
                </div>
            }
        </div>
    </Authorized>
</AuthorizeView>

@code {
    [Inject] public AuthenticationStateProvider Provider { get; set; } = default!;
    [Inject] public NavigationManager Navigation { get; set; } = default!;

    private bool _isDropdownOpen;

    private void ToggleDropdown() => _isDropdownOpen = !_isDropdownOpen;
    private void CloseDropdown() => _isDropdownOpen = false;

    private void Logout()
    {
        var auth = (CustomAuthStateProvider)Provider;
        auth.Logout();
        Navigation.NavigateTo("/iniciar-sesion");
    }

    private static string GetUserInitials(string? userName)
    {
        if (string.IsNullOrWhiteSpace(userName))
            return "??";

        var local = userName.Split('@')[0];
        var parts = local.Split('.', StringSplitOptions.RemoveEmptyEntries);

        if (parts.Length >= 2)
            return $"{parts[0][0]}{parts[1][0]}".ToUpperInvariant();

        return local.Length >= 2 ? local[..2].ToUpperInvariant() : local.ToUpperInvariant();
    }

    private static string GetUserRole(ClaimsPrincipal user)
    {
        var role = user.FindFirst(ClaimTypes.Role)?.Value;
        return role switch
        {
            "Admin" => "Administrador",
            "Administracion" => "Administración",
            "Empleado" => "Empleado",
            "Supervisor" => "Supervisor",
            "Cliente" => "Cliente",
            _ => "Sin rol"
        };
    }
}