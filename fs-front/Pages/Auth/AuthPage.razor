@page "/iniciar-sesion"
@page "/registrarme"
@layout AuthLayout

@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@using Radzen

@inject NavigationManager Nav
@inject IAuthService AuthService
@inject AuthenticationStateProvider AuthProvider
@inject NotificationService NotificationService

<PageTitle>@(IsRegister ? "Registrarme - Finesoft" : "Iniciar Sesión - Finesoft")</PageTitle>

<section class="auth-shell @(IsRegister ? "is-register" : "")">

    <AuthOverlay AnimationKey="@LogoKey" Title="@(IsRegister ? "¡Qué bueno verte!" : "Hola, Bienvenido!")"
                 Subtitle="@(IsRegister ? "¿Ya tienes una cuenta?" : "¿No tienes una cuenta?")"
                 ActionText="@(IsRegister ? "Iniciar sesión" : "Registrarse")" OnAction="@(IsRegister ? GoLogin : GoRegister)" />

    <div class="form-panel">
        @if (!IsRegister)
        {
            <LoginForm Model="@Login" OnSubmit="@LoginAsync" IsLoading="@Loading" ErrorMessage="@LoginError"
                       OnSwitchToRegister="@GoRegister" />

        }
        else
        {
            <RegisterForm Model="@Register" OnSubmit="@RegisterAsync" IsLoading="@Loading" OnSwitchToLogin="@GoLogin" />
        }
    </div>
</section>

@code {
    private string? LoginError;
    private bool IsRegister;
    private bool Loading;
    private string LogoKey = Guid.NewGuid().ToString();
    private LoginModel Login = new();
    private RegisterModel Register = new();

    // ⭐ Roles válidos del sistema (los 5 roles definidos)
    private static readonly HashSet<string> RolesValidos = new(StringComparer.OrdinalIgnoreCase)
    {
        "Admin", "Administracion", "Empleado", "Supervisor", "Cliente"
    };

    protected override void OnInitialized()
    {
        SyncModeFromRoute();
        Nav.LocationChanged += (_, __) =>
        {
            SyncModeFromRoute();
            StateHasChanged();
        };
    }

    private void SyncModeFromRoute()
    {
        var path = Nav.ToBaseRelativePath(Nav.Uri).ToLowerInvariant();
        var newIsRegister = path.StartsWith("registrarme");

        if (newIsRegister != IsRegister)
        {
            IsRegister = newIsRegister;
            LogoKey = Guid.NewGuid().ToString();
            return;
        }

        IsRegister = newIsRegister;
    }

    private void GoRegister() => Nav.NavigateTo("/registrarme");
    private void GoLogin() => Nav.NavigateTo("/iniciar-sesion");

    // ⭐ HELPER: decide a dónde navegar según el rol del usuario
    private string GetRedirectUrl(System.Security.Claims.ClaimsPrincipal user)
    {
        var role = user.FindFirst(ClaimTypes.Role)?.Value;

        // Sin rol asignado → página de espera
        if (string.IsNullOrWhiteSpace(role))
            return "/pending";

        // Rol no reconocido (residuo de versiones anteriores, ej: "Technician") → página de espera
        if (!RolesValidos.Contains(role))
            return "/pending";

        // Rol válido → dashboard
        return "/dashboard";
    }

    private async Task LoginAsync()
    {
        LoginError = null;
        Loading = true;

        var result = await AuthService.LoginAsync(Login);

        if (!result.Succeeded)
        {
            LoginError = result.Errors.FirstOrDefault() ?? "Correo o contraseña incorrectos.";

            // puedes dejar la notificación si quieres
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error de inicio de sesión",
                Detail = LoginError,
                Duration = 5000
            });

            Loading = false;
            return;
        }

        var state = await AuthProvider.GetAuthenticationStateAsync();
        Loading = false;

        Nav.NavigateTo(GetRedirectUrl(state.User));
    }

    private async Task RegisterAsync()
    {
        Loading = true;

        var auth = (fs_front.Services.CustomAuthStateProvider)AuthProvider;
        var result = await auth.RegisterAsync(Register);

        Loading = false;

        if (!result.Succeeded)
        {
            foreach (var e in result.Errors)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Error de registro",
                    Detail = e,
                    Duration = 5000
                });
            }
            return;
        }

        NotificationService.Notify(new NotificationMessage
        {
            Severity = NotificationSeverity.Success,
            Summary = "Registro exitoso",
            Detail = "Tu cuenta ha sido creada. Espera a que un administrador te asigne un rol.",
            Duration = 3500
        });

        // ✅ CORRECCIÓN: después del registro el usuario NO tiene rol → /pending
        // (el JWT recién creado no tendrá ningún claim de rol)
        var state = await AuthProvider.GetAuthenticationStateAsync();
        Nav.NavigateTo(GetRedirectUrl(state.User));
    }
}