@page "/iniciar-sesion"
@page "/registrarme"
@layout AuthLayout

@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@using Radzen

@inject NavigationManager Nav
@inject IAuthService AuthService
@inject AuthenticationStateProvider AuthProvider
@inject NotificationService NotificationService

<PageTitle>@(IsRegister ? "Registrarme - Finesoft" : "Iniciar Sesión - Finesoft")</PageTitle>

<section class="auth-shell @(IsRegister ? "is-register" : "")">

    <AuthOverlay AnimationKey="@LogoKey"                 Title="@(IsRegister ? "¡Qué bueno verte!" : "Hola, Bienvenido!")"
                 Subtitle="@(IsRegister ? "¿Ya tienes una cuenta?" : "¿No tienes una cuenta?")"
                 ActionText="@(IsRegister ? "Iniciar sesión" : "Registrarse")"                 OnAction="@(IsRegister ? GoLogin : GoRegister)" />

    <div class="form-panel">
        @if (!IsRegister)
        {
            <LoginForm Model="@Login" OnSubmit="@LoginAsync" IsLoading="@Loading"                      OnSwitchToRegister="@GoRegister" />
        }
        else
        {
            <RegisterForm Model="@Register" OnSubmit="@RegisterAsync" IsLoading="@Loading"                         OnSwitchToLogin="@GoLogin" />
        }
    </div>
</section>

@code {
    private bool IsRegister;
    private bool Loading;
    private string LogoKey = Guid.NewGuid().ToString();
    private LoginModel Login = new();
    private RegisterModel Register = new();

    protected override void OnInitialized()
    {
        SyncModeFromRoute();
        Nav.LocationChanged += (_, __) =>
        {
            SyncModeFromRoute();
            StateHasChanged();
        };
    }

    private void SyncModeFromRoute()
    {
        var path = Nav.ToBaseRelativePath(Nav.Uri).ToLowerInvariant();
        var newIsRegister = path.StartsWith("registrarme");

        if (newIsRegister != IsRegister)
        {
            IsRegister = newIsRegister;
            LogoKey = Guid.NewGuid().ToString();
            return;
        }

        IsRegister = newIsRegister;
    }

    private void GoRegister() => Nav.NavigateTo("/registrarme");
    private void GoLogin() => Nav.NavigateTo("/iniciar-sesion");

    private async Task LoginAsync()
    {
        Loading = true;

        var result = await AuthService.LoginAsync(Login);
        if (!result.Succeeded)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error de inicio de sesión",
                Detail = result.Errors.FirstOrDefault() ?? "Error desconocido",
                Duration = 5000
            });
            Loading = false;
            return;
        }

        var state = await AuthProvider.GetAuthenticationStateAsync();
        var user = state.User;
        var role = user.FindFirst(ClaimTypes.Role)?.Value;

        Loading = false;

        Nav.NavigateTo(string.IsNullOrWhiteSpace(role) || role == "Technician"
            ? "/pending"
            : "/dashboard");
    }

    private async Task RegisterAsync()
    {
        Loading = true;

        var auth = (fs_front.Services.CustomAuthStateProvider)AuthProvider;
        var result = await auth.RegisterAsync(Register);

        Loading = false;

        if (!result.Succeeded)
        {
            foreach (var e in result.Errors)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Error de registro",
                    Detail = e,
                    Duration = 5000
                });
            }
            return;
        }

        NotificationService.Notify(new NotificationMessage
        {
            Severity = NotificationSeverity.Success,
            Summary = "Registro exitoso",
            Detail = "Tu cuenta ha sido creada correctamente.",
            Duration = 2500
        });

        Nav.NavigateTo("/dashboard");
    }
}