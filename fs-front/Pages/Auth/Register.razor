@page "/registrarme"
@layout AuthLayout

<header class="mb-2">
    <img src="https://cs3mesh4eosc.eu/sites/default/files/2022-01/Risorsa%2016%20%281%29.png" class="img-fluid mb-2"
         alt="Logo">
    <h1 class="h5 fw-semibold">Create una cuenta 👋</h1>
    <p class="text-muted small">Registrate para usar las funcionalidades.</p>
</header>

<main>
    <EditForm Model="_register" OnValidSubmit="RegisterAsync" FormName="RegisterForm">
        <DataAnnotationsValidator/>

        <div class="mb-2">
            <label for="email" class="form-label small fw-semibold">Correo electrónico</label>
            <InputText @bind-Value="_register.Email" id="email" placeholder="micorreo@empresa.mx"
                       class="form-control" autocomplete="email"/>
            <ValidationMessage For="@(() => _register.Email)" class="text-danger small"/>
        </div>

        <div class="mb-2">
            <label for="password" class="form-label small fw-semibold">Contraseña</label>
            <InputText type="password" @bind-Value="_register.Password" id="password" placeholder="••••••••••••••••"
                       class="form-control"/>
            <ValidationMessage For="@(() => _register.Password)" class="text-danger small"/>
        </div>

        <div class="mb-3">
            <label for="confirmPassword" class="form-label small fw-semibold">Confirmar contraseña</label>
            <InputText type="password" @bind-Value="_register.ConfirmPassword" id="confirmPassword"
                       placeholder="••••••••••••••••"
                       class="form-control"/>
            <ValidationMessage For="@(() => _register.ConfirmPassword)" class="text-danger small"/>
        </div>

        @if (_isLoading)
        {
            <button class="btn btn-primary w-100 py-2" type="button" disabled>
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                Registrandote...
            </button>
        }
        else
        {
            <button class="btn btn-primary w-100 py-2" type="submit">
                Registrarme
            </button>
        }
    </EditForm>

    <footer class="mt-3 text-center">
        <p class="small text-muted">
            ¿Ya tienes una cuenta?
            <a href="/iniciar-sesion" class="text-primary fw-bold">Inicia sesión ahora</a>
        </p>
    </footer>
</main>

@inject AuthenticationStateProvider provider
@inject NavigationManager navigation
@inject NotificationService NotificationService

@code {
    public RegisterModel _register = new();
    private bool _isLoading = false;

    private async Task RegisterAsync()
    {
        _isLoading = true;
        StateHasChanged();

        var auth = (CustomAuthStateProvider)provider;
        var formResult = await auth.RegisterAsync(_register);

        if (formResult.Succeeded)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Success,
                Summary = "Registro exitoso",
                Detail = "Tu cuenta ha sido creada correctamente.",
                Duration = 3000
            });
            navigation.NavigateTo("/dashboard");
        }
        else
        {
            foreach (var error in formResult.Errors)
            {
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Error de registro",
                    Detail = error,
                    Duration = 5000
                });
            }
        }

        _isLoading = false;
        StateHasChanged();
    }

}