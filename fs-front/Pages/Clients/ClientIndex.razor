@page "/clientes"
@using fs_front.DTO
@using fs_front.Components.Clients.Index
@using fs_front.Components.Clients.Shared
@inject IClientApiService ClientApiService
@inject DialogService DialogService
@inject NotificationService NotificationService
@inject PermissionService PermissionService
@inject NavigationManager NavigationManager

@attribute [Authorize]

<PageTitle>Finesoft - Clientes</PageTitle>

@if (_checkingAccess)
{
    <div class="loading-overlay">
        <div class="spinner-border text-primary" role="status"></div>
    </div>
}
else if (!_hasAccess)
{
    <div></div>
}
else
{
    <div class="container p-4">
        <section class="container-fluid px-xl-5">
            <ClientsHeader CanCreate="@_canCreate" OnCreateClick="ShowCreateModal" />
        </section>

        <section class="container-fluid px-xl-5 mb-4">
            <FilterBar Class="mb-0"
                       SearchPlaceholder="Buscar clientes..."
                       SearchValue="@_searchText"
                       SearchValueChanged="@(v => _searchText = v)"
                       OnClear="ClearFilters">
                <Filters>
                    <select class="form-select" @bind="_statusFilter">
                        <option value="Todos">Estados</option>
                        <option value="Activos">Activos</option>
                        <option value="Inactivos">Inactivos</option>
                    </select>
                </Filters>
            </FilterBar>
        </section>

        <section class="container-fluid p-xl-5">
            <ClientsTable Clients="@_sortedClients"
                          IsLoading="@_isLoading"
                          CanEdit="@_canEdit"
                          CanDelete="@_canDelete"
                          SortField="@_sortField"
                          SortDirection="@_sortDir"
                          OnSortChanged="OnSortChanged"
                          OnEdit="ShowEditModal"
                          OnToggleStatus="ToggleClientStatus" />
        </section>
    </div>
}

@code {
    private List<ClientDto>? _clients = new();
    private string _searchText = string.Empty;
    private bool _isLoading = false;
    private string _statusFilter = "Todos";

    private string _sortField = "company";
    private FsSortHeader.SortDirection _sortDir = FsSortHeader.SortDirection.Desc;

    private bool _checkingAccess = true;
    private bool _hasAccess = false;
    private bool _canCreate, _canEdit, _canDelete;

    // ── Opciones de diálogo reutilizables ──
    private static readonly DialogOptions _formDialogOptions = new()
    {
        Width = "720px",
        Resizable = false,
        Draggable = false
    };

    protected override async Task OnInitializedAsync()
    {
        var canView = await PermissionService.HasPermissionAsync("clients.view");
        if (!canView)
        {
            _checkingAccess = false;
            _hasAccess = false;
            NavigationManager.NavigateTo("/dashboard", forceLoad: true);
            return;
        }

        _hasAccess = true;
        _checkingAccess = false;

        _canCreate = await PermissionService.HasPermissionAsync("clients.create");
        _canEdit = await PermissionService.HasPermissionAsync("clients.edit");
        _canDelete = await PermissionService.HasPermissionAsync("clients.delete");

        await LoadClients();
    }

    private async Task LoadClients()
    {
        _isLoading = true;
        try
        {
            _clients = await ClientApiService.GetClientsAsync();
        }
        catch (Exception e)
        {
            Console.WriteLine(e);
            ShowNotification("Error", "No se pudo cargar la lista de clientes.", NotificationSeverity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void OnSortChanged((string field, FsSortHeader.SortDirection dir) s)
    {
        _sortField = s.field;
        _sortDir = s.dir;
    }

    private IEnumerable<ClientDto> _sortedClients => ApplySort(_filteredClients);

    private IEnumerable<ClientDto> ApplySort(IEnumerable<ClientDto> q) =>
        (_sortField, _sortDir) switch
        {
            ("company", FsSortHeader.SortDirection.Asc) => q.OrderBy(x => x.CompanyName),
            ("company", FsSortHeader.SortDirection.Desc) => q.OrderByDescending(x => x.CompanyName),
            ("contact", FsSortHeader.SortDirection.Asc) => q.OrderBy(x => x.ContactName ?? ""),
            ("contact", FsSortHeader.SortDirection.Desc) => q.OrderByDescending(x => x.ContactName ?? ""),
            ("email", FsSortHeader.SortDirection.Asc) => q.OrderBy(x => x.Email ?? ""),
            ("email", FsSortHeader.SortDirection.Desc) => q.OrderByDescending(x => x.Email ?? ""),
            ("service", FsSortHeader.SortDirection.Asc) => q.OrderBy(x => x.ServiceMode ?? ""),
            ("service", FsSortHeader.SortDirection.Desc) => q.OrderByDescending(x => x.ServiceMode ?? ""),
            ("status", FsSortHeader.SortDirection.Asc) => q.OrderBy(x => x.IsActive),
            ("status", FsSortHeader.SortDirection.Desc) => q.OrderByDescending(x => x.IsActive),
            _ => q.OrderByDescending(x => x.CompanyName),
        };

    private IEnumerable<ClientDto> _filteredClients =>
        _clients?
            .Where(c =>
                (string.IsNullOrWhiteSpace(_searchText) ||
                 c.CompanyName.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
                 (c.ContactName?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false) ||
                 (c.Email?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false) ||
                 (c.Phone?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false))
                && (_statusFilter == "Todos" ||
                    (_statusFilter == "Activos" && c.IsActive) ||
                    (_statusFilter == "Inactivos" && !c.IsActive))
            ) ?? Enumerable.Empty<ClientDto>();

    private async Task ShowCreateModal()
    {
        var result = await DialogService.OpenAsync<ClientForm>(
            "Crear Cliente",
            options: _formDialogOptions);
        if (result == true) await LoadClients();
    }

    private async Task ShowEditModal(int? clientId)
    {
        var parameters = new Dictionary<string, object> { { "UserId", clientId } };
        var result = await DialogService.OpenAsync<ClientForm>(
            "Editar Cliente",
            parameters,
            options: _formDialogOptions);
        if (result == true) await LoadClients();
    }

    private async Task ToggleClientStatus(ClientDto client)
    {
        var actionText = client.IsActive ? "desactivar" : "activar";
        var confirmed = await DialogService.Confirm(
            $"¿Estás seguro de que quieres {actionText} a {client.CompanyName}?",
            $"Confirmar {actionText}",
            new ConfirmOptions
            {
                OkButtonText = $"Sí, {actionText}",
                CancelButtonText = "Cancelar"
            });

        if (confirmed == true)
        {
            try
            {
                var (success, errorMessage) = await ClientApiService.DeleteClientAsync(client.Id);
                if (success)
                {
                    ShowNotification("Éxito",
                        $"Cliente {(client.IsActive ? "desactivado" : "activado")} correctamente.",
                        NotificationSeverity.Success);
                    await LoadClients();
                }
                else
                {
                    ShowNotification("Error", errorMessage ?? "No se pudo actualizar el estado.", NotificationSeverity.Error);
                }
            }
            catch (Exception ex)
            {
                ShowNotification("Error Grave", ex.Message, NotificationSeverity.Error);
            }
        }
    }

    private void ClearFilters()
    {
        _searchText = string.Empty;
        _statusFilter = "Todos";
    }

    private void ShowNotification(string title, string message, NotificationSeverity severity) =>
        NotificationService.Notify(new NotificationMessage
        {
            Severity = severity,
            Summary = title,
            Detail = message,
            Duration = 4000
        });
}
