@page "/empleados"
@using fs_front.DTO
@using fs_front.Services
@using fs_front.Repositories
@inject IEmployeeApiService EmployeeApiService
@inject DialogService DialogService
@inject NotificationService NotificationService
@inject PermissionService PermissionService
@inject NavigationManager NavigationManager

@attribute [Authorize]

<PageTitle>Finesoft - Empleados</PageTitle>

@if (_checkingAccess)
{
    <div style="position:fixed;top:0;left:0;width:100vw;height:100vh;
        background:white;z-index:9999;
        display:flex;align-items:center;justify-content:center;">
        <div class="spinner-border text-primary" role="status"></div>
    </div>
}
else if (!_hasAccess)
{
    <div></div>
}
else
{
    <container class="container p-4">
        <section class="container-fluid px-xl-5">
            <div class="d-flex justify-content-between align-items-start mb-4">
                <div class="d-flex align-items-center">
                    <i class="bi bi-person-badge fs-1 text-primary me-3"></i>
                    <div>
                        <p class="display-6 fw-bolder mb-2">Empleados Registrados</p>
                        <p class="text-muted mb-0">Gestión del personal de la empresa</p>
                    </div>
                </div>
                @if (_canCreate)
                {
                    <button @onclick="ShowCreateModal" class="btn btn-primary d-flex align-items-center gap-2 fw-bold small">
                        <i class="bi bi-plus-lg"></i> Nuevo Empleado
                    </button>
                }
            </div>

            <div class="d-flex flex-wrap align-items-center gap-3 mb-4">
                <div class="flex-grow-1">
                <SearchBar Placeholder="Buscar empleados..."
                           Value="@_searchTerm"
                           ValueChanged="@(v => { _searchTerm = v; FilterEmployees(); })" />
                </div>
                <div class="mb-3">
                    <select class="form-select w-auto"
                            @onchange="OnStatusFilterChanged">
                        <option value="Todos">Todos</option>
                        <option value="Activos">Activos</option>
                        <option value="Inactivos">Inactivos</option>
                    </select>
                </div>
            </div>
        </section>


        <section class="container-fluid p-xl-5">
            <FsDataTable TItem="EmployeeDto" Title="Empleados" Subtitle="Gestión del personal de la empresa"
                         Items="_sortedEmployees" IsLoading="_isLoading" ColSpan="7"
                         EmptyTitle="@(_employees == null || !_employees.Any() ? "No hay empleados registrados" : "No se encontraron empleados")"
                         EmptySubtitle="Prueba con otra búsqueda.">

                <Header>
                    <FsSortHeader Text="Nombre" Field="name" ActiveField="@_sortField" Direction="@_sortDir"
                                  SortChanged="OnSortChanged" ThClass="ps-4" />
                    <FsSortHeader Text="Email / RFC" Field="email" ActiveField="@_sortField" Direction="@_sortDir"
                                  SortChanged="OnSortChanged" />
                    <FsSortHeader Text="Puesto" Field="position" ActiveField="@_sortField" Direction="@_sortDir"
                                  SortChanged="OnSortChanged" />
                    <FsSortHeader Text="Departamento" Field="department" ActiveField="@_sortField" Direction="@_sortDir"
                                  SortChanged="OnSortChanged" />
                    <FsSortHeader Text="Rol" Field="role" ActiveField="@_sortField" Direction="@_sortDir"
                                  SortChanged="OnSortChanged" />
                    <FsSortHeader Text="Estado" Field="status" ActiveField="@_sortField" Direction="@_sortDir"
                                  SortChanged="OnSortChanged" />
                    <th class="text-center">Acciones</th>
                </Header>

                <RowTemplate Context="employee">
                    <tr>
                        <td class="fw-bold ps-4">
                            @employee.FullName
                            <div class="text-muted small">@employee.Phone</div>
                        </td>

                        <td>
                            <div class="fw-bold">@employee.Email</div>
                            <div class="text-muted small">@employee.RFC</div>
                        </td>

                        <td>@employee.Position</td>
                        <td>@employee.Department</td>

                        <td>
                            <span class="badge bg-info text-dark">@employee.RoleName</span>
                        </td>

                        <td>
                            <span class="badge @(employee.IsActive ? "bg-success" : "bg-secondary")">
                                @(employee.IsActive ? "Activo" : "Inactivo")
                            </span>
                        </td>

                        <td class="text-center">
                            @if (_canEdit)
                            {
                                <button @onclick="@(() => ShowEditModal(employee.Id))"
                                        class="btn btn-sm btn-outline-primary me-1" title="Editar">
                                    <i class="bi bi-pencil-fill"></i>
                                </button>
                            }
                            @if (_canEdit)
                            {
                                <button @onclick="@(() => ToggleEmployeeStatus(employee))"
                                        class="btn btn-sm @(employee.IsActive ? "btn-outline-warning" : "btn-outline-success")"
                                        title="Cambiar estado">
                                    <i class="bi @(employee.IsActive ? "bi-person-x-fill" : "bi-person-check-fill")"></i>
                                </button>
                            }

                        </td>
                    </tr>
                </RowTemplate>

            </FsDataTable>
        </section>
    </container>
}

@code {
    private List<EmployeeDto>? _employees = new();
    private List<EmployeeDto>? _filteredEmployees = new();
    private string _statusFilter = "Todos";


    private bool _checkingAccess = true;
    private bool _hasAccess = false;
    private bool _canCreate;
    private bool _canEdit;
    private bool _canDelete;
    private bool _isLoading = false;

    private string _searchTerm = "";
    private string _sortField = "name";
    private FsSortHeader.SortDirection _sortDir = FsSortHeader.SortDirection.Desc;

    private void OnSortChanged((string field, FsSortHeader.SortDirection dir) s)
    {
        _sortField = s.field;
        _sortDir = s.dir;
    }

    private IEnumerable<EmployeeDto> _sortedEmployees
        => ApplySort(_filteredEmployees ?? Enumerable.Empty<EmployeeDto>());

    private IEnumerable<EmployeeDto> ApplySort(IEnumerable<EmployeeDto> q)
    {
        return (_sortField, _sortDir) switch
        {
            ("name", FsSortHeader.SortDirection.Asc) => q.OrderBy(x => x.FullName),
            ("name", FsSortHeader.SortDirection.Desc) => q.OrderByDescending(x => x.FullName),

            ("email", FsSortHeader.SortDirection.Asc) => q.OrderBy(x => x.Email),
            ("email", FsSortHeader.SortDirection.Desc) => q.OrderByDescending(x => x.Email),

            ("position", FsSortHeader.SortDirection.Asc) => q.OrderBy(x => x.Position),
            ("position", FsSortHeader.SortDirection.Desc) => q.OrderByDescending(x => x.Position),

            ("department", FsSortHeader.SortDirection.Asc) => q.OrderBy(x => x.Department),
            ("department", FsSortHeader.SortDirection.Desc) => q.OrderByDescending(x => x.Department),

            ("role", FsSortHeader.SortDirection.Asc) => q.OrderBy(x => x.RoleName),
            ("role", FsSortHeader.SortDirection.Desc) => q.OrderByDescending(x => x.RoleName),

            ("status", FsSortHeader.SortDirection.Asc) => q.OrderBy(x => x.IsActive),
            ("status", FsSortHeader.SortDirection.Desc) => q.OrderByDescending(x => x.IsActive),

            _ => q.OrderByDescending(x => x.FullName),
        };
    }


    protected override async Task OnInitializedAsync()
    {
        var canView = await PermissionService.HasPermissionAsync("employees.view");

        if (!canView)
        {
            Console.WriteLine("⛔ Sin permiso employees.view → redirigiendo");
            _checkingAccess = false;
            _hasAccess = false;
            NavigationManager.NavigateTo("/dashboard", forceLoad: true);
            return;
        }

        _hasAccess = true;
        _checkingAccess = false;

        _canCreate = await PermissionService.HasPermissionAsync("employees.create");
        _canEdit = await PermissionService.HasPermissionAsync("employees.edit");
        _canDelete = await PermissionService.HasPermissionAsync("employees.delete");

        await LoadEmployees();
    }

    private async Task LoadEmployees()
    {
        _isLoading = true;
        try
        {
            _employees = await EmployeeApiService.GetEmployeesAsync();
            _filteredEmployees = _employees;
            StateHasChanged();
        }
        catch (Exception e)
        {
            Console.WriteLine(e);
            ShowNotification("Error", "No se pudo cargar la lista de empleados.", NotificationSeverity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void FilterEmployees()
    {
        if (_employees == null) return;

        IEnumerable<EmployeeDto> query = _employees;

        // 🔎 Filtro por búsqueda
        if (!string.IsNullOrWhiteSpace(_searchTerm))
        {
            query = query.Where(e =>
                e.FullName.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
                e.Email.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
                e.RFC.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
                e.Position.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
                e.Department.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase));
        }

        // 🔘 Filtro por estado
        if (_statusFilter == "Activos")
            query = query.Where(e => e.IsActive);
        else if (_statusFilter == "Inactivos")
            query = query.Where(e => !e.IsActive);

        _filteredEmployees = query.ToList();
    }


    private async Task ShowCreateModal()
    {
        var result = await DialogService.OpenAsync<EmployeeForm>("Crear Empleado",
            options: new DialogOptions { Width = "800px", Resizable = false, Draggable = false });
        if (result == true) await LoadEmployees();
    }

    private async Task ShowEditModal(int? employeeId)
    {
        var parameters = new Dictionary<string, object> { { "EmployeeId", employeeId } };
        var result = await DialogService.OpenAsync<EmployeeForm>("Editar Empleado", parameters,
            options: new DialogOptions { Width = "800px", Resizable = false, Draggable = false });
        if (result == true) await LoadEmployees();
    }

    private async Task DeleteEmployee(int? employeeId, string employeeName)
    {
        var confirmed = await DialogService.Confirm(
            $"¿Estás seguro de que quieres eliminar a {employeeName}? Esto también eliminará su usuario asociado.",
            "Confirmar Eliminación",
            new ConfirmOptions { OkButtonText = "Sí, Eliminar", CancelButtonText = "Cancelar" });

        if (confirmed == true)
        {
            try
            {
                var (success, errorMessage) = await EmployeeApiService.DeleteEmployeeAsync(employeeId.Value);
                if (success)
                {
                    ShowNotification("Éxito", "Empleado eliminado correctamente.", NotificationSeverity.Success);
                    await LoadEmployees();
                }
                else
                {
                    ShowNotification("Error", errorMessage ?? "No se pudo eliminar.", NotificationSeverity.Error);
                }
            }
            catch (Exception ex)
            {
                ShowNotification("Error Grave", ex.Message, NotificationSeverity.Error);
            }
        }
    }
    private void OnStatusFilterChanged(ChangeEventArgs e)
    {
        _statusFilter = e.Value?.ToString() ?? "Todos";
        FilterEmployees();
    }

    private async Task ToggleEmployeeStatus(EmployeeDto employee)
    {
        try
        {
            var (success, errorMessage) =
                await EmployeeApiService.ToggleEmployeeStatusAsync(employee.Id!.Value);

            if (success)
            {
                ShowNotification("Éxito", "Estado actualizado correctamente.", NotificationSeverity.Success);
                await LoadEmployees();
            }
            else
            {
                ShowNotification("Error", errorMessage ?? "No se pudo actualizar.", NotificationSeverity.Error);
            }
        }
        catch (Exception ex)
        {
            ShowNotification("Error", ex.Message, NotificationSeverity.Error);
        }
    }


    private void ShowNotification(string title, string message, NotificationSeverity severity) =>
        NotificationService.Notify(new NotificationMessage
        {
            Severity = severity,
            Summary = title,
            Detail = message,
            Duration = 4000
        });
}