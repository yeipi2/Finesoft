@page "/empleados"
@using fs_front.DTO
@using fs_front.Services
@using fs_front.Repositories
@using fs_front.Components.Employees.Index
@using fs_front.Components.Employees.Form
@inject IEmployeeApiService EmployeeApiService
@inject DialogService DialogService
@inject NotificationService NotificationService
@inject PermissionService PermissionService
@inject NavigationManager NavigationManager

@attribute [Authorize]

<PageTitle>Finesoft - Empleados</PageTitle>

@if (_checkingAccess)
{
    <div style="position:fixed;top:0;left:0;width:100vw;height:100vh;
            background:white;z-index:9999;
            display:flex;align-items:center;justify-content:center;">
        <div class="spinner-border text-primary" role="status"></div>
    </div>
}
else if (!_hasAccess)
{
    <div></div>
}
else
{
    <container class="container p-4">

        <section class="container-fluid px-xl-5">
            <EmployeesHeader CanCreate="_canCreate"
                             OnCreateClicked="ShowCreateModal" />

            <FilterBar Class="mb-4"
                       SearchPlaceholder="Buscar empleados..."
                       SearchValue="@_searchTerm"
                       SearchValueChanged="@(v => { _searchTerm = v; FilterEmployees(); })"
                       OnClear="ClearFilters">
                <Filters>
                    <select class="form-select" @bind="_statusFilter" @bind:event="onchange" @bind:after="FilterEmployees">
                        <option value="Todos">Estados</option>
                        <option value="Activos">Activos</option>
                        <option value="Inactivos">Inactivos</option>
                    </select>
                </Filters>
            </FilterBar>
        </section>

        <section class="container-fluid p-xl-5">
            <EmployeesTable Items="_sortedEmployees"
                            IsLoading="_isLoading"
                            CanEdit="_canEdit"
                            SortField="_sortField"
                            SortDir="_sortDir"
                            SortChanged="OnSortChanged"
                            OnEditClicked="ShowEditModal"
                            OnToggleStatusClicked="ToggleEmployeeStatus"
                            EmptyTitle="@(_employees == null || !_employees.Any() ? "No hay empleados registrados" : "No se encontraron empleados")" />
        </section>

    </container>
}

@code {
    private List<EmployeeDto>? _employees = new();
    private List<EmployeeDto>? _filteredEmployees = new();
    private string _statusFilter = "Todos";

    private bool _checkingAccess = true;
    private bool _hasAccess = false;
    private bool _canCreate;
    private bool _canEdit;
    private bool _isLoading = false;

    private string _searchTerm = "";
    private string _sortField = "name";
    private FsSortHeader.SortDirection _sortDir = FsSortHeader.SortDirection.Desc;

    private void OnSortChanged((string field, FsSortHeader.SortDirection dir) s)
    {
        _sortField = s.field;
        _sortDir = s.dir;
    }

    private IEnumerable<EmployeeDto> _sortedEmployees
        => ApplySort(_filteredEmployees ?? Enumerable.Empty<EmployeeDto>());

    private IEnumerable<EmployeeDto> ApplySort(IEnumerable<EmployeeDto> q) =>
        (_sortField, _sortDir) switch
        {
            ("name", FsSortHeader.SortDirection.Asc) => q.OrderBy(x => x.FullName),
            ("name", FsSortHeader.SortDirection.Desc) => q.OrderByDescending(x => x.FullName),
            ("email", FsSortHeader.SortDirection.Asc) => q.OrderBy(x => x.Email),
            ("email", FsSortHeader.SortDirection.Desc) => q.OrderByDescending(x => x.Email),
            ("position", FsSortHeader.SortDirection.Asc) => q.OrderBy(x => x.Position),
            ("position", FsSortHeader.SortDirection.Desc) => q.OrderByDescending(x => x.Position),
            ("department", FsSortHeader.SortDirection.Asc) => q.OrderBy(x => x.Department),
            ("department", FsSortHeader.SortDirection.Desc) => q.OrderByDescending(x => x.Department),
            ("role", FsSortHeader.SortDirection.Asc) => q.OrderBy(x => x.RoleName),
            ("role", FsSortHeader.SortDirection.Desc) => q.OrderByDescending(x => x.RoleName),
            ("status", FsSortHeader.SortDirection.Asc) => q.OrderBy(x => x.IsActive),
            ("status", FsSortHeader.SortDirection.Desc) => q.OrderByDescending(x => x.IsActive),
            _ => q.OrderByDescending(x => x.FullName),
        };

    protected override async Task OnInitializedAsync()
    {
        var canView = await PermissionService.HasPermissionAsync("employees.view");

        if (!canView)
        {
            _checkingAccess = false;
            _hasAccess = false;
            NavigationManager.NavigateTo("/dashboard", forceLoad: true);
            return;
        }

        _hasAccess = true;
        _checkingAccess = false;

        _canCreate = await PermissionService.HasPermissionAsync("employees.create");
        _canEdit = await PermissionService.HasPermissionAsync("employees.edit");

        await LoadEmployees();
    }

    private async Task LoadEmployees()
    {
        _isLoading = true;
        try
        {
            _employees = await EmployeeApiService.GetEmployeesAsync();
            _filteredEmployees = _employees;
            StateHasChanged();
        }
        catch (Exception e)
        {
            Console.WriteLine(e);
            ShowNotification("Error", "No se pudo cargar la lista de empleados.", NotificationSeverity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void FilterEmployees()
    {
        if (_employees == null) return;

        IEnumerable<EmployeeDto> query = _employees;

        if (!string.IsNullOrWhiteSpace(_searchTerm))
        {
            query = query.Where(e =>
                e.FullName.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
                e.Email.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
                e.Position.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
                e.Department.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase));
        }

        if (_statusFilter == "Activos") query = query.Where(e => e.IsActive);
        else if (_statusFilter == "Inactivos") query = query.Where(e => !e.IsActive);

        _filteredEmployees = query.ToList();
    }

    private async Task ShowCreateModal()
    {
        var result = await DialogService.OpenAsync<EmployeeForm>("Crear Empleado",
            options: new DialogOptions { Width = "800px", Resizable = false, Draggable = false });
        if (result == true) await LoadEmployees();
    }

    private async Task ShowEditModal(int? employeeId)
    {
        var parameters = new Dictionary<string, object> { { "EmployeeId", employeeId } };
        var result = await DialogService.OpenAsync<EmployeeForm>("Editar Empleado", parameters,
            options: new DialogOptions { Width = "800px", Resizable = false, Draggable = false });
        if (result == true) await LoadEmployees();
    }

    private async Task ToggleEmployeeStatus(EmployeeDto employee)
    {
        try
        {
            var (success, errorMessage) = await EmployeeApiService.ToggleEmployeeStatusAsync(employee.Id!.Value);
            if (success)
            {
                ShowNotification("Éxito", "Estado actualizado correctamente.", NotificationSeverity.Success);
                await LoadEmployees();
            }
            else
            {
                ShowNotification("Error", errorMessage ?? "No se pudo actualizar.", NotificationSeverity.Error);
            }
        }
        catch (Exception ex)
        {
            ShowNotification("Error", ex.Message, NotificationSeverity.Error);
        }
    }

    private void ClearFilters()
    {
        _searchTerm = string.Empty;
        _statusFilter = "Todos";
        FilterEmployees();
    }

    private void ShowNotification(string title, string message, NotificationSeverity severity) =>
        NotificationService.Notify(new NotificationMessage
        {
            Severity = severity,
            Summary = title,
            Detail = message,
            Duration = 4000
        });
}
