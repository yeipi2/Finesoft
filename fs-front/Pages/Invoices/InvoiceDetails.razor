@page "/facturas/{InvoiceId:int}"
@using fs_front.DTO
@using fs_front.Services
@using Radzen

<PageTitle>Factura @_invoice?.InvoiceNumber</PageTitle>

<div class="container p-4">
    @if (_isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 text-muted">Cargando factura...</p>
        </div>
    }
    else if (_invoice != null)
    {
        <div class="row mb-4">
            <div class="col">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="/facturas">Facturas</a>
                        </li>
                        <li class="breadcrumb-item active">@_invoice.InvoiceNumber</li>
                    </ol>
                </nav>

                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h1 class="display-6 fw-bold mb-2">@_invoice.InvoiceNumber</h1>
                        <div class="d-flex gap-2 mb-2">
                            <span class="badge @StatusClass fs-6">@GetStatusLabel(_invoice.Status)</span>
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        @if (_invoice.Status is not ("Cancelada" or "Pagada"))
                        {
                            @* Registrar pago solo si Pendiente *@
                            @if (_invoice.Status == "Pendiente")
                            {
                                <button class="btn btn-success" @onclick="OpenAddPaymentDialog">
                                    <i class="bi bi-cash-coin"></i> Registrar Pago
                                </button>
                            }

                            <button class="btn btn-outline-secondary" @onclick="OpenChangeStatusDialog">
                                <i class="bi bi-arrow-repeat"></i> Cambiar estado
                            </button>

                            <button class="btn btn-warning" @onclick="() => OpenEditDialog(_invoice.Id)">
                                <i class="bi bi-pencil-fill"></i> Editar
                            </button>
                        }

                        <button class="btn btn-primary" @onclick="DownloadPdf">
                            <i class="bi bi-file-earmark-pdf-fill"></i> Descargar PDF
                        </button>

                    </div>
                </div>
            </div>
        </div>

        @if (_invoice.Status == "Cancelada")
        {
            <div class="card border-secondary mb-4">
                <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0"><i class="bi bi-x-circle-fill"></i> Factura cancelada</h6>
                </div>
                <div class="card-body">
                    @if (_invoice.CancelledDate.HasValue)
                    {
                        <div class="mb-2">
                            <small class="text-muted">Fecha de cancelación</small>
                            <div class="fw-bold">@_invoice.CancelledDate.Value.ToString("dd/MM/yyyy")</div>
                        </div>
                    }
                    <div>
                        <small class="text-muted">Motivo</small>
                        <div class="fw-bold">@(_invoice.CancellationReason ?? "Sin motivo registrado")</div>
                    </div>
                </div>
            </div>
        }

        <div class="row">
            <!-- Columna Principal -->
            <div class="col-lg-8">
                <!-- Información del Cliente -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-building"></i> Información del Cliente</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Cliente:</strong> @_invoice.ClientName</p>
                                <p><strong>Email:</strong> @_invoice.ClientEmail</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>RFC:</strong> @_invoice.ClientRFC</p>
                                <p><strong>Creado por:</strong> @_invoice.CreatedByUserName</p>
                            </div>
                        </div>
                    </div>
                </div>

                @* Tickets Asociados *@
                @if (TicketsWithDetails.Any())
                {
                    <div class="card mb-4 border-info">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-ticket-perforated-fill"></i>
                                Tickets Asociados (@TicketsWithDetails.Count)
                            </h5>
                        </div>
                        <div class="card-body">
                            @foreach (var item in TicketsWithDetails)
                            {
                                <div class="card mb-2 shadow-sm">
                                    <div class="card-body p-3">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <h6 class="mb-2">
                                                    <span class="badge bg-info me-2">#@item.TicketId</span>
                                                    <strong>@item.TicketTitle</strong>
                                                </h6>
                                                @if (!string.IsNullOrEmpty(item.TicketDescription))
                                                {
                                                    <p class="text-muted small mb-2">
                                                        @(item.TicketDescription.Length > 150
                                                            ? item.TicketDescription.Substring(0, 150) + "..."
                                                            : item.TicketDescription)
                                                    </p>
                                                }
                                                <div class="row small">
                                                    <div class="col-md-4">
                                                        <i class="bi bi-building text-muted"></i>
                                                        <strong>Cliente:</strong> @item.TicketClientName
                                                    </div>
                                                    <div class="col-md-4">
                                                        <i class="bi bi-folder text-muted"></i>
                                                        <strong>Proyecto:</strong> @item.TicketProjectName
                                                    </div>
                                                    <div class="col-md-4">
                                                        <i class="bi bi-clock text-muted"></i>
                                                        <strong>Horas:</strong> @item.TicketActualHours?.ToString("0.0") h
                                                    </div>
                                                </div>
                                            </div>
                                            <a href="/tickets/@item.TicketId" class="btn btn-sm btn-outline-info" target="_blank">
                                                <i class="bi bi-box-arrow-up-right"></i> Ver Ticket
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }

                <!-- Artículos de la Factura -->
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-list-ul"></i> Artículos de la Factura</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Descripción</th>
                                        <th class="text-center">Cantidad</th>
                                        <th class="text-end">Precio Unit.</th>
                                        <th class="text-end">Subtotal</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in _invoice.Items)
                                    {
                                        <tr>
                                            <td>
                                                <div>@item.Description</div>
                                                @if (!string.IsNullOrEmpty(item.ServiceName))
                                                {
                                                    <small class="text-muted">
                                                        <i class="bi bi-gear"></i> @item.ServiceName
                                                    </small>
                                                }
                                                @if (item.TicketId.HasValue && item.TicketId.Value > 0)
                                                {
                                                    <br />
                                                    <small class="text-info">
                                                        <i class="bi bi-ticket-perforated"></i>
                                                        Ticket #@item.TicketId: @item.TicketTitle
                                                    </small>
                                                }
                                            </td>
                                            <td class="text-center">@item.Quantity</td>
                                            <td class="text-end">@item.UnitPrice.ToString("C")</td>
                                            <td class="text-end fw-bold">@item.Subtotal.ToString("C")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                        <div class="row mt-3">
                            <div class="col-md-8"></div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>Subtotal:</span>
                                            <strong>@_invoice.Subtotal.ToString("C")</strong>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>IVA (16%):</span>
                                            <strong>@_invoice.Tax.ToString("C")</strong>
                                        </div>
                                        <hr />
                                        <div class="d-flex justify-content-between">
                                            <span class="h5">Total:</span>
                                            <strong class="h5 text-success">@_invoice.Total.ToString("C")</strong>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Historial de Pagos -->
                @if (_invoice.Payments.Any())
                {
                    <div class="card mb-4">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0"><i class="bi bi-cash-stack"></i> Historial de Pagos</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Método</th>
                                            <th>Referencia</th>
                                            <th class="text-end">Monto</th>
                                            <th>Registrado por</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var payment in _invoice.Payments)
                                        {
                                            <tr>
                                                <td>@payment.PaymentDate.ToString("dd/MM/yyyy")</td>
                                                <td>@payment.PaymentMethod</td>
                                                <td>@payment.Reference</td>
                                                <td class="text-end"><strong
                                                    class="text-success">@payment.Amount.ToString("C")</strong></td>
                                                    <td>@payment.RecordedByUserName</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    }

                    <!-- Notas -->
                    @if (!string.IsNullOrEmpty(_invoice.Notes))
                    {
                        <div class="card">
                            <div class="card-header bg-warning">
                                <h6 class="mb-0"><i class="bi bi-sticky"></i> Notas Adicionales</h6>
                            </div>
                            <div class="card-body">
                                <p class="mb-0">@_invoice.Notes</p>
                            </div>
                        </div>
                    }
                </div>

                <!-- Sidebar Derecha -->
                <div class="col-lg-4">
                    <!-- Detalles -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-info-circle"></i> Detalles</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <small class="text-muted">Número de Factura</small>
                                <div class="fw-bold">@_invoice.InvoiceNumber</div>
                            </div>
                            <div class="mb-3">
                                <small class="text-muted">Tipo</small>
                                <div>
                                    <span class="badge @(_invoice.InvoiceType == "Monthly" ? "bg-info" : "bg-secondary")">
                                        @(_invoice.InvoiceType == "Monthly" ? "Mensual" : "Evento")
                                    </span>
                                </div>
                            </div>
                            <div class="mb-3">
                                <small class="text-muted">Fecha de Emisión</small>
                                <div>@_invoice.InvoiceDate.ToString("dd/MM/yyyy")</div>
                            </div>
                            @if (_invoice.DueDate.HasValue)
                            {
                                <div class="mb-3">
                                    <small class="text-muted">Fecha de Vencimiento</small>
                                    <div>@_invoice.DueDate.Value.ToString("dd/MM/yyyy")</div>
                                </div>
                            }
                            @if (!string.IsNullOrEmpty(_invoice.PaymentMethod))
                            {
                                <div class="mb-3">
                                    <small class="text-muted">Método de Pago</small>
                                    <div>@_invoice.PaymentMethod</div>
                                </div>
                            }
                            <div class="mb-3">
                                <small class="text-muted">Estado</small>
                                <div>
                                    <span class="badge @StatusClass">@GetStatusLabel(_invoice.Status)</span>
                                </div>
                            </div>
                            <div>
                                <small class="text-muted">Creado Por</small>
                                <div>@_invoice.CreatedByUserName</div>
                            </div>
                        </div>
                    </div>

                    <!-- Resumen Financiero -->
                    <div class="card mb-4">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0"><i class="bi bi-calculator"></i> Resumen Financiero</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-2">
                                <small class="text-muted">Número de Artículos</small>
                                <div class="fw-bold">@_invoice.Items.Count</div>
                            </div>
                            @if (TicketsWithDetails.Any())
                            {
                                <div class="mb-2">
                                    <small class="text-muted">Tickets Asociados</small>
                                    <div class="fw-bold text-info">@TicketsWithDetails.Count</div>
                                </div>
                                @if (TotalHours > 0)
                                {
                                    <div class="mb-2">
                                        <small class="text-muted">Total Horas</small>
                                        <div class="fw-bold">@TotalHours.ToString("0.0") h</div>
                                    </div>
                                }
                            }
                            <div class="mb-2">
                                <small class="text-muted">Subtotal</small>
                                <div class="fw-bold">@_invoice.Subtotal.ToString("C")</div>
                            </div>
                            <div class="mb-2">
                                <small class="text-muted">IVA (16%)</small>
                                <div class="fw-bold">@_invoice.Tax.ToString("C")</div>
                            </div>
                            <hr />
                            <div class="mb-2">
                                <small class="text-muted">Total</small>
                                <div class="h4 text-success mb-0">@_invoice.Total.ToString("C")</div>
                            </div>
                            @if (_invoice.PaidAmount > 0)
                            {
                                <div class="mb-2">
                                    <small class="text-muted">Pagado</small>
                                    <div class="h5 text-success mb-0">@_invoice.PaidAmount.ToString("C")</div>
                                </div>
                            }
                            @if (_invoice.Balance > 0)
                            {
                                <div>
                                    <small class="text-muted">Saldo Pendiente</small>
                                    <div class="h5 text-warning mb-0">@_invoice.Balance.ToString("C")</div>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Estado de Pago -->
                    @if (_invoice.Status == "Pagada")
                    {
                        <div class="card border-success">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="bi bi-check-circle-fill"></i> Pagada</h6>
                            </div>
                            <div class="card-body text-center">
                                <i class="bi bi-check-circle fs-1 text-success mb-3"></i>
                                <p class="mb-0">Esta factura ha sido pagada completamente.</p>
                                @if (_invoice.PaidDate.HasValue)
                                {
                                    <small class="text-muted">Fecha de pago: @_invoice.PaidDate.Value.ToString("dd/MM/yyyy")</small>
                                }
                            </div>
                        </div>
                    }
                    else if (_invoice.Status == "Pendiente" && _invoice.Balance > 0)
                    {
                        <div class="card border-warning">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0"><i class="bi bi-exclamation-triangle-fill"></i> Pendiente de Pago</h6>
                            </div>
                            <div class="card-body text-center">
                                <i class="bi bi-clock-history fs-1 text-warning mb-3"></i>
                                <p class="mb-3">Saldo pendiente: <strong>@_invoice.Balance.ToString("C")</strong></p>
                                <button class="btn btn-success w-100" @onclick="OpenAddPaymentDialog">
                                    <i class="bi bi-cash-coin"></i> Registrar Pago
                                </button>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <div class="row mt-4">
                <div class="col">
                    <button class="btn btn-secondary" @onclick="GoBack">
                        <i class="bi bi-arrow-left"></i> Volver a Facturas
                    </button>
                </div>
            </div>
        }
    else
        {
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i>
                Factura no encontrada.
            </div>
        }
    </div>

@inject IInvoiceApiService InvoiceApiService
@inject DialogService DialogService
@inject NotificationService NotificationService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

@code {
    [Parameter] public int InvoiceId { get; set; }

    private InvoiceDetailDto? _invoice;
    private bool _isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadInvoiceDetails();
    }

    private async Task LoadInvoiceDetails()
    {
        _isLoading = true;
        try
        {
            _invoice = await InvoiceApiService.GetInvoiceByIdAsync(InvoiceId);
        }
        catch (Exception ex)
        {
            ShowNotification("Error", $"Error al cargar detalles: {ex.Message}", NotificationSeverity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task OpenAddPaymentDialog()
    {
        ShowNotification("Info", "Funcionalidad de pago en desarrollo", NotificationSeverity.Info);
    }

    private async Task OpenEditDialog(int invoiceId)
    {
        var options = new DialogOptions
        {
            Width = "1000px",
            Resizable = true,
            Draggable = false,
            CloseDialogOnOverlayClick = false
        };

        var result = await DialogService.OpenAsync<InvoiceForm>("Editar Factura",
            new Dictionary<string, object> { { "InvoiceId", invoiceId } },
            options);

        if (result == true)
        {
            await LoadInvoiceDetails();
        }
    }

    private async Task DownloadPdf()
    {
        try
        {
            var pdfBytes = await InvoiceApiService.GenerateInvoicePdfAsync(InvoiceId);
            if (pdfBytes != null)
            {
                var base64 = Convert.ToBase64String(pdfBytes);
                await JSRuntime.InvokeVoidAsync("downloadFile", $"Factura-{InvoiceId}.pdf", base64);
                ShowNotification("Éxito", "PDF descargado correctamente", NotificationSeverity.Success);
            }
        }
        catch (Exception ex)
        {
            ShowNotification("Error", $"Error al descargar PDF: {ex.Message}", NotificationSeverity.Error);
        }
    }

    private void GoBack()
    {
        NavigationManager.NavigateTo("/facturas");
    }

    private string GetStatusLabel(string status)
    {
        return status switch
        {
            "Pagada" => "Pagada",
            "Pendiente" => "Pendiente",
            "Vencida" => "Vencida",
            "Cancelada" => "Cancelada",
            _ => status
        };
    }

    private void ShowNotification(string title, string message, NotificationSeverity severity)
    {
        NotificationService.Notify(new NotificationMessage
        {
            Severity = severity,
            Summary = title,
            Detail = message,
            Duration = 4000
        });
    }

    private async Task OpenChangeStatusDialog()
    {
        if (_invoice == null) return;

        var result = await DialogService.OpenAsync<fs_front.Components.Invoices.InvoiceStatusDialog>(
            "Cambiar estado",
            new Dictionary<string, object> { { "CurrentStatus", _invoice.Status } },
            new DialogOptions { Width = "520px" }
        );

        if (result is not ChangeInvoiceStatusRequest req) return;

        if (string.IsNullOrWhiteSpace(req.Status)) return;

        if (req.Status == "Cancelada")
        {
            var confirm = await DialogService.Confirm(
                "¿Seguro que deseas cancelar esta factura? Ya no se podrá modificar.",
                "Confirmar cancelación",
                new ConfirmOptions { OkButtonText = "Sí, cancelar", CancelButtonText = "No" }
            );

            if (confirm != true) return;
        }

        var (success, error) = await InvoiceApiService.ChangeInvoiceStatusAsync(_invoice.Id, req.Status, req.Reason);

        if (success)
        {
            ShowNotification("Éxito", "Estado actualizado", NotificationSeverity.Success);
            await LoadInvoiceDetails();
            StateHasChanged();
        }
        else
        {
            ShowNotification("Error", error ?? "No se pudo actualizar el estado", NotificationSeverity.Error);
        }
    }

    private string StatusClass => _invoice?.Status switch
    {
        "Pagada" => "bg-success",
        "Pendiente" => "bg-warning",
        "Vencida" => "bg-danger",
        "Cancelada" => "bg-secondary",
        _ => "bg-secondary"
    };

    private List<InvoiceItemDetailDto> TicketsWithDetails => _invoice?.Items
        ?.Where(i => i.TicketId.HasValue && i.TicketId.Value > 0)
        .ToList() ?? new List<InvoiceItemDetailDto>();

    private decimal TotalHours => TicketsWithDetails
        .Where(t => t.TicketActualHours.HasValue)
        .Sum(t => t.TicketActualHours ?? 0m);
}