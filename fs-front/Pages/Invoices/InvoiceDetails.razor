@page "/facturas/{InvoiceId:int}"
@using fs_front.DTO
@using fs_front.Repositories
@using fs_front.Components.Invoices.Details
@using Radzen
@attribute [Authorize]

<PageTitle>Factura @_invoice?.InvoiceNumber</PageTitle>

@if (_isLoading)
{
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2 text-muted">Cargando factura...</p>
    </div>
}
else if (_invoice == null)
{
    <div class="container p-4">
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i> Factura no encontrada.
        </div>
    </div>
}
else
{
    <div class="container-fluid px-4 py-4">

        @* ── Action Bar (breadcrumb + título + botones) ── *@
        <div class="mb-4">
            <InvoiceActionBar Invoice="@_invoice"
                              OnRegisterPayment="OpenAddPaymentDialog"
                              OnChangeStatus="OpenChangeStatusDialog"
                              OnEdit="() => OpenEditDialog(_invoice.Id)"
                              OnDownloadPdf="DownloadPdf"
                              OnGoBack="GoBack" />
        </div>

        @* ── Card de cancelación (solo si aplica) ── *@
        <InvoiceCancelledCard Invoice="@_invoice" />

        @* ── Layout principal ── *@
        <div class="row">

            @* ── Columna principal ── *@
            <div class="col-lg-8">
                <InvoiceClientCard Invoice="@_invoice" />
                <InvoiceTicketsCard TicketsWithDetails="@TicketsWithDetails" />
                <InvoiceItemsCard Invoice="@_invoice" />
                <InvoicePaymentsCard Payments="@(_invoice.Payments ?? new())"
                                     ApiBaseUrl="@ApiBaseUrl" />
                <InvoiceNotesCard Notes="@_invoice.Notes" />
            </div>

            @* ── Sidebar ── *@
            <div class="col-lg-4">
                <InvoiceSidebarCards Invoice="@_invoice"
                                     TicketsCount="@TicketsWithDetails.Count"
                                     TotalHours="@TotalHours"
                                     OnRegisterPayment="OpenAddPaymentDialog" />
            </div>

        </div>
    </div>
}

@inject IInvoiceApiService InvoiceApiService
@inject DialogService DialogService
@inject NotificationService NotificationService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject HttpClient Http

@code {
    [Parameter] public int InvoiceId { get; set; }

    private InvoiceDetailDto? _invoice;
    private bool _isLoading = true;
    private string ApiBaseUrl => Http.BaseAddress?.ToString().TrimEnd('/') ?? "";

    // ────────────────────────────────
    //  Lifecycle
    // ────────────────────────────────

    protected override async Task OnInitializedAsync() => await LoadInvoice();

    private async Task LoadInvoice()
    {
        _isLoading = true;
        try
        {
            _invoice = await InvoiceApiService.GetInvoiceByIdAsync(InvoiceId);
        }
        catch (Exception ex)
        {
            Notify("Error", $"Error al cargar detalles: {ex.Message}", NotificationSeverity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    // ────────────────────────────────
    //  Computed
    // ────────────────────────────────

    private List<InvoiceItemDetailDto> TicketsWithDetails =>
        _invoice?.Items
            ?.Where(i => i.TicketId.HasValue && i.TicketId.Value > 0)
            .ToList() ?? new();

    private decimal TotalHours =>
        TicketsWithDetails
            .Where(t => t.TicketActualHours.HasValue)
            .Sum(t => t.TicketActualHours ?? 0m);

    // ────────────────────────────────
    //  Dialog / Actions
    // ────────────────────────────────

    private async Task OpenAddPaymentDialog()
    {
        if (_invoice == null) return;

        var result = await DialogService.OpenAsync<fs_front.Components.Invoices.InvoicePaymentDialog>(
            "Registrar Pago",
            new Dictionary<string, object>
            {
                { "InvoiceId",            _invoice.Id },
                { "PaymentType",          _invoice.PaymentType   ?? "" },
                { "InvoicePaymentMethod", _invoice.PaymentMethod ?? "" },
                { "InvoiceTotal",         _invoice.Total },
                { "InvoiceBalance",       _invoice.Balance }
            },
            new DialogOptions
            {
                Width = "640px",
                CloseDialogOnOverlayClick = false,
                Draggable = false
            });

        if (result == true)
        {
            await LoadInvoice();
            StateHasChanged();
        }
    }

    private async Task OpenEditDialog(int invoiceId)
    {
        var result = await DialogService.OpenAsync<fs_front.Pages.Invoices.InvoiceForm>(
            "Editar Factura",
            new Dictionary<string, object> { { "InvoiceId", invoiceId } },
            new DialogOptions
            {
                Width = "1000px",
                Resizable = true,
                Draggable = false,
                CloseDialogOnOverlayClick = false
            });

        if (result == true) await LoadInvoice();
    }

    private async Task OpenChangeStatusDialog()
    {
        if (_invoice == null) return;

        var result = await DialogService.OpenAsync<fs_front.Components.Invoices.InvoiceStatusDialog>(
            "Cambiar estado",
            new Dictionary<string, object> { { "CurrentStatus", _invoice.Status } },
            new DialogOptions { Width = "520px" });

        if (result is not ChangeInvoiceStatusRequest req) return;
        if (string.IsNullOrWhiteSpace(req.Status)) return;

        if (req.Status == "Cancelada")
        {
            var confirm = await DialogService.Confirm(
                "¿Seguro que deseas cancelar esta factura? Ya no se podrá modificar.",
                "Confirmar cancelación",
                new ConfirmOptions { OkButtonText = "Sí, cancelar", CancelButtonText = "No" });
            if (confirm != true) return;
        }

        var (success, error) = await InvoiceApiService.ChangeInvoiceStatusAsync(
            _invoice.Id, req.Status, req.Reason);

        if (success)
        {
            Notify("Éxito", "Estado actualizado", NotificationSeverity.Success);
            await LoadInvoice();
            StateHasChanged();
        }
        else
        {
            Notify("Error", error ?? "No se pudo actualizar el estado", NotificationSeverity.Error);
        }
    }

    private async Task DownloadPdf()
    {
        try
        {
            var bytes = await InvoiceApiService.GenerateInvoicePdfAsync(InvoiceId);
            if (bytes != null)
            {
                var b64 = Convert.ToBase64String(bytes);
                await JSRuntime.InvokeVoidAsync("downloadFile", $"Factura-{InvoiceId}.pdf", b64);
                Notify("Éxito", "PDF descargado correctamente", NotificationSeverity.Success);
            }
        }
        catch (Exception ex)
        {
            Notify("Error", $"Error al descargar PDF: {ex.Message}", NotificationSeverity.Error);
        }
    }

    private void GoBack() => NavigationManager.NavigateTo("/facturas");

    private void Notify(string title, string msg, NotificationSeverity sev) =>
        NotificationService.Notify(new NotificationMessage
        {
            Severity = sev,
            Summary = title,
            Detail = msg,
            Duration = 4000
        });
}
