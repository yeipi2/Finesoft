@page "/facturas"
@using fs_front.DTO
@using fs_front.Services
@using Radzen
@using Radzen.Blazor

@attribute [Authorize(Roles = "Admin")]

<PageTitle>Facturación</PageTitle>

<section class="p-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <div class="d-flex align-items-center gap-2">
                <i class="bi bi-receipt fs-3 text-primary"></i>
                <h2 class="mb-0">Facturación</h2>
            </div>
            <p class="text-muted mb-0">Gestión de facturas y cobros</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary" @onclick="GenerateMonthlyInvoices" disabled="@_isGenerating">
                @if (_isGenerating)
                {
                    <span class="spinner-border spinner-border-sm me-2"></span>
                }
                <i class="bi bi-calendar-month"></i>
                Generar Mensuales
            </button>
            <button class="btn btn-primary" @onclick="OpenNewInvoiceDialog">
                <i class="bi bi-plus-lg"></i>
                Nueva Factura
            </button>
        </div>
    </div>

    <!-- Estadísticas -->
    @if (_stats != null)
    {
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="card border-warning shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="text-muted mb-1">Pendientes</h6>
                                <h3 class="mb-0">@_stats.PendingInvoices</h3>
                                <small class="text-muted">@_stats.TotalPending.ToString("C")</small>
                            </div>
                            <div class="bg-warning bg-opacity-10 p-2 rounded">
                                <i class="bi bi-hourglass-split fs-4 text-warning"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card border-success shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="text-muted mb-1">Pagadas</h6>
                                <h3 class="mb-0">@_stats.PaidInvoices</h3>
                                <small class="text-muted">@_stats.TotalPaid.ToString("C")</small>
                            </div>
                            <div class="bg-success bg-opacity-10 p-2 rounded">
                                <i class="bi bi-check-circle fs-4 text-success"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card border-danger shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="text-muted mb-1">Vencidas</h6>
                                <h3 class="mb-0">@_stats.OverdueInvoices</h3>
                                <small class="text-muted">@_stats.TotalOverdue.ToString("C")</small>
                            </div>
                            <div class="bg-danger bg-opacity-10 p-2 rounded">
                                <i class="bi bi-exclamation-triangle fs-4 text-danger"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card border-primary shadow-sm">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="text-muted mb-1">Total Facturado</h6>
                                <h3 class="mb-0">@_stats.TotalInvoices</h3>
                                <small class="text-muted">@_stats.TotalBilled.ToString("C")</small>
                            </div>
                            <div class="bg-primary bg-opacity-10 p-2 rounded">
                                <i class="bi bi-wallet2 fs-4 text-primary"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <input type="text" class="form-control" placeholder="Buscar facturas..."
                           @bind="_searchTerm" @bind:event="oninput" @bind:after="FilterInvoices" />
                </div>
                <div class="col-md-3">
                    <select class="form-select" @bind="_selectedStatus" @bind:after="FilterInvoices">
                        <option value="">Todos los estados</option>
                        <option value="Pendiente">Pendiente</option>
                        <option value="Pagada">Pagada</option>
                        <option value="Vencida">Vencida</option>
                        <option value="Cancelada">Cancelada</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <select class="form-select" @bind="_selectedType" @bind:after="FilterInvoices">
                        <option value="">Todos los tipos</option>
                        <option value="Event">Evento</option>
                        <option value="Monthly">Mensual</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" @bind="_selectedClientId" @bind:after="FilterInvoices">
                        <option value="0">Todos los clientes</option>
                        @if (_clients != null)
                        {
                            @foreach (var client in _clients)
                            {
                                <option value="@client.Id">@client.CompanyName</option>
                            }
                        }
                    </select>
                </div>
            </div>
            @if (!string.IsNullOrEmpty(_selectedStatus) || !string.IsNullOrEmpty(_selectedType) || _selectedClientId > 0 || !string.IsNullOrEmpty(_searchTerm))
            {
                <div class="mt-2">
                    <button class="btn btn-sm btn-outline-secondary" @onclick="ClearFilters">
                        <i class="bi bi-x-circle"></i>
                        Limpiar
                    </button>
                </div>
            }
        </div>
    </div>

    <!-- Tabla de Facturas -->
    <div class="card">
        <div class="card-body">
            @if (_isLoading)
            {
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-2 text-muted">Cargando facturas...</p>
                </div>
            }
            else if (_filteredInvoices == null || !_filteredInvoices.Any())
            {
                <div class="text-center py-5">
                    <i class="bi bi-inbox fs-1 text-muted"></i>
                    <p class="mt-2 text-muted">No se encontraron facturas</p>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Número</th>
                                <th>Cliente</th>
                                <th>Fecha</th>
                                <th>Vencimiento</th>
                                <th>Tipo</th>
                                <th>Estado</th>
                                <th class="text-end">Total</th>
                                <th class="text-end">Saldo</th>
                                <th class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var invoice in _filteredInvoices)
                            {
                                <tr>
                                    <td>
                                        <strong>@invoice.InvoiceNumber</strong><br />
                                        <small class="text-muted">@invoice.ClientRFC</small>
                                    </td>
                                    <td>@invoice.ClientName</td>
                                    <td>@invoice.InvoiceDate.ToString("dd/MM/yyyy")</td>
                                    <td>
                                        @if (invoice.DueDate.HasValue)
                                        {
                                            @invoice.DueDate.Value.ToString("dd/MM/yyyy")
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td>
                                        <span class="badge @(invoice.InvoiceType == "Monthly" ? "bg-info" : "bg-secondary")">
                                            @(invoice.InvoiceType == "Monthly" ? "Mensual" : "Evento")
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge @GetStatusBadgeClass(invoice.Status)">
                                            @GetStatusLabel(invoice.Status)
                                        </span>
                                    </td>
                                    <td class="text-end">
                                        <strong class="text-success">@invoice.Total.ToString("C")</strong>
                                    </td>
                                    <td class="text-end">
                                        <strong class="@(invoice.Balance > 0 ? "text-danger" : "text-success")">
                                            @invoice.Balance.ToString("C")
                                        </strong>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" @onclick="() => ViewInvoiceDetails(invoice.Id)"
                                                    title="Ver detalles">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-secondary" @onclick="() => OpenEditDialog(invoice.Id)"
                                                    title="Editar">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-outline-success" @onclick="() => DownloadPdf(invoice.Id)"
                                                    title="Descargar PDF">
                                                <i class="bi bi-download"></i>
                                            </button>
                                            <button class="btn btn-outline-danger" @onclick="() => ConfirmDelete(invoice.Id)"
                                                    title="Eliminar">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</section>

@inject IInvoiceApiService InvoiceApiService
@inject IClientApiService ClientApiService
@inject DialogService DialogService
@inject NotificationService NotificationService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

@code {
    private List<InvoiceDetailDto>? _invoices;
    private List<InvoiceDetailDto>? _filteredInvoices;
    private List<ClientDto>? _clients;
    private InvoiceStatsDto? _stats;

    private string _searchTerm = string.Empty;
    private string _selectedStatus = string.Empty;
    private string _selectedType = string.Empty;
    private int _selectedClientId = 0;

    private bool _isLoading = true;
    private bool _isGenerating = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _isLoading = true;
        try
        {
            var invoicesTask = InvoiceApiService.GetInvoicesAsync();
            var statsTask = InvoiceApiService.GetInvoiceStatsAsync();
            var clientsTask = ClientApiService.GetClientsAsync();

            await Task.WhenAll(invoicesTask, statsTask, clientsTask);

            _invoices = await invoicesTask;
            _stats = await statsTask;
            _clients = await clientsTask;

            FilterInvoices();
        }
        catch (Exception ex)
        {
            ShowNotification("Error", $"Error al cargar datos: {ex.Message}", NotificationSeverity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void FilterInvoices()
    {
        if (_invoices == null)
        {
            _filteredInvoices = new List<InvoiceDetailDto>();
            return;
        }

        _filteredInvoices = _invoices
            .Where(i =>
                (string.IsNullOrEmpty(_searchTerm) ||
                 i.InvoiceNumber.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
                 i.ClientName.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
                 i.ClientRFC.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase)) &&
                (string.IsNullOrEmpty(_selectedStatus) || i.Status == _selectedStatus) &&
                (string.IsNullOrEmpty(_selectedType) || i.InvoiceType == _selectedType) &&
                (_selectedClientId == 0 || i.ClientId == _selectedClientId))
            .ToList();
    }

    private void ClearFilters()
    {
        _searchTerm = string.Empty;
        _selectedStatus = string.Empty;
        _selectedType = string.Empty;
        _selectedClientId = 0;
        FilterInvoices();
    }

    private async Task OpenNewInvoiceDialog()
    {
        var options = new DialogOptions
        {
            Width = "900px",
            Height = "80vh",
            Resizable = false,
            Draggable = true
        };

        var result = await DialogService.OpenAsync<InvoiceForm>("Nueva Factura",
            new Dictionary<string, object>(),
            options);

        if (result == true)
        {
            await LoadData();
        }
    }

    private async Task OpenEditDialog(int invoiceId)
    {
        var options = new DialogOptions
        {
            Width = "900px",
            Height = "80vh",
            Resizable = false,
            Draggable = true
        };

        var result = await DialogService.OpenAsync<InvoiceForm>("Editar Factura",
            new Dictionary<string, object> { { "InvoiceId", invoiceId } },
            options);

        if (result == true)
        {
            await LoadData();
        }
    }

    private void ViewInvoiceDetails(int invoiceId)
    {
        NavigationManager.NavigateTo($"/facturas/{invoiceId}");
    }

    private async Task GenerateMonthlyInvoices()
    {
        _isGenerating = true;
        try
        {
            var result = await InvoiceApiService.GenerateMonthlyInvoicesAsync();
            if (result.Success)
            {
                ShowNotification("Éxito", "Facturas mensuales generadas correctamente.", NotificationSeverity.Success);
                await LoadData();
            }
            else
            {
                ShowNotification("Error", result.ErrorMessage ?? "Error al generar facturas", NotificationSeverity.Error);
            }
        }
        catch (Exception ex)
        {
            ShowNotification("Error", $"Error: {ex.Message}", NotificationSeverity.Error);
        }
        finally
        {
            _isGenerating = false;
        }
    }

    private async Task DownloadPdf(int invoiceId)
    {
        try
        {
            var pdfBytes = await InvoiceApiService.GenerateInvoicePdfAsync(invoiceId);
            if (pdfBytes != null)
            {
                var base64 = Convert.ToBase64String(pdfBytes);
                // Usando la función que ya funcionaba
                await JSRuntime.InvokeVoidAsync("downloadFile", $"Factura-{invoiceId}.pdf", base64);
                ShowNotification("Éxito", "PDF descargado correctamente", NotificationSeverity.Success);
            }
        }
        catch (Exception ex)
        {
            ShowNotification("Error", $"Error al descargar PDF: {ex.Message}", NotificationSeverity.Error);
        }
    }

    private async Task ConfirmDelete(int invoiceId)
    {
        var confirmed = await DialogService.Confirm(
            "¿Está seguro de que desea eliminar esta factura?",
            "Confirmar Eliminación",
            new ConfirmOptions { OkButtonText = "Sí, eliminar", CancelButtonText = "Cancelar" }
        );

        if (confirmed == true)
        {
            await DeleteInvoice(invoiceId);
        }
    }

    private async Task DeleteInvoice(int invoiceId)
    {
        try
        {
            var result = await InvoiceApiService.DeleteInvoiceAsync(invoiceId);
            if (result.Success)
            {
                ShowNotification("Éxito", "Factura eliminada correctamente", NotificationSeverity.Success);
                await LoadData();
            }
            else
            {
                ShowNotification("Error", result.ErrorMessage ?? "Error al eliminar", NotificationSeverity.Error);
            }
        }
        catch (Exception ex)
        {
            ShowNotification("Error", $"Error: {ex.Message}", NotificationSeverity.Error);
        }
    }

    private string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Pagada" => "bg-success",
            "Pendiente" => "bg-warning text-dark",
            "Vencida" => "bg-danger",
            "Cancelada" => "bg-secondary",
            _ => "bg-secondary"
        };
    }

    private string GetStatusLabel(string status)
    {
        // Ya está devolviendo el mismo status, esto está correcto
        return status switch
        {
            "Pagada" => "Pagada",
            "Pendiente" => "Pendiente",
            "Vencida" => "Vencida",
            "Cancelada" => "Cancelada",
            _ => status
        };
    }

    private void ShowNotification(string title, string message, NotificationSeverity severity)
    {
        NotificationService.Notify(new NotificationMessage
        {
            Severity = severity,
            Summary = title,
            Detail = message,
            Duration = 4000
        });
    }
}
