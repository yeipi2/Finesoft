@page "/facturas"
@using fs_front.DTO
@using fs_front.Repositories
@using fs_front.Components.Invoices.Index
@using fs_front.Components.Invoices.Shared
@using Radzen
@attribute [Authorize]

<PageTitle>Facturación</PageTitle>

@* ── Estado: verificando acceso ── *@
@if (_checkingAccess)
{
    <div style="position:fixed;top:0;left:0;width:100vw;height:100vh;
                    background:white;z-index:9999;
                    display:flex;align-items:center;justify-content:center;">
        <div class="spinner-border text-primary" role="status"></div>
    </div>
}
else if (!_hasAccess)
{
    <div></div>
}
else
{
    <section class="px-xl-5 py-4">

        @* ── Header ── *@
        <InvoicesHeader CanCreate="@_canCreate"
                        IsGenerating="@_isGenerating"
                        OnNew="OpenNewInvoiceDialog"
                        OnGenerate="GenerateMonthlyInvoices" />

        @* ── Estadísticas ── *@
        @if (_stats != null)
        {
            <StatGrid class="mb-5">
                <StatCard Title="Pendientes"
                          Value="@_stats.PendingInvoices.ToString()"
                          SubValue="@_stats.TotalPending.ToString("C")"
                          Accent="StatCard.StatAccent.Info"
                          IconClass="bi bi-hourglass-split" />

                <StatCard Title="Pagadas"
                          Value="@_stats.PaidInvoices.ToString()"
                          SubValue="@_stats.TotalPaid.ToString("C")"
                          Accent="StatCard.StatAccent.Success"
                          IconClass="bi bi-check-circle" />

                <StatCard Title="Vencidas"
                          Value="@_stats.OverdueInvoices.ToString()"
                          SubValue="@_stats.TotalOverdue.ToString("C")"
                          Accent="StatCard.StatAccent.Danger"
                          IconClass="bi bi-exclamation-triangle" />

                <StatCard Title="Total Facturado"
                          Value="@_stats.TotalInvoices.ToString()"
                          SubValue="@_stats.TotalBilled.ToString("C")"
                          Accent="StatCard.StatAccent.Info"
                          IconClass="bi bi-wallet2" />
            </StatGrid>
        }

        @* ── Filtros ── *@
        <FilterBar Class="mb-5"
                   SearchPlaceholder="Buscar facturas..."
                   SearchValue="@_searchTerm"
                   SearchValueChanged="@(v => { _searchTerm = v; ApplyFilters(); })"
                   OnClear="ClearFilters">
            <Filters>
                <select class="form-select"
                        @bind="_selectedStatus"
                        @bind:event="onchange"
                        @bind:after="ApplyFilters">
                    <option value="">Todos los estados</option>
                    <option value="Pendiente">Pendiente</option>
                    <option value="Pagada">Pagada</option>
                    <option value="Vencida">Vencida</option>
                    <option value="Cancelada">Cancelada</option>
                    <option value="Borrador">Borrador</option>
                </select>

                <select class="form-select"
                        @bind="_selectedType"
                        @bind:event="onchange"
                        @bind:after="ApplyFilters">
                    <option value="">Todos los tipos</option>
                    <option value="Event">Evento</option>
                    <option value="Monthly">Mensual</option>
                </select>
            </Filters>
        </FilterBar>

        @* ── Tabla ── *@
        <div class="card">
            <InvoicesTable Items="@_sortedInvoices"
                           IsLoading="@_isLoading"
                           SortField="@_sortField"
                           SortDir="@_sortDir"
                           OnView="ViewDetails"
                           OnDownloadPdf="DownloadPdf"
                           SortChanged="HandleSortChanged" />
        </div>

    </section>
}

@inject IInvoiceApiService InvoiceApiService
@inject IClientApiService ClientApiService
@inject DialogService DialogService
@inject NotificationService NotificationService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject PermissionService PermissionService

@code {
    // ── Data ──
    private List<InvoiceDetailDto>? _invoices;
    private List<InvoiceDetailDto>? _filtered;
    private InvoiceStatsDto? _stats;

    // ── Filters ──
    private string _searchTerm = "";
    private string _selectedStatus = "";
    private string _selectedType = "";

    // ── Sort ──
    private string _sortField = "date";
    private FsSortHeader.SortDirection _sortDir = FsSortHeader.SortDirection.Desc;

    // ── UI flags ──
    private bool _isLoading = true;
    private bool _isGenerating = false;
    private bool _checkingAccess = true;
    private bool _hasAccess = false;
    private bool _canCreate;
    private bool _canEdit;
    private bool _canDelete;

    // ────────────────────────────────
    //  Lifecycle
    // ────────────────────────────────

    protected override async Task OnInitializedAsync()
    {
        if (!await PermissionService.HasPermissionAsync("invoices.view"))
        {
            _checkingAccess = false;
            _hasAccess = false;
            NavigationManager.NavigateTo("/dashboard", forceLoad: true);
            return;
        }

        _hasAccess = true;
        _checkingAccess = false;

        _canCreate = await PermissionService.HasPermissionAsync("invoices.create");
        _canEdit = await PermissionService.HasPermissionAsync("invoices.edit");
        _canDelete = await PermissionService.HasPermissionAsync("invoices.delete");

        await LoadData();
    }

    private async Task LoadData()
    {
        _isLoading = true;
        try
        {
            var invoicesTask = InvoiceApiService.GetInvoicesAsync();
            var statsTask = InvoiceApiService.GetInvoiceStatsAsync();

            await Task.WhenAll(invoicesTask, statsTask);

            _invoices = await invoicesTask;
            _stats = await statsTask;

            ApplyFilters();
        }
        catch (Exception ex)
        {
            Notify("Error", $"Error al cargar datos: {ex.Message}", NotificationSeverity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    // ────────────────────────────────
    //  Filtering & Sorting
    // ────────────────────────────────

    private void ApplyFilters()
    {
        if (_invoices == null) { _filtered = new(); return; }

        _filtered = _invoices.Where(i =>
            (string.IsNullOrEmpty(_searchTerm) ||
             i.InvoiceNumber.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
             i.ClientName.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ||
             (i.ClientRFC?.Contains(_searchTerm, StringComparison.OrdinalIgnoreCase) ?? false)) &&
            (string.IsNullOrEmpty(_selectedStatus) || i.Status == _selectedStatus) &&
            (string.IsNullOrEmpty(_selectedType) || i.InvoiceType == _selectedType)
        ).ToList();
    }

    private void ClearFilters()
    {
        _searchTerm = "";
        _selectedStatus = "";
        _selectedType = "";
        ApplyFilters();
    }

    private void HandleSortChanged((string field, FsSortHeader.SortDirection dir) s)
    {
        _sortField = s.field;
        _sortDir = s.dir;
    }

    private IEnumerable<InvoiceDetailDto> _sortedInvoices =>
        ApplySort(_filtered ?? Enumerable.Empty<InvoiceDetailDto>());

    private IEnumerable<InvoiceDetailDto> ApplySort(IEnumerable<InvoiceDetailDto> q) =>
        (_sortField, _sortDir) switch
        {
            ("number", FsSortHeader.SortDirection.Asc) => q.OrderBy(x => x.InvoiceNumber),
            ("number", FsSortHeader.SortDirection.Desc) => q.OrderByDescending(x => x.InvoiceNumber),
            ("client", FsSortHeader.SortDirection.Asc) => q.OrderBy(x => x.ClientName),
            ("client", FsSortHeader.SortDirection.Desc) => q.OrderByDescending(x => x.ClientName),
            ("date", FsSortHeader.SortDirection.Asc) => q.OrderBy(x => x.InvoiceDate),
            ("date", FsSortHeader.SortDirection.Desc) => q.OrderByDescending(x => x.InvoiceDate),
            ("due", FsSortHeader.SortDirection.Asc) => q.OrderBy(x => x.DueDate ?? DateTime.MaxValue),
            ("due", FsSortHeader.SortDirection.Desc) => q.OrderByDescending(x => x.DueDate ?? DateTime.MinValue),
            ("type", FsSortHeader.SortDirection.Asc) => q.OrderBy(x => x.InvoiceType),
            ("type", FsSortHeader.SortDirection.Desc) => q.OrderByDescending(x => x.InvoiceType),
            ("status", FsSortHeader.SortDirection.Asc) => q.OrderBy(x => x.Status),
            ("status", FsSortHeader.SortDirection.Desc) => q.OrderByDescending(x => x.Status),
            ("tickets", FsSortHeader.SortDirection.Asc) => q.OrderBy(x => x.TicketCount),
            ("tickets", FsSortHeader.SortDirection.Desc) => q.OrderByDescending(x => x.TicketCount),
            ("total", FsSortHeader.SortDirection.Asc) => q.OrderBy(x => x.Total),
            ("total", FsSortHeader.SortDirection.Desc) => q.OrderByDescending(x => x.Total),
            ("balance", FsSortHeader.SortDirection.Asc) => q.OrderBy(x => x.Balance),
            ("balance", FsSortHeader.SortDirection.Desc) => q.OrderByDescending(x => x.Balance),
            _ => q.OrderByDescending(x => x.InvoiceDate)
        };

    // ────────────────────────────────
    //  Actions
    // ────────────────────────────────

    private void ViewDetails(int invoiceId) =>
        NavigationManager.NavigateTo($"/facturas/{invoiceId}");

    private async Task OpenNewInvoiceDialog()
    {
        var result = await DialogService.OpenAsync<fs_front.Pages.Invoices.InvoiceForm>(
            "Nueva Factura",
            new Dictionary<string, object>(),
            new DialogOptions
            {
                Width = "1000px",
                Resizable = true,
                Draggable = false,
                CloseDialogOnOverlayClick = false
            });

        if (result == true) await LoadData();
    }

    private async Task GenerateMonthlyInvoices()
    {
        var confirmed = await DialogService.Confirm(
            "¿Desea generar las facturas mensuales para todos los clientes con póliza mensual?",
            "Confirmar Generación",
            new ConfirmOptions { OkButtonText = "Sí, generar", CancelButtonText = "Cancelar" });

        if (confirmed != true) return;

        _isGenerating = true;
        StateHasChanged();

        try
        {
            var (success, errorMessage) = await InvoiceApiService.GenerateMonthlyInvoicesAsync();

            if (success)
            {
                Notify("Éxito", "Facturas mensuales generadas correctamente.", NotificationSeverity.Success);
                await LoadData();
            }
            else
            {
                var msg = errorMessage ?? "Error desconocido";
                var isNoClients = msg.Contains("No se encontraron") ||
                                  msg.Contains("no hay", StringComparison.OrdinalIgnoreCase) ||
                                  msg.Contains("Sin clientes") ||
                                  msg.Contains("No hay");

                Notify(
                    isNoClients ? "Información" : "Error",
                    isNoClients
                        ? "No hay clientes con modalidad mensual activos o ya tienen factura para este mes."
                        : msg,
                    isNoClients ? NotificationSeverity.Info : NotificationSeverity.Error);
            }
        }
        catch (HttpRequestException)
        {
            Notify("Error de Conexión",
                "No se pudo conectar con el servidor.",
                NotificationSeverity.Error);
        }
        catch (Exception ex)
        {
            Notify("Error", $"Error inesperado: {ex.Message}", NotificationSeverity.Error);
        }
        finally
        {
            _isGenerating = false;
        }
    }

    private async Task DownloadPdf(int invoiceId)
    {
        try
        {
            var bytes = await InvoiceApiService.GenerateInvoicePdfAsync(invoiceId);
            if (bytes != null)
            {
                var b64 = Convert.ToBase64String(bytes);
                await JSRuntime.InvokeVoidAsync("downloadFile", $"Factura-{invoiceId}.pdf", b64);
                Notify("Éxito", "PDF descargado correctamente", NotificationSeverity.Success);
            }
        }
        catch (Exception ex)
        {
            Notify("Error", $"Error al descargar PDF: {ex.Message}", NotificationSeverity.Error);
        }
    }

    private void Notify(string title, string msg, NotificationSeverity sev) =>
        NotificationService.Notify(new NotificationMessage
        {
            Severity = sev,
            Summary = title,
            Detail = msg,
            Duration = 4000
        });
}
