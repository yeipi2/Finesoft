@* Modal de creación/edición de proyecto.
   Usa los subcomponentes: GeneralInfoSection, ClientSection, ConfigSection *@
@using fs_front.DTO
@using Radzen
@using Radzen.Blazor
@using fs_front.Components.Projects.Index
@using fs_front.Components.Projects.Form
@using fs_front.Components.Projects.Shared

@inject IProjectApiService ProjectApiService
@inject IClientApiService ClientApiService
@inject DialogService DialogService
@inject NotificationService NotificationService

<div style="max-width: 900px; margin: 0 auto;">
    <EditForm Model="_dto" OnValidSubmit="HandleSubmit">
        <DataAnnotationsValidator />

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <div class="alert alert-danger mb-3" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>@_errorMessage
            </div>
        }

        <div class="accordion mb-3" id="projectAccordion">

            <GeneralInfoSection Model="_dto"
                                IsComplete="_section1Complete"
                                OnChange="ValidateSections" />

            <ClientSection Model="_dto"
                           IsComplete="_section2Complete"
                           IsLoadingClients="_isLoadingClients"
                           SearchText="@_clientSearchText"
                           FilteredClients="_filteredClients"
                           SelectedClient="_selectedClient"
                           OnSearchInput="OnClientSearchInput"
                           OnClientSelected="SelectClient" />

            <ConfigSection Model="_dto" />

        </div>

        <div class="d-flex justify-content-between align-items-center mt-3">
            <div>
                @if (!_allSectionsComplete)
                {
                    <small class="text-danger">
                        <i class="bi bi-exclamation-circle me-1"></i>
                        Complete las secciones obligatorias
                    </small>
                }
            </div>
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-secondary btn-sm" @onclick="Cancel">
                    Cancelar
                </button>
                <button type="submit"
                        class="btn btn-primary btn-sm"
                        disabled="@(_isSaving || _isLoadingClients || _dto.ClientId == 0)">
                    @if (_isSaving)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    }
                    <i class="bi bi-check-lg me-1"></i>
                    @(_isEditMode ? "Actualizar Proyecto" : "Guardar")
                </button>
            </div>
        </div>

    </EditForm>
</div>

@code {
    [Parameter] public int? ProjectId { get; set; }

    // ── Estado interno ────────────────────────────────────────────────────────
    private ProjectDto _dto = new();
    private List<ClientDto> _allClients    = new();
    private List<ClientDto> _filteredClients = new();
    private ClientDto? _selectedClient;
    private string _clientSearchText = string.Empty;

    private bool _isSaving         = false;
    private bool _isLoadingClients = false;
    private string? _errorMessage;

    private bool _isEditMode      => ProjectId.HasValue;
    private bool _section1Complete = false;
    private bool _section2Complete => _dto.ClientId > 0;
    private bool _allSectionsComplete => _section1Complete && _section2Complete;

    // ── Ciclo de vida ─────────────────────────────────────────────────────────
    protected override async Task OnInitializedAsync()
    {
        await LoadAllClients();

        if (_isEditMode)
            await LoadProject();
        else
            _dto = new ProjectDto { IsActive = true };

        ValidateSections();
    }

    // ── Carga de datos ────────────────────────────────────────────────────────
    private async Task LoadAllClients()
    {
        _isLoadingClients = true;
        StateHasChanged();
        try
        {
            var clients = await ClientApiService.GetClientsAsync();
            _allClients      = clients ?? new List<ClientDto>();
            _filteredClients = _allClients;
        }
        catch (Exception ex)
        {
            _errorMessage = "Error al cargar la lista de clientes.";
            Console.WriteLine($"Error al cargar clientes: {ex.Message}");
        }
        finally
        {
            _isLoadingClients = false;
            StateHasChanged();
        }
    }

    private async Task LoadProject()
    {
        try
        {
            var project = await ProjectApiService.GetProjectByIdAsync(ProjectId!.Value);
            if (project is null) { _errorMessage = "Proyecto no encontrado."; return; }

            _dto = new ProjectDto
            {
                Id          = project.Id,
                Name        = project.Name,
                Description = project.Description,
                ClientId    = project.ClientId,
                IsActive    = project.IsActive
            };

            if (project.Client != null)
            {
                _selectedClient   = project.Client;
                _clientSearchText = project.Client.CompanyName;
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error al cargar el proyecto: {ex.Message}";
        }
    }

    // ── Autocomplete de cliente ───────────────────────────────────────────────
    private void OnClientSearchInput(ChangeEventArgs e)
    {
        _clientSearchText = e.Value?.ToString() ?? string.Empty;

        if (string.IsNullOrWhiteSpace(_clientSearchText))
        {
            _filteredClients  = _allClients;
            _selectedClient   = null;
            _dto.ClientId     = 0;
        }
        else
        {
            _filteredClients = _allClients
                .Where(c => c.CompanyName.Contains(_clientSearchText, StringComparison.OrdinalIgnoreCase))
                .OrderBy(c => c.CompanyName)
                .ToList();

            var exactMatch = _allClients.FirstOrDefault(c =>
                c.CompanyName.Equals(_clientSearchText, StringComparison.OrdinalIgnoreCase));

            if (exactMatch is null && _selectedClient is not null)
            {
                _selectedClient = null;
                _dto.ClientId   = 0;
            }
        }

        ValidateSections();
    }

    private void SelectClient(ClientDto client)
    {
        _selectedClient   = client;
        _dto.ClientId     = client.Id ?? 0;
        _clientSearchText = client.CompanyName;
        ValidateSections();
    }

    // ── Validación de secciones ───────────────────────────────────────────────
    private void ValidateSections()
    {
        _section1Complete = !string.IsNullOrWhiteSpace(_dto.Name);
        StateHasChanged();
    }

    // ── Submit ────────────────────────────────────────────────────────────────
    private async Task HandleSubmit()
    {
        if (_dto.ClientId == 0)
        {
            _errorMessage = "Debe seleccionar un cliente de la lista.";
            return;
        }

        _isSaving     = true;
        _errorMessage = null;
        StateHasChanged();

        try
        {
            if (_isEditMode)
            {
                var result = await ProjectApiService.UpdateProjectAsync(ProjectId!.Value, _dto);
                if (result.Success)
                {
                    Notify("Éxito", "Proyecto actualizado correctamente.", NotificationSeverity.Success);
                    DialogService.Close(true);
                }
                else _errorMessage = result.ErrorMessage ?? "No se pudo actualizar el proyecto.";
            }
            else
            {
                var result = await ProjectApiService.CreateProjectAsync(_dto);
                if (result.Success)
                {
                    Notify("Éxito", "Proyecto creado correctamente.", NotificationSeverity.Success);
                    DialogService.Close(true);
                }
                else _errorMessage = result.ErrorMessage ?? "No se pudo crear el proyecto.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error al {(_isEditMode ? "actualizar" : "crear")} el proyecto: {ex.Message}";
        }
        finally
        {
            _isSaving = false;
            StateHasChanged();
        }
    }

    private void Cancel() => DialogService.Close(false);

    private void Notify(string title, string message, NotificationSeverity severity) =>
        NotificationService.Notify(new NotificationMessage
        {
            Severity = severity,
            Summary  = title,
            Detail   = message,
            Duration = 4000
        });
}
