@page "/proyectos"
@using fs_front.DTO

@attribute [Authorize]

<PageTitle>Finesoft - Proyectos</PageTitle>

@* ── ESTADO: verificando acceso ── *@
@if (_checkingAccess)
{
    <div style="position:fixed;top:0;left:0;width:100vw;height:100vh;
        background:white;z-index:9999;
        display:flex;align-items:center;justify-content:center;">
        <div class="spinner-border text-primary" role="status"></div>
    </div>
}
@* ── ESTADO: sin acceso (seguridad extra mientras redirige) ── *@
else if (!_hasAccess)
{
    <div></div>
}
@* ── ESTADO: contenido real ── *@
else
{
    <container class="container p-4">
        <section class="container-fluid px-xl-5">
            <div class="d-flex justify-content-between align-items-start mb-4">
                <div class="d-flex align-items-center">
                    <i class="bi bi-folder fs-1 text-primary me-3"></i>
                    <div>
                        <p class="display-6 fw-bolder mb-2">Proyectos Registrados</p>
                        <p class="text-muted mb-0">Lista de todos los proyectos del sistema</p>
                    </div>
                </div>
                @if (_canCreate)
                {
                    <button @onclick="ShowCreateModal" class="btn btn-primary d-flex align-items-center gap-2 fw-bold small">
                        <i class="bi bi-plus-lg"></i>
                        Nuevo Proyecto
                    </button>
                }
            </div>

            <SearchBar Placeholder="Buscar proyectos..." Value="@_searchText"
                       ValueChanged="@(v => { _searchText = v; StateHasChanged(); })" Class="mb-4" />
        </section>

        <section class="container-fluid p-xl-5">
            <FsDataTable TItem="ProjectDetailDto" Title="Proyectos" Subtitle="Lista de todos los proyectos del sistema"
                         Items="_sortedProjects" IsLoading="_isLoading" ColSpan="4" EmptyTitle="No se encontraron proyectos"
                         EmptySubtitle="Prueba con otra búsqueda.">

                <Header>
                    <FsSortHeader Text="Proyecto" Field="name" ActiveField="@_sortField" Direction="@_sortDir"
                                  SortChanged="OnSortChanged" ThClass="ps-4" />
                    <FsSortHeader Text="Cliente" Field="client" ActiveField="@_sortField" Direction="@_sortDir"
                                  SortChanged="OnSortChanged" />
                    <FsSortHeader Text="Estado" Field="status" ActiveField="@_sortField" Direction="@_sortDir"
                                  SortChanged="OnSortChanged" />
                    <th class="text-center">Acciones</th>
                </Header>

                <RowTemplate Context="project">
                    <tr>
                        <td class="ps-4">
                            <div class="fw-bold text-primary">@project.Name</div>
                            <div class="text-muted small">@project.Description</div>
                        </td>

                        <td>
                            @if (project.Client != null)
                            {
                                <div>
                                    <div class="fw-bold">@project.Client.CompanyName</div>
                                    <div class="text-muted small"><i class="bi bi-person"></i> @project.Client.ContactName</div>
                                    <div class="text-muted small"><i class="bi bi-envelope"></i> @project.Client.Email</div>
                                    <div class="text-muted small"><i class="bi bi-telephone"></i> @project.Client.Phone</div>
                                </div>
                            }
                            else
                            {
                                <span class="text-muted small">Sin cliente</span>
                            }
                        </td>

                        <td>
                            @if (project.IsActive)
                            {
                                <span class="badge bg-success"><i class="bi bi-check-circle"></i> Activo</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary"><i class="bi bi-x-circle"></i> Inactivo</span>
                            }
                        </td>

                        <td class="text-center">
                            @if (_canEdit)
                            {
                                <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => ShowEditModal(project.Id)"
                                        title="Editar">
                                    <i class="bi bi-pencil-fill"></i>
                                </button>
                            }

                            <button class="btn btn-sm btn-outline-info me-1" @onclick="() => ViewProjectDetails(project.Id)"
                                    title="Ver detalles">
                                <i class="bi bi-eye-fill"></i>
                            </button>

                            @if (_canDelete)
                            {
                                <button class="btn btn-sm btn-outline-danger" @onclick="() => ConfirmDelete(project)"
                                        title="Eliminar">
                                    <i class="bi bi-trash-fill"></i>
                                </button>
                            }
                        </td>
                    </tr>
                </RowTemplate>

            </FsDataTable>
        </section>
    </container>
}

@inject IProjectApiService ProjectApiService
@inject DialogService DialogService
@inject NotificationService NotificationService
@inject NavigationManager NavigationManager
@inject PermissionService PermissionService

@code {
    private List<ProjectDetailDto>? _projects;
    private string _searchText = string.Empty;
    private bool _isLoading = false;

    // ⭐ Control de acceso integrado en la página
    private bool _checkingAccess = true;
    private bool _hasAccess = false;

    private bool _canCreate;
    private bool _canEdit;
    private bool _canDelete;
    private string _sortField = "name";
    private FsSortHeader.SortDirection _sortDir = FsSortHeader.SortDirection.Desc;

    private void OnSortChanged((string field, FsSortHeader.SortDirection dir) s)
    {
        _sortField = s.field;
        _sortDir = s.dir;
    }

    private IEnumerable<ProjectDetailDto> _sortedProjects => ApplySort(_filteredProjects);

    private IEnumerable<ProjectDetailDto> ApplySort(IEnumerable<ProjectDetailDto> q)
    {
        return (_sortField, _sortDir) switch
        {
            ("name", FsSortHeader.SortDirection.Asc) => q.OrderBy(x => x.Name),
            ("name", FsSortHeader.SortDirection.Desc) => q.OrderByDescending(x => x.Name),

            ("client", FsSortHeader.SortDirection.Asc) => q.OrderBy(x => x.Client?.CompanyName ?? ""),
            ("client", FsSortHeader.SortDirection.Desc) => q.OrderByDescending(x => x.Client?.CompanyName ?? ""),

            ("status", FsSortHeader.SortDirection.Asc) => q.OrderBy(x => x.IsActive),
            ("status", FsSortHeader.SortDirection.Desc) => q.OrderByDescending(x => x.IsActive),

            _ => q.OrderByDescending(x => x.Name),
        };
    }


    private IEnumerable<ProjectDetailDto> _filteredProjects =>
        _projects?.Where(p =>
            string.IsNullOrWhiteSpace(_searchText) ||
            p.Name.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
            (p.Client?.CompanyName.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false) ||
            (p.Client?.ContactName.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false)
        ) ?? Enumerable.Empty<ProjectDetailDto>();

    protected override async Task OnInitializedAsync()
    {
        // ── 1. Verificar permiso ANTES de cargar cualquier dato ──
        var canView = await PermissionService.HasPermissionAsync("projects.view");

        if (!canView)
        {
            Console.WriteLine("⛔ Sin permiso projects.view → redirigiendo");
            _checkingAccess = false;
            _hasAccess = false;
            NavigationManager.NavigateTo("/dashboard", forceLoad: true);
            return;
        }

        // ── 2. Tiene acceso: cargar permisos de acciones y datos ──
        _hasAccess = true;
        _checkingAccess = false;

        _canCreate = await PermissionService.HasPermissionAsync("projects.create");
        _canEdit = await PermissionService.HasPermissionAsync("projects.edit");
        _canDelete = await PermissionService.HasPermissionAsync("projects.delete");

        await LoadProjects();
    }

    private async Task LoadProjects()
    {
        _isLoading = true;
        try
        {
            _projects = await ProjectApiService.GetProjectsAsync();
        }
        catch (Exception ex)
        {
            ShowNotification("Error", $"Error al cargar proyectos: {ex.Message}", NotificationSeverity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task ShowCreateModal()
    {
        var result = await DialogService.OpenAsync<ProjectForm>("Crear Proyecto",
            options: new DialogOptions()
            {
                Width = "700px",
                Resizable = false,
                Draggable = false
            });

        if (result == true)
        {
            await LoadProjects();
        }
    }

    private async Task ShowEditModal(int projectId)
    {
        var parameters = new Dictionary<string, object>
        {
            { "ProjectId", projectId }
        };

        var result = await DialogService.OpenAsync<ProjectForm>("Editar Proyecto",
            parameters,
            new DialogOptions()
            {
                Width = "700px",
                Resizable = false,
                Draggable = false
            });

        if (result == true)
        {
            await LoadProjects();
        }
    }

    private void ViewProjectDetails(int projectId)
    {
        NavigationManager.NavigateTo($"/proyectos/{projectId}");
    }

    private async Task ConfirmDelete(ProjectDetailDto project)
    {
        var confirmed = await DialogService.Confirm(
            $"¿Está seguro que desea eliminar el proyecto '{project.Name}'?",
            "Confirmar Eliminación",
            new ConfirmOptions()
            {
                OkButtonText = "Sí, eliminar",
                CancelButtonText = "Cancelar"
            });

        if (confirmed == true)
        {
            await DeleteProject(project.Id);
        }
    }

    private async Task DeleteProject(int projectId)
    {
        try
        {
            var result = await ProjectApiService.DeleteProjectAsync(projectId);
            if (result.Success)
            {
                ShowNotification("Éxito", "Proyecto eliminado correctamente.", NotificationSeverity.Success);
                await LoadProjects();
            }
            else
            {
                ShowNotification("Error", result.ErrorMessage ?? "No se pudo eliminar el proyecto.", NotificationSeverity.Error);
            }
        }
        catch (Exception ex)
        {
            ShowNotification("Error", $"Error al eliminar proyecto: {ex.Message}", NotificationSeverity.Error);
        }
    }

    private void ShowNotification(string title, string message, NotificationSeverity severity)
    {
        NotificationService.Notify(new NotificationMessage
        {
            Severity = severity,
            Summary = title,
            Detail = message,
            Duration = 4000
        });
    }
}