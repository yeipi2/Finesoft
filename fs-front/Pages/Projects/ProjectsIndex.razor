@page "/proyectos"
@using fs_front.DTO
@using fs_front.Components.Projects.Index
@using fs_front.Components.Projects.Form
@using fs_front.Components.Projects.Shared

@attribute [Authorize]

<PageTitle>Finesoft - Proyectos</PageTitle>

@* ── ESTADO: verificando acceso ── *@
@if (_checkingAccess)
{
    <div style="position:fixed;top:0;left:0;width:100vw;height:100vh;
        background:white;z-index:9999;
        display:flex;align-items:center;justify-content:center;">
        <div class="spinner-border text-primary" role="status"></div>
    </div>
}
@* ── ESTADO: sin acceso (seguridad extra mientras redirige) ── *@
else if (!_hasAccess)
{
    <div></div>
}
@* ── ESTADO: contenido real ── *@
else
{
    <container class="container p-4">
        <section class="container-fluid px-xl-5">
            <ProjectsHeader CanCreate="_canCreate" OnCreate="ShowCreateModal" />
            <SearchBar Placeholder="Buscar proyectos..."
                       Value="@_searchText"
                       ValueChanged="@(v => { _searchText = v; StateHasChanged(); })"
                       Class="mb-4" />
        </section>

        <section class="container-fluid p-xl-5">
            <ProjectsTable Items="_sortedProjects"
                           IsLoading="_isLoading"
                           SortField="@_sortField"
                           SortDir="@_sortDir"
                           SortChanged="OnSortChanged"
                           OnViewDetails="ViewProjectDetails" />
        </section>
    </container>
}

@inject IProjectApiService ProjectApiService
@inject DialogService DialogService
@inject NotificationService NotificationService
@inject NavigationManager NavigationManager
@inject PermissionService PermissionService

@code {
    private List<ProjectDetailDto>? _projects;
    private string _searchText = string.Empty;
    private bool _isLoading = false;

    private bool _checkingAccess = true;
    private bool _hasAccess = false;
    private bool _canCreate;
    private bool _canEdit;
    private bool _canDelete;

    private string _sortField = "name";
    private FsSortHeader.SortDirection _sortDir = FsSortHeader.SortDirection.Desc;

    // ── Filtrado ──────────────────────────────────────────────────────────────
    private IEnumerable<ProjectDetailDto> _filteredProjects =>
        _projects?.Where(p =>
            string.IsNullOrWhiteSpace(_searchText) ||
            p.Name.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
            (p.Client?.CompanyName.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false) ||
            (p.Client?.ContactName.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false)
        ) ?? Enumerable.Empty<ProjectDetailDto>();

    // ── Ordenamiento ──────────────────────────────────────────────────────────
    private IEnumerable<ProjectDetailDto> _sortedProjects => ApplySort(_filteredProjects);

    private IEnumerable<ProjectDetailDto> ApplySort(IEnumerable<ProjectDetailDto> q) =>
        (_sortField, _sortDir) switch
        {
            ("name",   FsSortHeader.SortDirection.Asc)  => q.OrderBy(x => x.Name),
            ("name",   FsSortHeader.SortDirection.Desc) => q.OrderByDescending(x => x.Name),
            ("client", FsSortHeader.SortDirection.Asc)  => q.OrderBy(x => x.Client?.CompanyName ?? ""),
            ("client", FsSortHeader.SortDirection.Desc) => q.OrderByDescending(x => x.Client?.CompanyName ?? ""),
            ("status", FsSortHeader.SortDirection.Asc)  => q.OrderBy(x => x.IsActive),
            ("status", FsSortHeader.SortDirection.Desc) => q.OrderByDescending(x => x.IsActive),
            _                                           => q.OrderByDescending(x => x.Name),
        };

    private void OnSortChanged((string field, FsSortHeader.SortDirection dir) s)
    {
        _sortField = s.field;
        _sortDir   = s.dir;
    }

    // ── Ciclo de vida ─────────────────────────────────────────────────────────
    protected override async Task OnInitializedAsync()
    {
        var canView = await PermissionService.HasPermissionAsync("projects.view");

        if (!canView)
        {
            _checkingAccess = false;
            _hasAccess = false;
            NavigationManager.NavigateTo("/dashboard", forceLoad: true);
            return;
        }

        _hasAccess      = true;
        _checkingAccess = false;

        _canCreate = await PermissionService.HasPermissionAsync("projects.create");
        _canEdit   = await PermissionService.HasPermissionAsync("projects.edit");
        _canDelete = await PermissionService.HasPermissionAsync("projects.delete");

        await LoadProjects();
    }

    // ── Carga de datos ────────────────────────────────────────────────────────
    private async Task LoadProjects()
    {
        _isLoading = true;
        try
        {
            _projects = await ProjectApiService.GetProjectsAsync();
        }
        catch (Exception ex)
        {
            Notify("Error", $"Error al cargar proyectos: {ex.Message}", NotificationSeverity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    // ── Acciones ──────────────────────────────────────────────────────────────
    private async Task ShowCreateModal()
    {
        var result = await DialogService.OpenAsync<ProjectForm>("Crear Proyecto",
            options: new DialogOptions { Width = "700px", Resizable = false, Draggable = false });

        if (result == true) await LoadProjects();
    }

    private void ViewProjectDetails(int projectId) =>
        NavigationManager.NavigateTo($"/proyectos/{projectId}");

    // ── Notificaciones ────────────────────────────────────────────────────────
    private void Notify(string title, string message, NotificationSeverity severity) =>
        NotificationService.Notify(new NotificationMessage
        {
            Severity = severity,
            Summary  = title,
            Detail   = message,
            Duration = 4000
        });
}
