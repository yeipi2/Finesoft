@using fs_front.DTO

<section class="container px-0">
    <EditForm Model="_typeServiceDto" OnValidSubmit="HandleSubmit">
        <DataAnnotationsValidator/>
        <ValidationSummary/>

        <div class="mb-3">
            <label for="Name" class="form-label fw-bold small">Nombre *</label>
            <InputText id="Name" class="form-control" placeholder="Desarrollo, Consultoría, Soporte..."
                       @bind-Value="_typeServiceDto.Name"/>
            <ValidationMessage For="@(() => _typeServiceDto.Name)"/>
        </div>

        <div class="mb-3">
            <label for="Description" class="form-label fw-bold small">Descripción</label>
            <InputTextArea id="Description" class="form-control" rows="3" 
                           placeholder="Descripción del tipo de servicio..."
                           @bind-Value="_typeServiceDto.Description"/>
            <ValidationMessage For="@(() => _typeServiceDto.Description)"/>
        </div>

        <div class="mb-3 border rounded p-3">
            <div class="form-check form-switch">
                <label class="form-check-label fw-bold" for="IsActive">Activo</label>
                <InputCheckbox id="IsActive" class="form-check-input" @bind-Value="_typeServiceDto.IsActive"/>
            </div>
        </div>

        <div class="d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-secondary" @onclick="Cancel">Cancelar</button>
            <button type="submit" class="btn btn-primary" disabled="@_isSaving">
                @if (_isSaving)
                {
                    <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                }
                <i class="bi bi-check-lg"></i>
                @(_isEditMode ? "Actualizar" : "Crear")
            </button>
        </div>

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <div class="alert alert-danger mt-3" role="alert">
                @_errorMessage
            </div>
        }
    </EditForm>
</section>

@inject ITypeServiceApiService TypeServiceApiService
@inject DialogService DialogService
@inject NotificationService NotificationService

@code {
    [Parameter] public int? TypeServiceId { get; set; }

    private TypeServiceDto _typeServiceDto = new();
    private bool _isSaving = false;
    private string? _errorMessage;
    private bool _isEditMode => TypeServiceId.HasValue;

    protected override async Task OnInitializedAsync()
    {
        if (_isEditMode)
        {
            await LoadTypeService();
        }
    }

    private async Task LoadTypeService()
    {
        try
        {
            var type = await TypeServiceApiService.GetTypeServiceByIdAsync(TypeServiceId!.Value);
            if (type != null)
            {
                _typeServiceDto = type;
            }
            else
            {
                _errorMessage = "Tipo de servicio no encontrado.";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error al cargar: {ex.Message}";
        }
    }

    private async Task HandleSubmit()
    {
        _isSaving = true;
        _errorMessage = null;
        StateHasChanged();

        try
        {
            if (_isEditMode)
            {
                var result = await TypeServiceApiService.UpdateTypeServiceAsync(TypeServiceId!.Value, _typeServiceDto);
                if (result.Success)
                {
                    ShowNotification("Éxito", "Tipo actualizado correctamente.", NotificationSeverity.Success);
                    DialogService.Close(true);
                }
                else
                {
                    _errorMessage = result.ErrorMessage ?? "No se pudo actualizar.";
                }
            }
            else
            {
                var result = await TypeServiceApiService.CreateTypeServiceAsync(_typeServiceDto);
                if (result.Success)
                {
                    ShowNotification("Éxito", "Tipo creado correctamente.", NotificationSeverity.Success);
                    DialogService.Close(true);
                }
                else
                {
                    _errorMessage = result.ErrorMessage ?? "No se pudo crear.";
                }
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            _isSaving = false;
            StateHasChanged();
        }
    }

    private void Cancel()
    {
        DialogService.Close(false);
    }

    private void ShowNotification(string title, string message, NotificationSeverity severity)
    {
        NotificationService.Notify(new NotificationMessage
        {
            Severity = severity,
            Summary = title,
            Detail = message,
            Duration = 4000
        });
    }
}