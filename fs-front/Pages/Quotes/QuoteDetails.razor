@page "/cotizaciones/{QuoteId:int}"
@using fs_front.DTO
@using fs_front.Pages.Invoices
@using Microsoft.AspNetCore.SignalR.Client
@using Microsoft.Extensions.Configuration

@implements IAsyncDisposable

<PageTitle>Cotización @_quote?.QuoteNumber</PageTitle>

<div class="container p-4">
    @if (_isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 text-muted">Cargando cotización...</p>
        </div>
    }
    else if (_quote != null)
    {
        <div class="row mb-4">
            <div class="col">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/cotizaciones">Cotizaciones</a></li>
                        <li class="breadcrumb-item active">@_quote.QuoteNumber</li>
                    </ol>
                </nav>

                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h1 class="display-6 fw-bold mb-2">@_quote.QuoteNumber</h1>
                        <div class="d-flex gap-2 mb-2">
                            <QuoteStatusBadge Status="@_quote.Status" Class="fs-6" />
                            @if (_quote.ValidUntil.HasValue && _quote.ValidUntil.Value < DateTime.Now && _quote.Status != "Aceptada")
                            {
                                <span class="badge bg-warning fs-6">Expirada</span>
                            }
                            @if (_quote.Status == "Aceptada" && HasInvoice())
                            {
                                <span class="badge bg-info fs-6">
                                    <i class="bi bi-check-circle-fill"></i> Facturada
                                </span>
                            }
                        </div>
                    </div>

                    <QuoteActionBar Status="@_quote.Status"
                                    HasInvoice="@HasInvoice()"
                                    IsSendingEmail="@_isSendingEmail"
                                    OnSendEmail="SendQuoteByEmail"
                                    OnChangeStatus="ChangeStatus"
                                    OnConvertToInvoice="ConvertToInvoice"
                                    OnDownloadPdf="DownloadPdf"
                                    OnEdit="EditQuote"
                                    OnDelete="ConfirmDelete" />
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-8">
                <QuoteClientCard Quote="@_quote" />
                <QuoteTicketsCard TicketsWithDetails="@TicketsWithDetails" />
                <QuoteItemsCard Items="@_quote.Items"
                                Subtotal="@_quote.Subtotal"
                                Tax="@_quote.Tax"
                                Total="@_quote.Total"
                                Notes="@_quote.Notes" />
            </div>

            <div class="col-lg-4">
                <QuoteSidebarCards QuoteNumber="@_quote.QuoteNumber"
                                   Status="@_quote.Status"
                                   CreatedAt="@_quote.CreatedAt"
                                   ValidUntil="@_quote.ValidUntil"
                                   CreatedByUserName="@_quote.CreatedByUserName"
                                   ItemCount="@_quote.Items.Count"
                                   TicketCount="@TicketsWithDetails.Count"
                                   Subtotal="@_quote.Subtotal"
                                   Tax="@_quote.Tax"
                                   Total="@_quote.Total"
                                   HasInvoice="@HasInvoice()"
                                   OnConvertToInvoice="ConvertToInvoice" />
            </div>
        </div>

        <div class="row mt-4">
            <div class="col">
                <button class="btn btn-secondary" @onclick="GoBack">
                    <i class="bi bi-arrow-left"></i> Volver a Cotizaciones
                </button>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i> Cotización no encontrada.
        </div>
    }
</div>

@inject IQuoteApiService QuoteApiService
@inject DialogService DialogService
@inject NotificationService NotificationService
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime
@inject IConfiguration Configuration

@code {
    [Parameter] public int QuoteId { get; set; }

    private QuoteDetailDto? _quote;
    private bool _isLoading = false;
    private bool _isSendingEmail = false;

    private List<QuoteItemDto> TicketsWithDetails =>
        _quote?.Items
            .Where(i => i.TicketId.HasValue && i.TicketId.Value > 0)
            .ToList() ?? new();

    private HubConnection? _hubConnection;
    private record QuoteStatusChangedEvent(int QuoteId, string QuoteNumber, string ClientName, string NewStatus);

    protected override async Task OnInitializedAsync()
    {
        await LoadQuote();
        await ConnectSignalR();
    }

    private async Task ConnectSignalR()
    {
        try
        {
            var apiBase = Configuration["WebApiAddress"]!.TrimEnd('/');
            var hubUrl = $"{apiBase}/hubs/quotes";

            _hubConnection = new HubConnectionBuilder()
                .WithUrl(hubUrl)
                .WithAutomaticReconnect(new[] { TimeSpan.Zero, TimeSpan.FromSeconds(2), TimeSpan.FromSeconds(5), TimeSpan.FromSeconds(10) })
                .Build();

            _hubConnection.On<QuoteStatusChangedEvent>("QuoteStatusChanged", async (data) =>
            {
                if (data.QuoteId != QuoteId) return;
                await InvokeAsync(LoadQuote);
                var emoji = data.NewStatus == "Aceptada" ? "✅" : "❌";
                Notify($"{emoji} Cotización {data.NewStatus}",
                    $"El cliente {data.ClientName} respondió esta cotización.",
                    data.NewStatus == "Aceptada" ? NotificationSeverity.Success : NotificationSeverity.Warning);
                await InvokeAsync(StateHasChanged);
            });

            _hubConnection.Reconnected += async (_) => await _hubConnection.InvokeAsync("JoinInternalGroup");
            await _hubConnection.StartAsync();
            await _hubConnection.InvokeAsync("JoinInternalGroup");
        }
        catch (Exception ex) { Console.WriteLine($"❌ SignalR error: {ex.Message}"); }
    }

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection is not null)
        {
            try { await _hubConnection.InvokeAsync("LeaveInternalGroup"); } catch { }
            await _hubConnection.DisposeAsync();
        }
    }

    private async Task LoadQuote()
    {
        _isLoading = true;
        try { _quote = await QuoteApiService.GetQuoteByIdAsync(QuoteId); }
        catch (Exception ex) { Notify("Error", $"Error al cargar la cotización: {ex.Message}", NotificationSeverity.Error); }
        finally { _isLoading = false; }
    }

    private bool HasInvoice() =>
        _quote?.InvoiceId.HasValue == true && _quote.InvoiceId.Value > 0;

    private async Task EditQuote()
    {
        var result = await DialogService.OpenAsync<QuoteForm>("Editar Cotización",
            new Dictionary<string, object> { { "QuoteId", QuoteId } },
            new DialogOptions
            {
                Width = "1000px",
                Height = "auto",              // ← auto, el CSS controla el max
                CssClass = "quote-form-dialog",
                Resizable = true,
                Draggable = false,
                CloseDialogOnOverlayClick = false
            });
        if (result == true) await LoadQuote();
    }

    private async Task SendQuoteByEmail()
    {
        var confirmed = await DialogService.Confirm(
            $"¿Está seguro que desea enviar la cotización '{_quote?.QuoteNumber}' por correo a {_quote?.ClientEmail}?",
            "Confirmar Envío",
            new ConfirmOptions { OkButtonText = "Sí, enviar", CancelButtonText = "Cancelar" });
        if (confirmed != true) return;

        _isSendingEmail = true;
        StateHasChanged();
        try
        {
            var result = await QuoteApiService.SendQuoteEmailAsync(QuoteId);
            if (result.Success) { Notify("Éxito", "Cotización enviada. Estado actualizado a 'Enviada'.", NotificationSeverity.Success); await LoadQuote(); }
            else Notify("Error", result.ErrorMessage ?? "No se pudo enviar la cotización.", NotificationSeverity.Error);
        }
        catch (Exception ex) { Notify("Error", $"Error: {ex.Message}", NotificationSeverity.Error); }
        finally { _isSendingEmail = false; StateHasChanged(); }
    }

    private async Task ChangeStatus(string newStatus)
    {
        try
        {
            var result = await QuoteApiService.ChangeQuoteStatusAsync(QuoteId, newStatus);
            if (result.Success) { Notify("Éxito", $"Estado cambiado a '{newStatus}'.", NotificationSeverity.Success); await LoadQuote(); }
            else Notify("Error", result.ErrorMessage ?? "No se pudo cambiar el estado.", NotificationSeverity.Error);
        }
        catch (Exception ex) { Notify("Error", $"Error: {ex.Message}", NotificationSeverity.Error); }
    }

    private async Task ConvertToInvoice()
    {
        var result = await DialogService.OpenAsync<InvoiceFromQuoteForm>("Crear Factura desde Cotización",
            new Dictionary<string, object> { { "QuoteId", QuoteId } },
            new DialogOptions { Width = "900px", Height = "auto", Resizable = true, Draggable = false, CloseDialogOnOverlayClick = false });
        if (result == true) { Notify("Éxito", "Factura creada correctamente desde cotización.", NotificationSeverity.Success); await LoadQuote(); }
    }

    private async Task DownloadPdf()
    {
        try
        {
            var pdf = await QuoteApiService.GenerateQuotePdfAsync(QuoteId);
            if (pdf?.Length > 0)
            {
                await JSRuntime.InvokeVoidAsync("downloadFile", $"Cotizacion-{_quote?.QuoteNumber}.pdf", Convert.ToBase64String(pdf));
                Notify("Éxito", "PDF descargado correctamente.", NotificationSeverity.Success);
            }
            else Notify("Error", "No se pudo generar el PDF.", NotificationSeverity.Error);
        }
        catch (Exception ex) { Notify("Error", $"Error al generar PDF: {ex.Message}", NotificationSeverity.Error); }
    }

    private async Task ConfirmDelete()
    {
        var ok = await DialogService.Confirm(
            $"¿Está seguro que desea eliminar la cotización '{_quote?.QuoteNumber}'?",
            "Confirmar Eliminación",
            new ConfirmOptions { OkButtonText = "Sí, eliminar", CancelButtonText = "Cancelar" });
        if (ok == true)
        {
            var result = await QuoteApiService.DeleteQuoteAsync(QuoteId);
            if (result.Success) { Notify("Éxito", "Cotización eliminada.", NotificationSeverity.Success); NavigationManager.NavigateTo("/cotizaciones"); }
            else Notify("Error", result.ErrorMessage ?? "No se pudo eliminar.", NotificationSeverity.Error);
        }
    }

    private void GoBack() => NavigationManager.NavigateTo("/cotizaciones");

    private void Notify(string t, string m, NotificationSeverity s) =>
        NotificationService.Notify(new NotificationMessage { Severity = s, Summary = t, Detail = m, Duration = 5000 });
}