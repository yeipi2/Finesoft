@* Modal de creación/edición de cotización. *@
@using fs_front.DTO
@using System.Globalization

@inject IQuoteApiService QuoteApiService
@inject IClientApiService ClientApiService
@inject IServiceApiService ServiceApiService
@inject ITicketApiService TicketApiService
@inject DialogService DialogService
@inject NotificationService NotificationService

<div class="quote-form-wrapper">
    <EditForm Model="_quoteDto" OnValidSubmit="HandleSubmit">
        <DataAnnotationsValidator />

        <div class="quote-form-body">

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <div class="alert alert-danger mb-3" role="alert">
                    <div class="fw-bold mb-1">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>Por favor corrige los siguientes errores:
                    </div>
                    @foreach (var line in _errorMessage.Split('\n'))
                    {
                        <div>@line</div>
                    }
                </div>
            }

            <QuoteGeneralSection Model="_quoteDto"
                                 IsComplete="_section1Complete"
                                 IsEditMode="_isEditMode"
                                 IsLoadingClients="_isLoadingClients"
                                 FilteredClients="_filteredClients"
                                 SelectedClient="_selectedClient"
                                 ClientSearchText="@_clientSearchText"
                                 ShowClientSuggestions="_showSuggestions"
                                 OnClientSearchInput="OnClientSearchInput"
                                 OnClientSelected="SelectClient"
                                 OnClientFocus="HandleClientFocus"
                                 OnClientBlur="HandleClientBlur" />

            <QuoteItemsSection Items="_quoteDto.Items"
                               IsComplete="_section2Complete"
                               IsLoadingTickets="_isLoadingTickets"
                               ClosedTickets="_closedTickets"
                               TicketSearchTexts="_ticketSearchTexts"
                               FilteredTicketsCache="_filteredTicketsCache"
                               TicketSuggestionsVisible="_ticketSuggestionsVisible"
                               CalculatedSubtotal="_calculatedSubtotal"
                               CalculatedTax="_calculatedTax"
                               CalculatedTotal="_calculatedTotal"
                               OnAddItem="AddItem"
                               OnRemoveItem="RemoveItem"
                               OnRecalculate="RecalculateTotals"
                               OnTicketSearchInput="OnTicketSearchInput"
                               OnTicketFocus="OnTicketFocus"
                               OnTicketBlur="OnTicketBlur"
                               OnTicketSelected="SelectTicket"
                               OnClearTicket="ClearTicket" />

            <QuoteNotesSection Model="_quoteDto" />

        </div>

        <div class="quote-form-footer">
            <div>
                @if (!_allSectionsComplete)
                {
                    <small class="text-danger">
                        <i class="bi bi-exclamation-circle me-1"></i>Complete las secciones obligatorias
                    </small>
                }
            </div>
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-secondary btn-sm" @onclick="Cancel">Cancelar</button>
                <button type="submit" class="btn btn-primary btn-sm"
                        disabled="@(_isSaving || !_quoteDto.Items.Any() || _quoteDto.ClientId == 0)">
                    @if (_isSaving)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    }
                    <i class="bi bi-check-lg me-1"></i>
                    @(_isEditMode ? "Actualizar Cotización" : "Guardar")
                </button>
            </div>
        </div>
    </EditForm>
</div>

@code {
    [Parameter] public int? QuoteId { get; set; }

    private QuoteDto _quoteDto = new();
    private List<ClientDto> _allClients = new();
    private List<ClientDto> _filteredClients = new();
    private ClientDto? _selectedClient;
    private string _clientSearchText = string.Empty;
    private bool _showSuggestions = false;
    private bool _isLoadingClients = false;
    private List<TicketDetailDto>? _closedTickets = new();
    private Dictionary<int, string> _ticketSearchTexts = new();
    private Dictionary<int, List<TicketDetailDto>> _filteredTicketsCache = new();
    private HashSet<int> _ticketSuggestionsVisible = new();
    private bool _isLoadingTickets = false;
    private decimal _calculatedSubtotal = 0;
    private decimal _calculatedTax = 0;
    private decimal _calculatedTotal = 0;
    private bool _isSaving = false;
    private string? _errorMessage;
    private bool _isEditMode => QuoteId.HasValue;
    private bool _section1Complete => _quoteDto.ClientId > 0;
    private bool _section2Complete => _quoteDto.Items.Any();
    private bool _allSectionsComplete => _section1Complete && _section2Complete;

    private HashSet<int> GetUsedTicketIds(int excludeIndex) =>
        _quoteDto.Items
            .Select((item, i) => (item, i))
            .Where(x => x.i != excludeIndex && x.item.TicketId.HasValue && x.item.TicketId.Value > 0)
            .Select(x => x.item.TicketId!.Value)
            .ToHashSet();

    private List<TicketDetailDto> GetAvailableTickets(int excludeIndex)
    {
        var used = GetUsedTicketIds(excludeIndex);
        return _closedTickets?.Where(t => !used.Contains(t.Id)).ToList() ?? new();
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadInitialData();
        if (_isEditMode) await LoadQuote();
        else _quoteDto = new QuoteDto { Status = "Borrador", ValidUntil = DateTime.Now.AddDays(30) };
        RecalculateTotals();
    }

    private async Task LoadInitialData()
    {
        _isLoadingClients = true;
        _isLoadingTickets = true;
        StateHasChanged();
        try
        {
            var clientsTask = ClientApiService.GetClientsAsync();
            var ticketsTask = TicketApiService.GetTicketsAsync();
            var quotesTask = QuoteApiService.GetQuotesAsync();
            await Task.WhenAll(clientsTask, ticketsTask, quotesTask);
            _allClients = (await clientsTask) ?? new();
            _filteredClients = new();
            var allQuotes = await quotesTask;
            var usedTicketIds = allQuotes?
                .Where(q => q.Id != QuoteId)
                .SelectMany(q => q.Items)
                .Where(i => i.TicketId.HasValue && i.TicketId.Value > 0)
                .Select(i => i.TicketId!.Value)
                .ToHashSet() ?? new HashSet<int>();
            var allTickets = await ticketsTask;
            _closedTickets = allTickets?
                .Where(t => !usedTicketIds.Contains(t.Id))
                .OrderByDescending(t => t.UpdatedAt ?? t.CreatedAt)
                .ToList() ?? new();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al cargar datos: {ex.Message}");
            _allClients = new();
            _closedTickets = new();
            _errorMessage = "Error al cargar datos iniciales.";
        }
        finally
        {
            _isLoadingClients = false;
            _isLoadingTickets = false;
            StateHasChanged();
        }
    }

    private async Task LoadQuote()
    {
        try
        {
            var quote = await QuoteApiService.GetQuoteByIdAsync(QuoteId!.Value);
            if (quote != null)
            {
                _quoteDto = new QuoteDto
                {
                    Id = quote.Id,
                    ClientId = quote.ClientId,
                    ValidUntil = quote.ValidUntil,
                    Status = quote.Status,
                    Notes = quote.Notes,
                    Items = quote.Items.Select(i => new QuoteItemDto
                    {
                        Id = i.Id,
                        Description = i.Description,
                        Quantity = i.Quantity,
                        UnitPrice = i.UnitPrice,
                        ServiceId = i.ServiceId,
                        TicketId = i.TicketId
                    }).ToList()
                };
                if (quote.ClientId > 0)
                {
                    _selectedClient = _allClients.FirstOrDefault(c => c.Id == quote.ClientId);
                    if (_selectedClient != null) _clientSearchText = _selectedClient.CompanyName;
                }
                for (int i = 0; i < _quoteDto.Items.Count; i++)
                {
                    var item = _quoteDto.Items[i];
                    if (item.TicketId.HasValue && item.TicketId.Value > 0)
                    {
                        var t = _closedTickets?.FirstOrDefault(x => x.Id == item.TicketId.Value);
                        _ticketSearchTexts[i] = t != null ? $"#{t.Id} - {t.Title}" : string.Empty;
                    }
                    else _ticketSearchTexts[i] = string.Empty;
                    _filteredTicketsCache[i] = new List<TicketDetailDto>();
                }
                RecalculateTotals();
            }
        }
        catch (Exception ex) { _errorMessage = $"Error al cargar cotización: {ex.Message}"; }
    }

    private void OnClientSearchInput(ChangeEventArgs e)
    {
        _clientSearchText = e.Value?.ToString() ?? string.Empty;
        if (string.IsNullOrWhiteSpace(_clientSearchText))
        {
            _filteredClients = new List<ClientDto>(); _showSuggestions = false;
            _selectedClient = null; _quoteDto.ClientId = 0;
        }
        else
        {
            _filteredClients = _allClients.Where(c => c.CompanyName.Contains(_clientSearchText, StringComparison.OrdinalIgnoreCase)).OrderBy(c => c.CompanyName).ToList();
            _showSuggestions = true;
            var exact = _allClients.FirstOrDefault(c => c.CompanyName.Equals(_clientSearchText, StringComparison.OrdinalIgnoreCase));
            if (exact is null && _selectedClient is not null) { _selectedClient = null; _quoteDto.ClientId = 0; }
        }
        StateHasChanged();
    }

    private void SelectClient(ClientDto client)
    {
        _selectedClient = client; _quoteDto.ClientId = client.Id ?? 0;
        _clientSearchText = client.CompanyName; _showSuggestions = false;
        StateHasChanged();
    }

    private void HandleClientFocus() { if (!string.IsNullOrWhiteSpace(_clientSearchText)) _showSuggestions = true; }

    private async Task HandleClientBlur() { await Task.Delay(200); _showSuggestions = false; StateHasChanged(); }

    private void OnTicketSearchInput((ChangeEventArgs e, int index) args)
    {
        var (e, index) = args;
        var searchText = e.Value?.ToString() ?? string.Empty;
        _ticketSearchTexts[index] = searchText;
        if (string.IsNullOrWhiteSpace(searchText)) { _filteredTicketsCache[index] = new(); _ticketSuggestionsVisible.Remove(index); _quoteDto.Items[index].TicketId = null; }
        else
        {
            var available = GetAvailableTickets(index);
            _filteredTicketsCache[index] = available.Where(t => t.Id.ToString().Contains(searchText, StringComparison.OrdinalIgnoreCase) || t.Title.Contains(searchText, StringComparison.OrdinalIgnoreCase) || t.ClientName.Contains(searchText, StringComparison.OrdinalIgnoreCase)).OrderBy(t => t.Id).ToList();
            _ticketSuggestionsVisible.Add(index);
        }
        StateHasChanged();
    }

    private void OnTicketFocus(int index)
    {
        var text = _ticketSearchTexts.TryGetValue(index, out var t) ? t : string.Empty;
        if (!string.IsNullOrWhiteSpace(text))
        {
            var available = GetAvailableTickets(index);
            _filteredTicketsCache[index] = available.Where(tk => tk.Id.ToString().Contains(text, StringComparison.OrdinalIgnoreCase) || tk.Title.Contains(text, StringComparison.OrdinalIgnoreCase) || tk.ClientName.Contains(text, StringComparison.OrdinalIgnoreCase)).OrderBy(tk => tk.Id).ToList();
            _ticketSuggestionsVisible.Add(index);
            StateHasChanged();
        }
    }

    private async Task OnTicketBlur(int index) { await Task.Delay(200); _ticketSuggestionsVisible.Remove(index); StateHasChanged(); }

    private void SelectTicket((QuoteItemDto item, TicketDetailDto ticket, int index) args)
    {
        var (item, ticket, index) = args;
        item.TicketId = ticket.Id; _ticketSearchTexts[index] = $"#{ticket.Id} - {ticket.Title}";
        _ticketSuggestionsVisible.Remove(index); _filteredTicketsCache[index] = new();
        StateHasChanged();
    }

    private void ClearTicket((QuoteItemDto item, int index) args)
    {
        var (item, index) = args; item.TicketId = null;
        _ticketSearchTexts[index] = string.Empty; _filteredTicketsCache[index] = new();
        StateHasChanged();
    }

    private void AddItem()
    {
        _quoteDto.Items.Add(new QuoteItemDto { Quantity = 1, UnitPrice = 0 });
        var idx = _quoteDto.Items.Count - 1;
        _ticketSearchTexts[idx] = string.Empty; _filteredTicketsCache[idx] = new();
        RecalculateTotals();
    }

    private void RemoveItem(int index)
    {
        _quoteDto.Items.RemoveAt(index);
        var newTexts = new Dictionary<int, string>(); var newCache = new Dictionary<int, List<TicketDetailDto>>(); var newVisible = new HashSet<int>();
        for (int i = 0; i < _quoteDto.Items.Count; i++)
        {
            var old = i < index ? i : i + 1;
            if (_ticketSearchTexts.TryGetValue(old, out var t)) newTexts[i] = t;
            if (_filteredTicketsCache.TryGetValue(old, out var c)) newCache[i] = c;
            if (_ticketSuggestionsVisible.Contains(old)) newVisible.Add(i);
        }
        _ticketSearchTexts = newTexts; _filteredTicketsCache = newCache; _ticketSuggestionsVisible = newVisible;
        RecalculateTotals();
    }

    private void RecalculateTotals()
    {
        _calculatedSubtotal = _quoteDto.Items.Sum(i => i.Quantity * i.UnitPrice);
        _calculatedTax = _calculatedSubtotal * 0.16m; _calculatedTotal = _calculatedSubtotal + _calculatedTax;
        StateHasChanged();
    }

    private async Task HandleSubmit()
    {
        _showSuggestions = false;
        if (_quoteDto.ClientId == 0) { _errorMessage = "Debe seleccionar un cliente de la lista."; return; }
        foreach (var item in _quoteDto.Items) if (!item.TicketId.HasValue || item.TicketId.Value == 0) item.TicketId = null;
        _isSaving = true; _errorMessage = null; StateHasChanged();
        try
        {
            if (_isEditMode)
            {
                var r = await QuoteApiService.UpdateQuoteAsync(QuoteId!.Value, _quoteDto);
                if (r.Success) { Notify("Éxito", "Cotización actualizada.", NotificationSeverity.Success); DialogService.Close(true); }
                else _errorMessage = ParseApiError(r.ErrorMessage);
            }
            else
            {
                var r = await QuoteApiService.CreateQuoteAsync(_quoteDto);
                if (r.Success) { Notify("Éxito", "Cotización creada.", NotificationSeverity.Success); DialogService.Close(true); }
                else _errorMessage = ParseApiError(r.ErrorMessage);
            }
        }
        catch (Exception ex) { _errorMessage = $"Error inesperado: {ex.Message}"; }
        finally { _isSaving = false; StateHasChanged(); }
    }

    private static string ParseApiError(string? raw)
    {
        if (string.IsNullOrWhiteSpace(raw)) return "Error desconocido.";
        try
        {
            using var doc = System.Text.Json.JsonDocument.Parse(raw.Contains("{") ? raw[raw.IndexOf('{')..] : raw);
            var root = doc.RootElement;
            if (root.TryGetProperty("errors", out var errors))
            {
                var msgs = new List<string>();
                foreach (var field in errors.EnumerateObject())
                {
                    var friendlyField = field.Name switch
                    {
                        var f when f.StartsWith("Items[") => $"Artículo #{int.Parse(f[6..f.IndexOf(']')]) + 1} — {GetFieldLabel(f[(f.IndexOf('.') + 1)..])}",
                        "ClientId" => "Cliente",
                        "ValidUntil" => "Válida Hasta",
                        "Status" => "Estado",
                        "Notes" => "Notas",
                        _ => field.Name
                    };
                    foreach (var msg in field.Value.EnumerateArray()) msgs.Add($"• {friendlyField}: {msg.GetString()}");
                }
                return msgs.Any() ? string.Join("\n", msgs) : "Error de validación.";
            }
            if (root.TryGetProperty("title", out var title)) return title.GetString() ?? "Error del servidor.";
        }
        catch { }
        return raw.Length > 300 ? raw[..300] + "..." : raw;
    }

    private static string GetFieldLabel(string fieldName) => fieldName switch
    {
        "Description" => "Descripción es obligatoria",
        "UnitPrice" => "Precio unitario debe ser mayor a 0",
        "Quantity" => "Cantidad debe ser mayor a 0",
        "ServiceId" => "Servicio",
        "TicketId" => "Ticket",
        _ => fieldName
    };

    private void Cancel() => DialogService.Close(false);
    private void Notify(string t, string m, NotificationSeverity s) =>
        NotificationService.Notify(new NotificationMessage { Severity = s, Summary = t, Detail = m, Duration = 4000 });
}
