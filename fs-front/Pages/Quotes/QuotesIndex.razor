@page "/cotizaciones"
@using fs_front.DTO
@using fs_front.Pages.Invoices
@using fs_front.Pages.Tickets
@using Microsoft.AspNetCore.SignalR.Client
@using Microsoft.Extensions.Configuration

@attribute [Authorize]
@implements IAsyncDisposable

<PageTitle>Finesoft - Cotizaciones</PageTitle>

@if (_checkingAccess)
{
    <div style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:white;z-index:9999;
                display:flex;align-items:center;justify-content:center;">
        <div class="spinner-border text-primary" role="status"></div>
    </div>
}
else if (!_hasAccess)
{
    <div></div>
}
else
{
    <div class="container">
        <section class="container-fluid px-xl-5">
            <QuotesHeader CanCreate="@_canCreate" OnCreate="ShowCreateModal" />

            <QuotesFilterBar SearchValue="@_searchText"
                             StatusFilter="@_statusFilter"
                             ClientFilter="@_clientFilter"
                             Clients="@_clients"
                             SearchValueChanged="OnSearchChanged"
                             StatusFilterChanged="OnStatusChanged"
                             ClientFilterChanged="OnClientFilterChanged"
                             OnClear="ClearFilters" />
        </section>

        <section class="container-fluid p-xl-5">
            <QuotesTable Items="@_sortedQuotes"
                         IsLoading="@_isLoading"
                         SortField="@_sortField"
                         SortDir="@_sortDir"
                         SortChanged="OnSortChanged"
                         OnViewDetails="ViewQuoteDetails"
                         OnDownloadPdf="DownloadPdf" />
        </section>
    </div>
}

@inject IQuoteApiService  QuoteApiService
@inject IClientApiService ClientApiService
@inject DialogService     DialogService
@inject NotificationService NotificationService
@inject NavigationManager NavigationManager
@inject IJSRuntime        JSRuntime
@inject PermissionService PermissionService
@inject IConfiguration    Configuration

@code {
    private List<QuoteDetailDto>? _quotes;
    private List<ClientDto>?      _clients;
    private string _searchText   = string.Empty;
    private string _statusFilter = string.Empty;
    private int    _clientFilter = 0;
    private bool   _isLoading    = false;
    private bool   _checkingAccess = true;
    private bool   _hasAccess      = false;
    private bool   _canCreate, _canEdit, _canDelete;
    private string _sortField = "createdAt";
    private FsSortHeader.SortDirection _sortDir = FsSortHeader.SortDirection.Desc;

    // ── SignalR ───────────────────────────────────────────────────────────────
    private HubConnection? _hubConnection;
    private record QuoteStatusChangedEvent(int QuoteId, string QuoteNumber, string ClientName, string NewStatus);

    // ── Filtrado + ordenamiento ───────────────────────────────────────────────
    private IEnumerable<QuoteDetailDto> _filteredQuotes =>
        _quotes?.Where(q =>
            (string.IsNullOrWhiteSpace(_searchText) ||
             q.QuoteNumber.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
             q.ClientName.Contains(_searchText, StringComparison.OrdinalIgnoreCase))
            && (string.IsNullOrEmpty(_statusFilter) || q.Status == _statusFilter)
            && (_clientFilter == 0 || q.ClientId == _clientFilter)
        ) ?? Enumerable.Empty<QuoteDetailDto>();

    private IEnumerable<QuoteDetailDto> _sortedQuotes => ApplySort(_filteredQuotes);

    private IEnumerable<QuoteDetailDto> ApplySort(IEnumerable<QuoteDetailDto> q) =>
        (_sortField, _sortDir) switch
        {
            ("number",    FsSortHeader.SortDirection.Asc)  => q.OrderBy(x => x.QuoteNumber),
            ("number",    FsSortHeader.SortDirection.Desc) => q.OrderByDescending(x => x.QuoteNumber),
            ("client",    FsSortHeader.SortDirection.Asc)  => q.OrderBy(x => x.ClientName),
            ("client",    FsSortHeader.SortDirection.Desc) => q.OrderByDescending(x => x.ClientName),
            ("createdAt", FsSortHeader.SortDirection.Asc)  => q.OrderBy(x => x.CreatedAt),
            ("createdAt", FsSortHeader.SortDirection.Desc) => q.OrderByDescending(x => x.CreatedAt),
            ("validUntil", FsSortHeader.SortDirection.Asc) => q.OrderBy(x => x.ValidUntil ?? DateTime.MaxValue),
            ("validUntil", FsSortHeader.SortDirection.Desc)=> q.OrderByDescending(x => x.ValidUntil ?? DateTime.MinValue),
            ("status",    FsSortHeader.SortDirection.Asc)  => q.OrderBy(x => x.Status),
            ("status",    FsSortHeader.SortDirection.Desc) => q.OrderByDescending(x => x.Status),
            ("total",     FsSortHeader.SortDirection.Asc)  => q.OrderBy(x => x.Total),
            ("total",     FsSortHeader.SortDirection.Desc) => q.OrderByDescending(x => x.Total),
            ("createdBy", FsSortHeader.SortDirection.Asc)  => q.OrderBy(x => x.CreatedByUserName),
            ("createdBy", FsSortHeader.SortDirection.Desc) => q.OrderByDescending(x => x.CreatedByUserName),
            _                                              => q.OrderByDescending(x => x.CreatedAt),
        };

    // ── Handlers de filtros (métodos nombrados — evita CS1660) ────────────────
    private void OnSearchChanged(string v)       => _searchText   = v;
    private void OnStatusChanged(string v)       => _statusFilter = v;
    private void OnClientFilterChanged(int v)    => _clientFilter = v;
    private void OnSortChanged((string field, FsSortHeader.SortDirection dir) s)
    {
        _sortField = s.field;
        _sortDir   = s.dir;
    }

    // ── Ciclo de vida ─────────────────────────────────────────────────────────
    protected override async Task OnInitializedAsync()
    {
        var canView = await PermissionService.HasPermissionAsync("quotes.view");
        if (!canView)
        {
            _checkingAccess = false;
            _hasAccess = false;
            NavigationManager.NavigateTo("/dashboard", forceLoad: true);
            return;
        }

        _hasAccess      = true;
        _checkingAccess = false;

        _canCreate = await PermissionService.HasPermissionAsync("quotes.create");
        _canEdit   = await PermissionService.HasPermissionAsync("quotes.edit");
        _canDelete = await PermissionService.HasPermissionAsync("quotes.delete");

        await LoadData();
        await ConnectSignalR();
    }

    // ── SignalR ───────────────────────────────────────────────────────────────
    private async Task ConnectSignalR()
    {
        try
        {
            var apiBase = Configuration["WebApiAddress"]!.TrimEnd('/');
            var hubUrl  = $"{apiBase}/hubs/quotes";

            _hubConnection = new HubConnectionBuilder()
                .WithUrl(hubUrl)
                .WithAutomaticReconnect(new[] { TimeSpan.Zero, TimeSpan.FromSeconds(2), TimeSpan.FromSeconds(5), TimeSpan.FromSeconds(10) })
                .Build();

            _hubConnection.On<QuoteStatusChangedEvent>("QuoteStatusChanged", async (data) =>
            {
                var quote = _quotes?.FirstOrDefault(q => q.Id == data.QuoteId);
                if (quote != null) quote.Status = data.NewStatus;
                else await InvokeAsync(LoadData);

                var emoji = data.NewStatus == "Aceptada" ? "✅" : "❌";
                Notify($"{emoji} Cotización {data.NewStatus}", $"{data.QuoteNumber} — {data.ClientName}",
                    data.NewStatus == "Aceptada" ? NotificationSeverity.Success : NotificationSeverity.Warning);

                await InvokeAsync(StateHasChanged);
            });

            _hubConnection.Reconnected += async (_) => await _hubConnection.InvokeAsync("JoinInternalGroup");

            await _hubConnection.StartAsync();
            await _hubConnection.InvokeAsync("JoinInternalGroup");
        }
        catch (Exception ex) { Console.WriteLine($"❌ SignalR error: {ex.Message}"); }
    }

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection is not null)
        {
            try { await _hubConnection.InvokeAsync("LeaveInternalGroup"); } catch { }
            await _hubConnection.DisposeAsync();
        }
    }

    // ── Carga de datos ────────────────────────────────────────────────────────
    private async Task LoadData()
    {
        _isLoading = true;
        try
        {
            var qt = QuoteApiService.GetQuotesAsync();
            var ct = ClientApiService.GetClientsAsync();
            await Task.WhenAll(qt, ct);
            _quotes  = await qt;
            _clients = await ct;
        }
        catch (Exception ex) { Notify("Error", $"Error al cargar: {ex.Message}", NotificationSeverity.Error); }
        finally { _isLoading = false; }
    }

    // ── Acciones ──────────────────────────────────────────────────────────────
    private async Task ShowCreateModal()
    {
        var r = await DialogService.OpenAsync<QuoteForm>("Nueva Cotización",
            options: new DialogOptions { Width = "1000px", Height = "auto", Resizable = true, Draggable = false, CloseDialogOnOverlayClick = false });
        if (r == true) await LoadData();
    }

    private void ViewQuoteDetails(int id) => NavigationManager.NavigateTo($"/cotizaciones/{id}");

    private async Task DownloadPdf(int id)
    {
        try
        {
            var pdf = await QuoteApiService.GenerateQuotePdfAsync(id);
            if (pdf?.Length > 0)
            {
                await JSRuntime.InvokeVoidAsync("downloadFile", $"Cotizacion-{id}.pdf", Convert.ToBase64String(pdf));
                Notify("Éxito", "PDF descargado.", NotificationSeverity.Success);
            }
            else Notify("Error", "No se pudo generar el PDF.", NotificationSeverity.Error);
        }
        catch (Exception ex) { Notify("Error", ex.Message, NotificationSeverity.Error); }
    }

    private async Task ClearFilters()
    {
        _searchText   = string.Empty;
        _statusFilter = string.Empty;
        _clientFilter = 0;
        await LoadData();
    }

    private void Notify(string t, string m, NotificationSeverity s) =>
        NotificationService.Notify(new NotificationMessage { Severity = s, Summary = t, Detail = m, Duration = 5000 });
}
