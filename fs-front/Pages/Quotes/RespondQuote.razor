@page "/responder-cotizacion/{Token}"
@layout LayoutPrincipal
@using fs_front.DTO

<PageTitle>Cotización - Finesoft</PageTitle>

<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600&family=DM+Mono:wght@500&display=swap" rel="stylesheet" />

<style>
    .fs-root { min-height:100vh; background:#f4f4f5; display:flex; align-items:center; justify-content:center; padding:28px 16px; font-family:'DM Sans',sans-serif; }
    .fs-card { width:100%; max-width:480px; background:#ffffff; border:1px solid #e4e4e7; border-radius:16px; overflow:hidden; box-shadow:0 2px 12px rgba(0,0,0,.06); }
    .fs-header { padding:20px 28px; border-bottom:1px solid #f0f0f0; display:flex; align-items:center; justify-content:space-between; background:#fff; }
    .fs-logo-img { max-width:130px; height:auto; display:block; }
    .fs-badge { background:#f4f4f5; color:#71717a; font-size:11px; font-weight:600; padding:4px 10px; border-radius:20px; letter-spacing:.5px; font-family:'DM Mono',monospace; white-space:nowrap; }
    .fs-body { padding:26px 28px; }
    .fs-quote-num { font-family:'DM Mono',monospace; font-size:12px; color:#7c3aed; font-weight:500; margin-bottom:4px; letter-spacing:.3px; }
    .fs-client { font-size:20px; font-weight:600; color:#18181b; margin-bottom:22px; line-height:1.3; }
    .fs-amounts { background:#fafafa; border:1px solid #e4e4e7; border-radius:10px; padding:4px 0; margin-bottom:18px; }
    .fs-row { display:flex; justify-content:space-between; align-items:center; padding:10px 18px; border-bottom:1px solid #f0f0f0; font-size:13px; }
    .fs-row:last-child { border-bottom:none; }
    .fs-row-label { color:#71717a; }
    .fs-row-value { color:#3f3f46; font-weight:500; }
    .fs-row-total-label { color:#18181b; font-weight:600; font-size:14px; }
    .fs-row-total-value { color:#7c3aed; font-weight:700; font-size:16px; font-family:'DM Mono',monospace; }
    .fs-valid { font-size:12px; color:#a1a1aa; margin-bottom:18px; }
    .fs-valid strong { color:#71717a; }
    .fs-expired-pill { display:inline-block; background:#fff7ed; border:1px solid #fed7aa; color:#c2410c; font-size:10px; font-weight:600; padding:2px 8px; border-radius:12px; margin-left:6px; vertical-align:middle; }
    .fs-label { font-size:11px; font-weight:600; color:#a1a1aa; text-transform:uppercase; letter-spacing:.8px; margin-bottom:8px; display:block; }
    .fs-textarea { width:100%; background:#fafafa; border:1px solid #e4e4e7; border-radius:8px; color:#18181b; font-family:'DM Sans',sans-serif; font-size:13px; padding:10px 14px; resize:none; outline:none; transition:border-color .2s; box-sizing:border-box; line-height:1.5; }
    .fs-textarea:focus { border-color:#7c3aed; background:#fff; }
    .fs-textarea::placeholder { color:#d4d4d8; }
    .fs-actions { margin-top:18px; }
    .fs-btn-accept { width:100%; background:#7c3aed; color:#fff; border:none; border-radius:8px; padding:13px; font-size:14px; font-weight:600; cursor:pointer; font-family:'DM Sans',sans-serif; transition:background .2s; margin-bottom:8px; display:flex; align-items:center; justify-content:center; gap:8px; letter-spacing:.1px; }
    .fs-btn-accept:hover:not(:disabled) { background:#6d28d9; }
    .fs-btn-accept:disabled { opacity:.5; cursor:not-allowed; }
    .fs-btn-reject { width:100%; background:transparent; color:#a1a1aa; border:1px solid #e4e4e7; border-radius:8px; padding:13px; font-size:14px; font-weight:500; cursor:pointer; font-family:'DM Sans',sans-serif; transition:border-color .2s,color .2s; display:flex; align-items:center; justify-content:center; gap:8px; }
    .fs-btn-reject:hover:not(:disabled) { border-color:#fca5a5; color:#dc2626; }
    .fs-btn-reject:disabled { opacity:.4; cursor:not-allowed; }
    .fs-spinner { width:14px; height:14px; border:2px solid rgba(255,255,255,.4); border-top-color:#fff; border-radius:50%; animation:fs-spin .6s linear infinite; display:inline-block; flex-shrink:0; }
    @@keyframes fs-spin { to { transform:rotate(360deg); } }
    .fs-success { text-align:center; padding:12px 0 4px; }
    .fs-success-icon { font-size:36px; margin-bottom:12px; }
    .fs-success-title { font-size:17px; font-weight:600; color:#18181b; margin-bottom:6px; }
    .fs-success-desc { font-size:13px; color:#71717a; line-height:1.5; }
    .fs-state-body { padding:40px 28px; text-align:center; }
    .fs-state-icon { font-size:40px; margin-bottom:14px; }
    .fs-state-title { font-size:18px; font-weight:600; color:#18181b; margin-bottom:8px; }
    .fs-state-desc { font-size:13px; color:#71717a; line-height:1.5; margin-bottom:0; }
    .fs-status-pill { display:inline-block; background:#f0fdf4; border:1px solid #bbf7d0; color:#16a34a; font-size:12px; font-weight:600; padding:4px 12px; border-radius:20px; margin-top:14px; }
    .fs-contact-btn { display:inline-block; margin-top:20px; padding:11px 28px; background:#7c3aed; color:#fff; font-size:13px; font-weight:600; text-decoration:none; border-radius:8px; font-family:'DM Sans',sans-serif; }
    .fs-footer { padding:14px 28px; border-top:1px solid #f0f0f0; background:#fafafa; text-align:center; }
    .fs-footer-text { font-size:12px; color:#a1a1aa; }
    .fs-footer-text a { color:#7c3aed; text-decoration:none; }
</style>

<div class="fs-root">
    <div class="fs-card">

        @* ── Header con logo siempre visible ── *@
        <div class="fs-header">
            <img src="/images/LogoFinesoftt.png" alt="Finesoft" class="fs-logo-img" />
            @if (_quote != null)
            {
                <span class="fs-badge">@_quote.QuoteNumber</span>
            }
        </div>

        @* ── Contenido condicional según estado ── *@
        @if (_isLoading)
        {
            <RespondLoading />
        }
        else if (_quote == null)
        {
            <div class="fs-state-body">
                <div class="fs-state-icon">⚠️</div>
                <div class="fs-state-title">Enlace no válido</div>
                <p class="fs-state-desc">Esta cotización no existe o el enlace ha expirado.</p>
                <a href="mailto:informes@finesoft.com.mx" class="fs-contact-btn">Contactar soporte</a>
            </div>
        }
        else if (_quote.Status == "Aceptada" || _quote.Status == "Rechazada")
        {
            <RespondAlreadyAnswered Status="@_quote.Status" UpdatedAt="@_quote.UpdatedAt" />
        }
        else
        {
            <RespondForm QuoteNumber="@_quote.QuoteNumber"
                         ClientName="@_quote.ClientName"
                         Subtotal="@_quote.Subtotal"
                         Tax="@_quote.Tax"
                         Total="@_quote.Total"
                         ValidUntil="@_quote.ValidUntil"
                         HasResponded="@_hasResponded"
                         IsSubmitting="@_isSubmitting"
                         OnSubmit="SubmitResponse" />
        }

        @* ── Footer siempre visible ── *@
        <div class="fs-footer">
            <span class="fs-footer-text">
                © 2026 Finesoft ·
                <a href="mailto:informes@finesoft.com.mx">informes@finesoft.com.mx</a>
            </span>
        </div>

    </div>
</div>

@inject HttpClient Http
@inject IJSRuntime  JS

@code {
    [Parameter] public string Token { get; set; } = string.Empty;

    private QuoteDetailDto? _quote;
    private bool _isLoading    = true;
    private bool _isSubmitting = false;
    private bool _hasResponded = false;

    protected override async Task OnInitializedAsync() => await LoadQuote();

    private async Task LoadQuote()
    {
        _isLoading = true;
        try   { _quote = await Http.GetFromJsonAsync<QuoteDetailDto>($"api/quotes/public/{Token}"); }
        catch (Exception ex) { Console.WriteLine($"Error al cargar cotización: {ex.Message}"); _quote = null; }
        finally { _isLoading = false; }
    }

    private async Task SubmitResponse((string status, string comments) args)
    {
        var (status, comments) = args;

        var confirmed = await JS.InvokeAsync<bool>("confirm",
            $"¿Confirmas {(status == "Aceptada" ? "aceptar" : "rechazar")} esta cotización?");
        if (!confirmed) return;

        _isSubmitting = true;
        try
        {
            var dto      = new { Status = status, Comments = comments };
            var response = await Http.PostAsJsonAsync($"api/quotes/public/{Token}/respond", dto);

            if (response.IsSuccessStatusCode) _hasResponded = true;
            else await JS.InvokeVoidAsync("alert", "Error al enviar. Intenta nuevamente.");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
            await JS.InvokeVoidAsync("alert", "Error de conexión.");
        }
        finally { _isSubmitting = false; }
    }
}
