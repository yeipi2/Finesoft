@page "/reportes"
@using fs_front.DTO
@using fs_front.Pages.Reports
@using fs_front.Components.Reports
@inject IReportApiService    ReportApiService
@inject NotificationService  NotificationService
@inject PermissionService    PermissionService
@inject NavigationManager    NavigationManager

@attribute [Authorize]

<PageTitle>Finesoft - Reportes</PageTitle>

@* ── Estilos compartidos de todos los sub-componentes ── *@
<ReportsStyles />

@* ── Guard de acceso ── *@
@if (_checkingAccess)
{
    <div style="position:fixed;top:0;left:0;width:100vw;height:100vh;
                background:white;z-index:9999;
                display:flex;align-items:center;justify-content:center;">
        <div class="spinner-border text-primary" role="status"></div>
    </div>
}
else if (!_hasAccess)
{
    <div></div>
}
else
{
    <div class="container px-xl-5 py-4">
        <section class="container-fluid p-xl-5">

            @* ── Header con fechas ── *@
            <ReportsHeader StartDate="@StartDate"
                           EndDate="@EndDate"
                           StartDateChanged="OnStartDateChanged"
                           EndDateChanged="OnEndDateChanged"
                           OnRefresh="LoadData" />

            @if (isLoading)
            {
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
            }
            else
            {
                @* ── KPI cards ── *@
                <StatGrid class="mb-5">
                    <StatCard Title="Ingresos Totales"  Value="@RevenueText"        Accent="StatCard.StatAccent.Info"    IconClass="bi bi-cash-stack" />
                    <StatCard Title="Proyectos Activos" Value="@ActiveProjectsText" Accent="StatCard.StatAccent.Primary" IconClass="bi bi-kanban" />
                    <StatCard Title="Tickets Abiertos"  Value="@OpenTicketsText"    Accent="StatCard.StatAccent.Primary" IconClass="bi bi-ticket-perforated" />
                    <StatCard Title="Clientes Totales"  Value="@TotalClientsText"   Accent="StatCard.StatAccent.Primary" IconClass="bi bi-people" />
                </StatGrid>

                @* ── Tabs ── *@
                <ReportsTabs ActiveTab="@activeTab"
                             ActiveTabChanged="OnTabChanged" />

                @* ── Contenido de cada tab ── *@
                <div class="tab-content">
                    @if (activeTab == "charts")
                    {
                        <ChartsTab ShortTrends="@shortTrends"
                                   TicketStatusChart="@ticketStatusChart"
                                   TicketColors="@TicketColors"
                                   TopClients="@topClients"
                                   ClientReports="@clientReports"
                                   ProjectReports="@projectReports"
                                   FinancialSummary="@FinancialSummaryData" />
                    }
                    else if (activeTab == "financial")
                    {
                        <FinancialTab Report="@financialReport"
                                      RevenueTrends="@revenueTrends" />
                    }
                    else if (activeTab == "performance")
                    {
                        <PerformanceTab Metrics="@performanceMetrics"
                                        TicketStatusChart="@ticketStatusChart" />
                    }
                    else if (activeTab == "clients")
                    {
                        <ClientsTab ClientReports="@clientReports" />
                    }
                    else if (activeTab == "projects")
                    {
                        <ProjectsTab ProjectReports="@projectReports" />
                    }
                    else if (activeTab == "employees")
                    {
                        <EmployeesTab UserReports="@userReports" />
                    }
                </div>
            }

        </section>
    </div>
}

@code {
    // ── Estado ──────────────────────────────────────────────────────────
    private DateTime? StartDate;
    private DateTime? EndDate;
    private string    activeTab      = "charts";
    private bool      isLoading      = true;
    private bool      _checkingAccess = true;
    private bool      _hasAccess      = false;

    // ── Datos de la API ─────────────────────────────────────────────────
    private DashboardStatsDto?          dashboardStats;
    private FinancialReportDto?         financialReport;
    private PerformanceMetricsDto?      performanceMetrics;
    private List<UserReportDto>?        userReports;
    private List<ClientReportDto>?      clientReports;
    private List<ProjectReportDto>?     projectReports;
    private List<RevenueTrendDto>?      revenueTrends;
    private List<TicketStatusChartDto>? ticketStatusChart;
    private List<TopClientDto>?         topClients;
    private List<ShortTrendItem>?       shortTrends;

    // ── Propiedades computadas ───────────────────────────────────────────
    private string   RevenueText        => dashboardStats is null ? "-" : $"${dashboardStats.TotalRevenue:N2}";
    private string   ActiveProjectsText => dashboardStats?.ActiveProjects.ToString() ?? "-";
    private string   OpenTicketsText    => dashboardStats?.OpenTickets.ToString()    ?? "-";
    private string   TotalClientsText   => dashboardStats?.TotalClients.ToString()   ?? "-";

    private string[] TicketColors =>
        ticketStatusChart?.Select(t => t.Color).ToArray() ?? Array.Empty<string>();

    private List<FinSummaryItem>? FinancialSummaryData =>
        financialReport is null ? null : new()
        {
            new() { Label = "Facturado", Amount = financialReport.TotalInvoiced },
            new() { Label = "Pagado",    Amount = financialReport.TotalPaid     },
            new() { Label = "Pendiente", Amount = financialReport.TotalPending  },
            new() { Label = "Vencido",   Amount = financialReport.TotalOverdue  },
        };

    // ── Handlers de eventos ─────────────────────────────────────────────
    private void OnStartDateChanged(DateTime? d) => StartDate = d;
    private void OnEndDateChanged(DateTime? d)   => EndDate   = d;
    private void OnTabChanged(string tab)        => activeTab = tab;

    // ── Ciclo de vida ────────────────────────────────────────────────────
    protected override async Task OnInitializedAsync()
    {
        var canView = await PermissionService.HasPermissionAsync("reports.view");
        if (!canView)
        {
            _checkingAccess = false;
            NavigationManager.NavigateTo("/dashboard", forceLoad: true);
            return;
        }
        _hasAccess      = true;
        _checkingAccess = false;

        var now = DateTime.Now;
        StartDate = new DateTime(now.Year, now.Month, 1);
        EndDate   = StartDate.Value.AddMonths(1).AddDays(-1);
        await LoadData();
    }

    // ── Carga de datos ───────────────────────────────────────────────────
    private async Task LoadData()
    {
        isLoading = true;
        StateHasChanged();
        try
        {
            var t1 = ReportApiService.GetDashboardStatsAsync();
            var t2 = ReportApiService.GetFinancialReportAsync(StartDate, EndDate);
            var t3 = ReportApiService.GetPerformanceMetricsAsync(StartDate, EndDate);
            var t4 = ReportApiService.GetRevenueTrendAsync(12);
            var t5 = ReportApiService.GetTicketsByStatusAsync();
            var t6 = ReportApiService.GetReportsByClientAsync(StartDate, EndDate);
            var t7 = ReportApiService.GetReportsByProjectAsync(StartDate, EndDate);
            var t8 = ReportApiService.GetReportsByUserAsync(StartDate, EndDate);
            var t9 = ReportApiService.GetTopClientsAsync(5);
            await Task.WhenAll(t1, t2, t3, t4, t5, t6, t7, t8, t9);

            dashboardStats     = await t1;
            financialReport    = await t2;
            performanceMetrics = await t3;
            revenueTrends      = await t4;
            ticketStatusChart  = await t5;
            clientReports      = await t6;
            projectReports     = await t7;
            userReports        = await t8;
            topClients         = await t9;

            shortTrends = revenueTrends?.Select(t => new ShortTrendItem
            {
                ShortMonth = ReportsHelpers.ShortenMonth(t.Month),
                Revenue    = t.Revenue
            }).ToList();
        }
        catch (Exception ex)
        {
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary  = "Error",
                Detail   = "No se pudieron cargar los reportes.",
                Duration = 4000
            });
            Console.WriteLine($"[Reportes] Error: {ex}");
        }
        finally
        {
            isLoading = false;
        }
    }
}
