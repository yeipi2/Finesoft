@using fs_front.DTO

<section class="container px-0">
    <EditForm Model="_ticketDto" OnValidSubmit="HandleSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary class="alert alert-danger" />

        <div class="row">
            <div class="col-md-12">
                <div class="mb-3">
                    <label for="Title" class="form-label fw-bold small">Título *</label>
                    <InputText id="Title" class="form-control" placeholder="Problema con el sistema de facturación"
                               @bind-Value="_ticketDto.Title" />
                    <ValidationMessage For="@(() => _ticketDto.Title)" />
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="mb-3">
                    <label for="Description" class="form-label fw-bold small">Descripción *</label>
                    <InputTextArea id="Description" class="form-control" rows="4"
                                   placeholder="Describe detalladamente el problema o solicitud..."
                                   @bind-Value="_ticketDto.Description" />
                    <ValidationMessage For="@(() => _ticketDto.Description)" />
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="mb-3">
                    <label for="ProjectId" class="form-label fw-bold small">Proyecto *</label>
                    @if (_isLoadingProjects)
                    {
                        <div class="d-flex align-items-center">
                            <span class="spinner-border spinner-border-sm me-2"></span>
                            <span>Cargando proyectos...</span>
                        </div>
                    }
                    else if (_projects == null || !_projects.Any())
                    {
                        <div class="alert alert-warning mb-0">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            No se pudieron cargar los proyectos. Contacta a un administrador.
                        </div>
                    }
                    else
                    {
                        <RadzenAutoComplete @bind-Value="_selectedProjectName"
                                            Data="_projects"
                                            TextProperty="Name"
                                            Placeholder="Escribe para buscar un proyecto..."
                                            Change="@OnProjectSelected"
                                            Style="width: 100%; display: block;"
                                            Class="form-control"
                                            FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                                            FilterOperator="StringFilterOperator.Contains"
                                            AllowClear="true">
                            <Template Context="project">
                                @{
                                    var proj = project as ProjectDetailDto;
                                    <div>
                                        <strong>@proj?.Name</strong>
                                        @if (!string.IsNullOrEmpty(proj?.Client?.CompanyName))
                                        {
                                            <span class="text-muted"> - @proj.Client.CompanyName</span>
                                        }
                                    </div>
                                }
                            </Template>
                        </RadzenAutoComplete>
                        <ValidationMessage For="@(() => _ticketDto.ProjectId)" />

                        @if (_ticketDto.ProjectId > 0 && _selectedProject != null)
                        {
                            <small class="text-success mt-1 d-block">
                                ✓ Proyecto seleccionado: <strong>@_selectedProject.Name</strong>
                                @if (!string.IsNullOrEmpty(_selectedProject.Client?.CompanyName))
                                {
                                    <span> (@_selectedProject.Client.CompanyName)</span>
                                }
                            </small>
                        }
                    }
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-4">
                <div class="mb-3">
                    <label for="Priority" class="form-label fw-bold small">Prioridad *</label>
                    <select id="Priority" class="form-select" @bind="_ticketDto.Priority">
                        <option value="Baja">Baja</option>
                        <option value="Media">Media</option>
                        <option value="Alta">Alta</option>
                        <option value="Urgente">Urgente</option>
                    </select>
                    <ValidationMessage For="@(() => _ticketDto.Priority)" />
                </div>
            </div>

            <div class="col-md-4">
                <div class="mb-3">
                    <label for="Status" class="form-label fw-bold small">Estado *</label>
                    <select id="Status" class="form-select" @bind="_ticketDto.Status">
                        <option value="Abierto">Abierto</option>
                        <option value="En Progreso">En Progreso</option>
                        <option value="En Revisión">En Revisión</option>
                        <option value="Cerrado">Cerrado</option>
                    </select>
                    <ValidationMessage For="@(() => _ticketDto.Status)" />
                </div>
            </div>

            <div class="col-md-4">
                <div class="mb-3">
                    <label for="AssignedTo" class="form-label fw-bold small">Asignar a</label>
                    @if (_isLoadingUsers)
                    {
                        <div class="d-flex align-items-center">
                            <span class="spinner-border spinner-border-sm me-2"></span>
                            <span>Cargando usuarios...</span>
                        </div>
                    }
                    else if (_users == null || !_users.Any())
                    {
                        <select id="AssignedTo" class="form-select" disabled>
                            <option value="">-- Sin asignar --</option>
                        </select>
                        <small class="text-muted">No se pudieron cargar usuarios</small>
                    }
                    else
                    {
                        <select id="AssignedTo" class="form-select" @bind="_ticketDto.AssignedToUserId">
                            <option value="">-- Sin asignar --</option>
                            @foreach (var user in _users)
                            {
                                <option value="@user.Id">@user.UserName (@user.RoleName)</option>
                            }
                        </select>
                    }
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="EstimatedHours" class="form-label fw-bold small">Horas Estimadas</label>
                    <InputNumber id="EstimatedHours" class="form-control" placeholder="0.00"
                                 @bind-Value="_ticketDto.EstimatedHours" />
                    <ValidationMessage For="@(() => _ticketDto.EstimatedHours)" />
                </div>
            </div>

            @if (_isEditMode)
            {
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="ActualHours" class="form-label fw-bold small">Horas Reales</label>
                        <InputNumber id="ActualHours" class="form-control" placeholder="0.00"
                                     @bind-Value="_ticketDto.ActualHours" />
                        <ValidationMessage For="@(() => _ticketDto.ActualHours)" />
                    </div>
                </div>
            }
        </div>

        <div class="d-flex justify-content-end gap-2 mt-4">
            <button type="button" class="btn btn-secondary" @onclick="Cancel">Cancelar</button>
            <button type="submit" class="btn btn-primary" disabled="@(_isSaving || _isLoadingProjects || _projects == null || !_projects.Any())">
                @if (_isSaving)
                {
                    <span class="spinner-border spinner-border-sm me-2"></span>
                }
                <i class="bi bi-check-lg"></i>
                @(_isEditMode ? "Actualizar Ticket" : "Crear Ticket")
            </button>
        </div>

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <div class="alert alert-danger mt-3">
                @_errorMessage
            </div>
        }
    </EditForm>
</section>

@inject ITicketApiService TicketApiService
@inject IProjectApiService ProjectApiService
@inject IUserApiService UserApiService
@inject DialogService DialogService
@inject NotificationService NotificationService

@code {
    [Parameter] public int? TicketId { get; set; }

    private TicketDto _ticketDto = new();
    private List<ProjectDetailDto>? _projects;
    private List<UserDto>? _users;

    // Para el autocompletado
    private string? _selectedProjectName;
    private ProjectDetailDto? _selectedProject;

    private bool _isSaving = false;
    private bool _isLoadingProjects = false;
    private bool _isLoadingUsers = false;
    private string? _errorMessage;
    private bool _isEditMode => TicketId.HasValue;

    protected override async Task OnInitializedAsync()
    {
        await LoadInitialData();

        if (_isEditMode)
        {
            await LoadTicket();
        }
        else
        {
            _ticketDto = new TicketDto
            {
                Status = "Abierto",
                Priority = "Media",
                ProjectId = 0,
                ServiceId = 0
            };
        }
    }

    private async Task LoadInitialData()
    {
        _isLoadingProjects = true;
        _isLoadingUsers = true;
        StateHasChanged();

        try
        {
            // ⭐ CAMBIO: Cargar proyectos con manejo de errores
            try
            {
                _projects = await ProjectApiService.GetProjectsAsync();
                Console.WriteLine($"✅ Proyectos cargados: {_projects?.Count ?? 0}");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"❌ Error al cargar proyectos: {ex.Message}");
                _projects = new List<ProjectDetailDto>(); // Lista vacía para evitar null
                // No mostramos error aquí, solo en el UI
            }

            // ⭐ CAMBIO: Cargar usuarios con manejo de errores
            try
            {
                _users = await UserApiService.GetUsersAsync();
                Console.WriteLine($"✅ Usuarios cargados: {_users?.Count ?? 0}");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"❌ Error al cargar usuarios: {ex.Message}");
                _users = new List<UserDto>(); // Lista vacía para evitar null
                // Campo de asignación será opcional de todas formas
            }
        }
        finally
        {
            _isLoadingProjects = false;
            _isLoadingUsers = false;
            StateHasChanged();
        }
    }

    private async Task LoadTicket()
    {
        try
        {
            var ticket = await TicketApiService.GetTicketByIdAsync(TicketId!.Value);
            if (ticket != null)
            {
                _ticketDto = new TicketDto
                {
                    Id = ticket.Id,
                    Title = ticket.Title,
                    Description = ticket.Description,
                    ProjectId = ticket.ProjectId,
                    ServiceId = ticket.ServiceId,
                    Status = ticket.Status,
                    Priority = ticket.Priority,
                    AssignedToUserId = ticket.AssignedToUserId,
                    EstimatedHours = ticket.EstimatedHours,
                    ActualHours = ticket.ActualHours
                };

                // Establecer el nombre del proyecto seleccionado para el autocompletado
                _selectedProject = _projects?.FirstOrDefault(p => p.Id == ticket.ProjectId);
                _selectedProjectName = _selectedProject?.Name;
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error al cargar ticket: {ex.Message}";
        }
    }

    private void OnProjectSelected(object value)
    {
        if (value == null)
        {
            _ticketDto.ProjectId = 0;
            _selectedProject = null;
            _selectedProjectName = null;
            return;
        }

        var projectName = value.ToString();
        _selectedProject = _projects?.FirstOrDefault(p =>
            p.Name.Equals(projectName, StringComparison.OrdinalIgnoreCase));

        if (_selectedProject != null)
        {
            _ticketDto.ProjectId = _selectedProject.Id;
            _selectedProjectName = _selectedProject.Name;
            _ticketDto.ServiceId = 0;
        }
        else
        {
            _ticketDto.ProjectId = 0;
            _selectedProjectName = projectName;
        }

        StateHasChanged();
    }

    private async Task HandleSubmit()
    {
        _isSaving = true;
        _errorMessage = null;
        StateHasChanged();

        try
        {
            // Validar que se haya seleccionado un proyecto válido
            if (_ticketDto.ProjectId <= 0)
            {
                _errorMessage = "Debe seleccionar un proyecto válido de la lista.";
                _isSaving = false;
                StateHasChanged();
                return;
            }

            if (_isEditMode)
            {
                var result = await TicketApiService.UpdateTicketAsync(TicketId!.Value, _ticketDto);
                if (result.Success)
                {
                    ShowNotification("Éxito", "Ticket actualizado correctamente.", NotificationSeverity.Success);
                    DialogService.Close(true);
                }
                else
                {
                    _errorMessage = result.ErrorMessage ?? "No se pudo actualizar el ticket.";
                }
            }
            else
            {
                var result = await TicketApiService.CreateTicketAsync(_ticketDto);
                if (result.Success)
                {
                    ShowNotification("Éxito", "Ticket creado correctamente.", NotificationSeverity.Success);
                    DialogService.Close(true);
                }
                else
                {
                    _errorMessage = result.ErrorMessage ?? "No se pudo crear el ticket.";
                }
            }
        }
        catch (HttpRequestException httpEx) when (httpEx.StatusCode == System.Net.HttpStatusCode.Forbidden)
        {
            _errorMessage = "No tienes permisos para crear tickets. Contacta a un administrador.";
            Console.WriteLine($"❌ Error 403: {httpEx.Message}");
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error: {ex.Message}";
            Console.WriteLine($"❌ Error al guardar ticket: {ex}");
        }
        finally
        {
            _isSaving = false;
            StateHasChanged();
        }
    }

    private void Cancel()
    {
        DialogService.Close(false);
    }

    private void ShowNotification(string title, string message, NotificationSeverity severity)
    {
        NotificationService.Notify(new NotificationMessage
        {
            Severity = severity,
            Summary = title,
            Detail = message,
            Duration = 4000
        });
    }
}
