@* Modal de creación/edición de ticket.
   Usa: TicketInfoSection + TicketDetailsSection *@
@using fs_front.DTO
@using Radzen
@using Radzen.Blazor

@inject ITicketApiService TicketApiService
@inject IProjectApiService ProjectApiService
@inject IUserApiService UserApiService
@inject DialogService DialogService
@inject NotificationService NotificationService

<div style="max-width: 900px; margin: 0 auto;">
    <EditForm Model="_ticketDto" OnValidSubmit="HandleSubmit">
        <DataAnnotationsValidator />

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <div class="alert alert-danger mb-3" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>@_errorMessage
            </div>
        }

        <div class="accordion mb-3" id="ticketAccordion">

            <TicketInfoSection Model="_ticketDto"
                               IsComplete="_section1Complete"
                               OnChange="ValidateSections" />

            <TicketDetailsSection Model="_ticketDto"
                                  IsComplete="_section2Complete"
                                  IsEditMode="_isEditMode"
                                  IsLoadingProjects="_isLoadingProjects"
                                  IsLoadingUsers="_isLoadingUsers"
                                  Projects="_projects"
                                  FilteredProjects="_filteredProjects"
                                  SelectedProject="_selectedProject"
                                  ProjectSearchText="@_projectSearchText"
                                  Employees="_employees"
                                  OnProjectSearchInput="OnProjectSearchInput"
                                  OnProjectSelected="SelectProject" />

        </div>

        <div class="d-flex justify-content-between align-items-center mt-3">
            <div>
                @if (!_allSectionsComplete)
                {
                    <small class="text-danger">
                        <i class="bi bi-exclamation-circle me-1"></i>
                        Complete las secciones obligatorias
                    </small>
                }
            </div>
            <div class="d-flex gap-2">
                <button type="button" class="btn btn-secondary btn-sm" @onclick="Cancel">Cancelar</button>
                <button type="submit" class="btn btn-primary btn-sm"
                        disabled="@(_isSaving || _isLoadingProjects)">
                    @if (_isSaving)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    }
                    <i class="bi bi-check-lg me-1"></i>
                    @(_isEditMode ? "Actualizar Ticket" : "Guardar")
                </button>
            </div>
        </div>

    </EditForm>
</div>

@code {
    [Parameter] public int? TicketId { get; set; }

    // ── Estado interno ────────────────────────────────────────────────────────
    private TicketDto _ticketDto = new();
    private List<ProjectDetailDto>? _projects;
    private List<ProjectDetailDto> _filteredProjects = new();
    private ProjectDetailDto? _selectedProject;
    private string _projectSearchText = string.Empty;
    private List<UserDto>? _employees;

    private bool _isSaving          = false;
    private bool _isLoadingProjects = false;
    private bool _isLoadingUsers    = false;
    private string? _errorMessage;

    private bool _isEditMode       => TicketId.HasValue;
    private bool _section1Complete  = false;
    private bool _section2Complete  => _ticketDto.ProjectId.HasValue && _ticketDto.ProjectId > 0;
    private bool _allSectionsComplete => _section1Complete && _section2Complete;

    // ── Ciclo de vida ─────────────────────────────────────────────────────────
    protected override async Task OnInitializedAsync()
    {
        await LoadInitialData();

        if (_isEditMode)
            await LoadTicket();
        else
            _ticketDto = new TicketDto { Status = "Abierto", Priority = "Media", ProjectId = null, ServiceId = null };

        ValidateSections();
    }

    // ── Carga de datos ────────────────────────────────────────────────────────
    private async Task LoadInitialData()
    {
        _isLoadingProjects = true;
        _isLoadingUsers    = true;
        StateHasChanged();
        try
        {
            try
            {
                _projects        = await ProjectApiService.GetProjectsAsync();
                _filteredProjects = _projects ?? new List<ProjectDetailDto>();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error al cargar proyectos: {ex.Message}");
                _projects         = new List<ProjectDetailDto>();
                _filteredProjects = new List<ProjectDetailDto>();
            }

            try
            {
                var users  = await UserApiService.GetUsersAsync();
                _employees = users?.Where(u => u.RoleName?.Equals("Empleado", StringComparison.OrdinalIgnoreCase) == true).ToList()
                             ?? new List<UserDto>();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error al cargar usuarios: {ex.Message}");
                _employees = new List<UserDto>();
            }
        }
        finally
        {
            _isLoadingProjects = false;
            _isLoadingUsers    = false;
            StateHasChanged();
        }
    }

    private async Task LoadTicket()
    {
        try
        {
            var ticket = await TicketApiService.GetTicketByIdAsync(TicketId!.Value);
            if (ticket != null)
            {
                _ticketDto = new TicketDto
                {
                    Id               = ticket.Id,
                    Title            = ticket.Title,
                    Description      = ticket.Description,
                    ProjectId        = ticket.ProjectId > 0 ? ticket.ProjectId : null,
                    ServiceId        = ticket.ServiceId > 0 ? ticket.ServiceId : null,
                    Status           = ticket.Status,
                    Priority         = ticket.Priority,
                    AssignedToUserId = ticket.AssignedToUserId,
                    EstimatedHours   = ticket.EstimatedHours,
                    ActualHours      = ticket.ActualHours
                };

                if (_ticketDto.ProjectId.HasValue)
                {
                    _selectedProject   = _projects?.FirstOrDefault(p => p.Id == _ticketDto.ProjectId.Value);
                    _projectSearchText = _selectedProject?.Name ?? string.Empty;
                }
            }
        }
        catch (Exception ex) { _errorMessage = $"Error al cargar ticket: {ex.Message}"; }
    }

    // ── Autocomplete de proyecto ──────────────────────────────────────────────
    private void OnProjectSearchInput(ChangeEventArgs e)
    {
        _projectSearchText = e.Value?.ToString() ?? string.Empty;

        if (string.IsNullOrWhiteSpace(_projectSearchText))
        {
            _filteredProjects  = _projects ?? new List<ProjectDetailDto>();
            _selectedProject   = null;
            _ticketDto.ProjectId = null;
        }
        else
        {
            _filteredProjects = (_projects ?? new List<ProjectDetailDto>())
                .Where(p => p.Name.Contains(_projectSearchText, StringComparison.OrdinalIgnoreCase))
                .OrderBy(p => p.Name)
                .ToList();

            var exact = _projects?.FirstOrDefault(p =>
                p.Name.Equals(_projectSearchText, StringComparison.OrdinalIgnoreCase));

            if (exact is null && _selectedProject is not null)
            {
                _selectedProject   = null;
                _ticketDto.ProjectId = null;
            }
        }
        ValidateSections();
    }

    private void SelectProject(ProjectDetailDto project)
    {
        _selectedProject     = project;
        _ticketDto.ProjectId = project.Id;
        _ticketDto.ServiceId = null;
        _projectSearchText   = project.Name;
        ValidateSections();
    }

    // ── Validación ────────────────────────────────────────────────────────────
    private void ValidateSections()
    {
        _section1Complete = !string.IsNullOrWhiteSpace(_ticketDto.Title)
                         && !string.IsNullOrWhiteSpace(_ticketDto.Description);
        StateHasChanged();
    }

    // ── Submit ────────────────────────────────────────────────────────────────
    private async Task HandleSubmit()
    {
        if (!_ticketDto.ProjectId.HasValue || _ticketDto.ProjectId.Value <= 0)
        {
            _errorMessage = "Debe seleccionar un proyecto válido de la lista.";
            StateHasChanged();
            return;
        }

        _isSaving     = true;
        _errorMessage = null;
        StateHasChanged();

        try
        {
            if (_isEditMode)
            {
                var result = await TicketApiService.UpdateTicketAsync(TicketId!.Value, _ticketDto);
                if (result.Success) { Notify("Éxito", "Ticket actualizado correctamente.", NotificationSeverity.Success); DialogService.Close(true); }
                else _errorMessage = result.ErrorMessage ?? "No se pudo actualizar el ticket.";
            }
            else
            {
                var result = await TicketApiService.CreateTicketAsync(_ticketDto);
                if (result.Success) { Notify("Éxito", "Ticket creado correctamente.", NotificationSeverity.Success); DialogService.Close(true); }
                else _errorMessage = result.ErrorMessage ?? "No se pudo crear el ticket.";
            }
        }
        catch (HttpRequestException httpEx) when (httpEx.StatusCode == System.Net.HttpStatusCode.Forbidden)
        {
            _errorMessage = "No tienes permisos para realizar esta acción. Contacta a un administrador.";
        }
        catch (Exception ex) { _errorMessage = $"Error: {ex.Message}"; }
        finally { _isSaving = false; StateHasChanged(); }
    }

    private void Cancel() => DialogService.Close(false);

    private void Notify(string title, string message, NotificationSeverity severity) =>
        NotificationService.Notify(new NotificationMessage
        {
            Severity = severity, Summary = title, Detail = message, Duration = 4000
        });
}
