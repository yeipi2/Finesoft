@page "/tickets"
@using fs_front.DTO
@using Microsoft.AspNetCore.Components.Authorization

@attribute [Authorize]

<PageTitle>Finesoft - Tickets</PageTitle>

@if (_checkingAccess)
{
    <div style="position:fixed;top:0;left:0;width:100vw;height:100vh;
        background:white;z-index:9999;
        display:flex;align-items:center;justify-content:center;">
        <div class="spinner-border text-primary" role="status"></div>
    </div>
}
else if (!_hasAccess)
{
    <div></div>
}
else
{
    <div class="p-4">
        <section class="container-fluid px-xl-5 py-4">
            <TicketsHeader CanCreate="@_canCreate"
                           CanViewAll="@_canViewAll"
                           CurrentRole="@_currentRole"
                           OnCreate="ShowCreateModal" />

            @if (_stats != null)
            {
                <StatGrid>
                    <StatCard Title="Abiertos"    Value="@_stats.Open.ToString()"       Accent="StatCard.StatAccent.Primary" IconClass="bi bi-inbox" />
                    <StatCard Title="En Progreso" Value="@_stats.InProgress.ToString()" Accent="StatCard.StatAccent.Info"    IconClass="bi bi-clock-history" />
                    <StatCard Title="En Revisión" Value="@_stats.InReview.ToString()"   Accent="StatCard.StatAccent.Info"    IconClass="bi bi-search" />
                    <StatCard Title="Cerrados"    Value="@_stats.Closed.ToString()"     Accent="StatCard.StatAccent.Success" IconClass="bi bi-check-circle" />
                </StatGrid>
            }
        </section>

        <section class="container-fluid px-xl-5 py-4">
            <TicketsFilterBar SearchValue="@_searchText"
                              StatusFilter="@_statusFilter"
                              PriorityFilter="@_priorityFilter"
                              SearchValueChanged="OnSearchChanged"
                              StatusFilterChanged="OnStatusChanged"
                              PriorityFilterChanged="OnPriorityChanged"
                              OnClear="ClearFilters" />
        </section>

        <section class="container-fluid px-xl-5 py-4">
            <TicketsTable Items="_filteredTickets"
                          IsLoading="_isLoading"
                          CanViewAll="@_canViewAll"
                          CurrentRole="@_currentRole"
                          SortField="@_sortField"
                          SortDir="@_sortDir"
                          SortChanged="OnSortChanged"
                          OnViewDetails="ViewTicketDetails" />
        </section>
    </div>
}

@inject ITicketApiService TicketApiService
@inject DialogService DialogService
@inject NotificationService NotificationService
@inject NavigationManager NavigationManager
@inject fs_front.Services.PermissionService PermissionService

@code {
    private List<TicketDetailDto>? _tickets;
    private TicketStatsDto? _stats;
    private string _searchText    = string.Empty;
    private string _statusFilter  = string.Empty;
    private string _priorityFilter = string.Empty;
    private bool _isLoading = false;

    private bool _checkingAccess = true;
    private bool _hasAccess      = false;
    private string? _currentUserId;
    private string? _currentRole;

    private bool _canViewAll = false;
    private bool _canCreate  = false;
    private bool _canEdit    = false;
    private bool _canDelete  = false;

    private string _sortField = "createdAt";
    private FsSortHeader.SortDirection _sortDir = FsSortHeader.SortDirection.Desc;

    // ── Filtrado + Ordenamiento ───────────────────────────────────────────────
    private IEnumerable<TicketDetailDto> _filteredTickets =>
        ApplySort(
            _tickets?.Where(t =>
                (string.IsNullOrWhiteSpace(_searchText) ||
                 t.Title.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
                 (t.Description?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false) ||
                 (t.ClientName?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false) ||
                 (t.ProjectName?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false))
                && (string.IsNullOrEmpty(_statusFilter)   || t.Status   == _statusFilter)
                && (string.IsNullOrEmpty(_priorityFilter) || t.Priority == _priorityFilter)
            ) ?? Enumerable.Empty<TicketDetailDto>()
        );

    private IEnumerable<TicketDetailDto> ApplySort(IEnumerable<TicketDetailDto> q) =>
        (_sortField, _sortDir) switch
        {
            ("id",        FsSortHeader.SortDirection.Asc)  => q.OrderBy(x => x.Id),
            ("id",        FsSortHeader.SortDirection.Desc) => q.OrderByDescending(x => x.Id),
            ("title",     FsSortHeader.SortDirection.Asc)  => q.OrderBy(x => x.Title),
            ("title",     FsSortHeader.SortDirection.Desc) => q.OrderByDescending(x => x.Title),
            ("priority",  FsSortHeader.SortDirection.Asc)  => q.OrderBy(x => PriorityRank(x.Priority)),
            ("priority",  FsSortHeader.SortDirection.Desc) => q.OrderByDescending(x => PriorityRank(x.Priority)),
            ("status",    FsSortHeader.SortDirection.Asc)  => q.OrderBy(x => x.Status),
            ("status",    FsSortHeader.SortDirection.Desc) => q.OrderByDescending(x => x.Status),
            ("createdAt", FsSortHeader.SortDirection.Asc)  => q.OrderBy(x => x.CreatedAt),
            ("createdAt", FsSortHeader.SortDirection.Desc) => q.OrderByDescending(x => x.CreatedAt),
            _                                              => q.OrderByDescending(x => x.CreatedAt),
        };

    private static int PriorityRank(string? p) => p switch
    {
        "Urgente" => 4, "Alta" => 3, "Media" => 2, "Baja" => 1, _ => 0
    };

    private void OnSortChanged((string field, FsSortHeader.SortDirection dir) s)
    {
        _sortField = s.field;
        _sortDir   = s.dir;
    }

    // ── Handlers de filtros (métodos nombrados para evitar CS1660) ────────────
    private void OnSearchChanged(string value)   => _searchText     = value;
    private void OnStatusChanged(string value)   => _statusFilter   = value;
    private void OnPriorityChanged(string value) => _priorityFilter = value;

    // ── Ciclo de vida ─────────────────────────────────────────────────────────
    protected override async Task OnInitializedAsync()
    {
        var canView = await PermissionService.HasPermissionAsync("tickets.view");
        if (!canView)
        {
            _checkingAccess = false;
            _hasAccess = false;
            NavigationManager.NavigateTo("/dashboard", forceLoad: true);
            return;
        }

        _hasAccess      = true;
        _checkingAccess = false;

        await LoadPermissions();
        await LoadData();
    }

    private async Task LoadPermissions()
    {
        _currentUserId = await PermissionService.GetUserIdAsync();
        _currentRole   = await PermissionService.GetRoleAsync();

        _canCreate  = await PermissionService.HasPermissionAsync("tickets.create");
        _canEdit    = await PermissionService.HasPermissionAsync("tickets.edit");
        _canDelete  = await PermissionService.HasPermissionAsync("tickets.delete");
        _canViewAll = _currentRole is "Admin" or "Administracion" or "Empleado" or "Supervisor";
    }

    // ── Carga de datos ────────────────────────────────────────────────────────
    private async Task LoadData()
    {
        _isLoading = true;
        try
        {
            var userId      = _currentRole == "Cliente" ? _currentUserId : null;
            var ticketsTask = TicketApiService.GetTicketsAsync(userId: userId);
            var statsTask   = TicketApiService.GetTicketStatsAsync(userId);

            await Task.WhenAll(ticketsTask, statsTask);
            _tickets = await ticketsTask;
            _stats   = await statsTask;
        }
        catch (Exception ex)
        {
            Notify("Error", $"Error al cargar datos: {ex.Message}", NotificationSeverity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    // ── Acciones ──────────────────────────────────────────────────────────────
    private async Task ShowCreateModal()
    {
        bool? result;

        if (_currentRole == "Cliente")
        {
            result = await DialogService.OpenAsync<TicketFormCliente>("Crear Ticket",
                options: new DialogOptions { Width = "600px", Resizable = false, Draggable = false });
        }
        else
        {
            result = await DialogService.OpenAsync<TicketForm>("Crear Ticket",
                options: new DialogOptions { Width = "800px", Resizable = false, Draggable = false });
        }

        if (result == true) await LoadData();
    }

    private void ViewTicketDetails(int ticketId) =>
        NavigationManager.NavigateTo($"/tickets/{ticketId}");

    private async Task ClearFilters()
    {
        _searchText     = string.Empty;
        _statusFilter   = string.Empty;
        _priorityFilter = string.Empty;
        await LoadData();
    }

    private void Notify(string title, string message, NotificationSeverity severity) =>
        NotificationService.Notify(new NotificationMessage
        {
            Severity = severity, Summary = title, Detail = message, Duration = 4000
        });
}
