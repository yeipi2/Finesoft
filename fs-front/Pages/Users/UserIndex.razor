@page "/usuarios"
@using fs_front.DTO

@* CAMBIO 1: Quitar Roles, solo Authorize *@
@attribute [Authorize]

<PageTitle>Finesoft - Usuarios</PageTitle>

@* CAMBIO 2: Spinner + guard *@
@if (_checkingAccess)
{
    <div style="position:fixed;top:0;left:0;width:100vw;height:100vh;
                    background:white;z-index:9999;
                    display:flex;align-items:center;justify-content:center;">
        <div class="spinner-border text-primary" role="status"></div>
    </div>
}
else if (_hasAccess)
{

    @* ↓↓↓ TODO EL HTML ORIGINAL SIN CAMBIAR NADA ↓↓↓ *@
    <div class="">
        <section class="container-fluid px-xl-5">
            <div class="d-flex justify-content-between align-items-start mb-4">
                <div class="d-flex align-items-center">
                    <i class="bi bi-people fs-1 text-primary me-3"></i>
                    <div>
                        <p class="display-6 fw-bolder mb-2">Usuarios Registrados</p>
                        <p class="text-muted mb-0">Administración de acceso y control de roles</p>
                    </div>
                </div>
                @* CAMBIO: botón condicionado a permiso *@
                @if (_canCreate)
                {
                    <button class="btn btn-primary d-flex align-items-center gap-2 fw-bold small" @onclick="ShowCreateModal">
                        <i class="bi bi-plus-lg"></i> Nuevo Usuario
                    </button>
                }
            </div>
            <SearchBar Placeholder="Buscar usuarios..."
           Value="@_searchTerm"
           ValueChanged="@(v => { _searchTerm = v; FilterUsers(); })"/>
        </section>

        <section class="container-fluid p-xl-5">
            @if (_isLoading)
            {
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2 text-muted">Cargando usuarios...</p>
                </div>
            }
            else
            {
                <FsDataTable TItem="UserDto"
                        Title="Usuarios"
                        Subtitle="Administración de acceso y control de roles"
                        Items="_sortedUsers"
                        IsLoading="_isLoading"
                        ColSpan="3"
                        EmptyTitle="No se encontraron usuarios"
                        EmptySubtitle="Prueba con otra búsqueda.">

                <Header>
                    <FsSortHeader Text="Usuario" Field="username" ActiveField="@_sortField" Direction="@_sortDir" SortChanged="OnSortChanged" />
                    <FsSortHeader Text="Rol" Field="role" ActiveField="@_sortField" Direction="@_sortDir" SortChanged="OnSortChanged" />
                    <th class="text-center">Acciones</th>
                </Header>

                <RowTemplate Context="user">
                    <tr>
                        <td>
                            <div class="fw-bold text-primary">@user.UserName</div>
                            <div class="text-muted small">@user.Email</div>
                        </td>

                        <td style="width:150px">
                            <span class="badge bg-info text-dark">@user.RoleName</span>
                        </td>

                        <td class="text-center" style="width:120px">
                            <div class="d-flex gap-2 justify-content-center">
                                @if (_canEdit)
                                {
                                    <button class="btn btn-sm btn-outline-primary"
                                            @onclick="() => EditUser(user)" @onclick:stopPropagation="true">
                                        <i class="bi bi-pencil-fill"></i>
                                    </button>
                                }
                                @if (_canDelete)
                                {
                                    <button class="btn btn-sm btn-outline-danger"
                                            @onclick="() => DeleteUser(user)" @onclick:stopPropagation="true">
                                        <i class="bi bi-trash-fill"></i>
                                    </button>
                                }
                            </div>
                        </td>
                    </tr>
                </RowTemplate>

            </FsDataTable>

            }
            @if (!string.IsNullOrEmpty(_loadErrorMessage))
            {
                <div class="alert alert-danger mt-3"><strong>Error:</strong> @_loadErrorMessage</div>
            }
        </section>
    </div>
}
@* ← cierre del else if (_hasAccess) *@

@inject IUserApiService UserApiService
@inject DialogService DialogService
@inject NotificationService NotificationService
@inject NavigationManager NavigationManager
@inject PermissionService PermissionService

@code {
    private List<UserDto>? _users;
    private IEnumerable<UserDto> _filteredUsers = Enumerable.Empty<UserDto>();
    private string? _loadErrorMessage;
    private bool _isLoading;
    private string _searchTerm = "";

    @* CAMBIO 3: Agregar estas variables *@
    private bool _checkingAccess = true;
    private bool _hasAccess = false;
    private bool _canCreate;
    private bool _canEdit;
    private bool _canDelete;

    private string _sortField = "username";

    private IEnumerable<UserDto> _sortedUsers => ApplySort(_filteredUsers);

private FsSortHeader.SortDirection _sortDir = FsSortHeader.SortDirection.Desc;

private void OnSortChanged((string field, FsSortHeader.SortDirection dir) s)
{
    _sortField = s.field;
    _sortDir = s.dir;
}


    protected override async Task OnInitializedAsync()
    {
        @* CAMBIO 3: Verificar permiso PRIMERO *@
        if (!await PermissionService.HasPermissionAsync("users.view"))
        {
            _checkingAccess = false;
            NavigationManager.NavigateTo("/dashboard", forceLoad: true);
            return;
        }
        _hasAccess = true;
        _checkingAccess = false;

        _canCreate = await PermissionService.HasPermissionAsync("users.create");
        _canEdit = await PermissionService.HasPermissionAsync("users.edit");
        _canDelete = await PermissionService.HasPermissionAsync("users.delete");

        await LoadUsers();
    }

    @* Todo lo demás igual que antes — sin cambiar nada *@
    private async Task LoadUsers()
    {
        _isLoading = true;
        _loadErrorMessage = null;
        try
        {
            _users = await UserApiService.GetUsersAsync();
            if (_users == null) { _loadErrorMessage = "No se pudo obtener la lista de usuarios."; _filteredUsers = Enumerable.Empty<UserDto>(); }
            else FilterUsers();
        }
        catch (Exception ex)
        {
            _loadErrorMessage = $"Error inesperado: {ex.Message}";
            _users = new();
            _filteredUsers = Enumerable.Empty<UserDto>();
            ShowNotification("Error", ex.Message, NotificationSeverity.Error);
        }
        finally { _isLoading = false; }
    }

    private void FilterUsers()
    {
        if (_users == null) return;
        _filteredUsers = string.IsNullOrWhiteSpace(_searchTerm) ? _users
            : _users.Where(u => u.UserName.ToLower().Contains(_searchTerm.ToLower()) ||
                                u.Email.ToLower().Contains(_searchTerm.ToLower()) ||
                                u.RoleName.ToLower().Contains(_searchTerm.ToLower()));
    }

    private async Task ShowCreateModal()
    {
        var result = await DialogService.OpenAsync<UserForm>("Crear Usuario", options: new DialogOptions { Width = "500px", Resizable = false, Draggable = false });
        if (result == true) await LoadUsers();
    }

    private async Task EditUser(UserDto user)
    {
        var parameters = new Dictionary<string, object> { { "UserId", user.Id } };
        var result = await DialogService.OpenAsync<UserForm>("Editar Usuario", parameters, options: new DialogOptions { Width = "500px", Resizable = false, Draggable = false });
        if (result == true) await LoadUsers();
    }

    private async Task DeleteUser(UserDto user)
    {
        var confirmed = await DialogService.Confirm($"¿Estás seguro de que deseas eliminar al usuario '{user.UserName}'?", "Confirmar Eliminación", new ConfirmOptions { OkButtonText = "Sí, eliminar", CancelButtonText = "Cancelar" });
        if (confirmed == true)
        {
            try
            {
                var result = await UserApiService.DeleteUserAsync(user.Id);
                if (result.Success) { ShowNotification("Éxito", "Usuario eliminado correctamente.", NotificationSeverity.Success); await LoadUsers(); }
                else { _loadErrorMessage = result.ErrorMessage; ShowNotification("Error", result.ErrorMessage ?? "Error al eliminar usuario", NotificationSeverity.Error); }
            }
            catch (Exception ex) { ShowNotification("Error", $"Error inesperado: {ex.Message}", NotificationSeverity.Error); }
        }
    }

    private IEnumerable<UserDto> ApplySort(IEnumerable<UserDto> q)
{
    return (_sortField, _sortDir) switch
    {
        ("username", FsSortHeader.SortDirection.Asc) => q.OrderBy(x => x.UserName),
        ("username", FsSortHeader.SortDirection.Desc) => q.OrderByDescending(x => x.UserName),

        ("role", FsSortHeader.SortDirection.Asc) => q.OrderBy(x => x.RoleName),
        ("role", FsSortHeader.SortDirection.Desc) => q.OrderByDescending(x => x.RoleName),

        _ => q.OrderByDescending(x => x.UserName),
    };
}


    private void ShowNotification(string title, string message, NotificationSeverity severity) =>
        NotificationService.Notify(new NotificationMessage { Severity = severity, Summary = title, Detail = message, Duration = severity == NotificationSeverity.Error ? 6000 : 4000, ShowProgress = true });
}
