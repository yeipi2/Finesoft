@using System.Security.Claims
@* Servicios para navegación y estado de autenticación *@
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthProvider

@code {
    // Evita ejecutar más de una vez el redirect
    private bool _checked = false;

    // Se ejecuta después del primer render para poder navegar
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _checked) return;
        _checked = true;

        var state = await AuthProvider.GetAuthenticationStateAsync();
        var user = state.User;

        // No autenticado -> login
        if (user.Identity?.IsAuthenticated != true)
        {
            Nav.NavigateTo("/iniciar-sesion", true);
            return;
        }

        // Leer rol
        var role = user.FindFirst(ClaimTypes.Role)?.Value;

        // Sin rol o Technician -> pending
        if (string.IsNullOrWhiteSpace(role) || role == "Technician")
        {
            Nav.NavigateTo("/pending", true);
            return;
        }

        // Admin / User -> dashboard
        Nav.NavigateTo("/dashboard", true);
    }
}
